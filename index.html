<!DOCTYPE html> 
<!-- index.html -->
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">

<div class="app-shell">
  <!-- SIDEBAR IZQUIERDA -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">IN</div>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-title">Inpages Builder</span>
        <span class="sidebar-logo-subtitle">Herramienta interna</span>
      </div>
    </div>

  <nav class="sidebar-nav">
    <button type="button" class="sidebar-nav-item">
      <span class="sidebar-nav-icon">
        <span class="material-symbols-outlined">dashboard</span>
      </span>
      <span class="sidebar-nav-label">Dashboard</span>
    </button>

    <button type="button" class="sidebar-nav-item sidebar-nav-item--active">
      <span class="sidebar-nav-icon">
        <!-- como el "Content Blocks" del ejemplo -->
        <span class="material-symbols-outlined">view_carousel</span>
      </span>
      <span class="sidebar-nav-label">Constructor</span>
    </button>
    <button type="button"
            class="sidebar-nav-item"
            onclick="window.open('text-tools.html', '_blank')">
      <span class="sidebar-nav-icon">
        <span class="material-symbols-outlined">text_fields</span>
      </span>
      <span class="sidebar-nav-label">Texto masivo</span>
    </button>
    <button type="button" class="sidebar-nav-item">
      <span class="sidebar-nav-icon">
        <span class="material-symbols-outlined">layers</span>
      </span>
      <span class="sidebar-nav-label">Bloques</span>
    </button>

    <button type="button" class="sidebar-nav-item">
      <span class="sidebar-nav-icon">
        <span class="material-symbols-outlined">perm_media</span>
      </span>
      <span class="sidebar-nav-label">Asset Library</span>
    </button>

    <button type="button" class="sidebar-nav-item">
      <span class="sidebar-nav-icon">
        <span class="material-symbols-outlined">settings</span>
      </span>
      <span class="sidebar-nav-label">Settings</span>
    </button>
  </nav>



    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="sidebar-user-avatar">DF</div>
        <div class="sidebar-user-meta">
          <span class="sidebar-user-name">Admin Name</span>
          <span class="sidebar-user-role">Content Manager</span>
        </div>
      </div>

    <button type="button" class="sidebar-logout">
      <span class="sidebar-logout-icon">
        <span class="material-symbols-outlined">logout</span>
      </span>
      <span class="sidebar-logout-label">Salir</span>
    </button>

    </div>
  </aside>

  <!-- CONTENIDO ACTUAL DE LA APP -->
  <div class="app-main">
    <header class="app-header">
      <div>
        <h1 class="app-title">Constructor de Inpages</h1>
        <p class="app-subtitle">
          Arma bloques, y obten el c√≥digo final
        </p>
      </div>
    </header>

    <section class="app-content">
      <!-- Columna izquierda: bloques -->
      <div class="app-column app-column--left">
        <section class="card">
<header class="card-header card-header--with-actions">
  <div>
    <h2 class="card-title">Bloques y datos</h2>
    <p class="card-subtitle">
      Configura los m√≥dulos y mapea columnas del Excel.
    </p>
  </div>
</header>

<!-- üîπ Barra principal: Bloques + Excel -->
<div class="card-toolbar card-toolbar--split">
  <!-- Grupo Bloques -->
  <div class="card-toolbar-group">
    <span class="card-toolbar-label">Bloques</span>

    <button type="button"
            class="btn btn-outline btn-sm toolbar-btn toolbar-btn--secondary"
            onclick="addMod()">
      <span class="material-symbols-outlined toolbar-btn__icon">add_circle</span>
      Agregar
    </button>

    <button type="button"
            class="btn btn-outline btn-sm toolbar-btn toolbar-btn--secondary"
            onclick="collapseAll()">
      <span class="material-symbols-outlined toolbar-btn__icon">unfold_less</span>
      Contraer
    </button>

  </div>

  <!-- Grupo Excel -->
  <div class="card-toolbar-group">
    <span class="card-toolbar-label">Excel</span>

    <!-- Cargar Excel -->
    <button type="button"
            class="btn btn-outline btn-sm toolbar-btn toolbar-btn--secondary toolbar-btn--excel"
            onclick="document.getElementById('global-excel-upload').click()">
      <span class="material-symbols-outlined toolbar-btn__icon">upload</span>
      Cargar
    </button>
    <input type="file"
           id="global-excel-upload"
           accept=".xlsx,.xls"
           style="display:none;"
           onchange="handleGlobalExcelUpload(event)">

    <!-- Descargar Excel -->
    <button type="button"
            id="download-excel-btn"
            class="btn btn-outline btn-sm toolbar-btn toolbar-btn--secondary toolbar-btn--excel"
            onclick="downloadExcel()">
      <span class="material-symbols-outlined toolbar-btn__icon">download</span>
      Descargar
    </button>

    <!-- Fila a visualizar -->
    <div id="excel-row-selector-container"
         class="toolbar-item toolbar-item--hidden">
      <span class="toolbar-label">Fila</span>
      <select id="excel-row-selector"
              class="select select-sm"
              onchange="handleRowChange()"></select>
    </div>

    <!-- Exportar fila actual -->
    <button type="button"
            class="btn btn-outline btn-sm toolbar-item toolbar-item--hidden"
            onclick="downloadSingleExcel()">
      Exportar fila
    </button>
  </div>
</div>

<!-- Lista de bloques -->
<div id="mods"></div>

        </section>
      </div>


      <!-- Columna derecha: vista + c√≥digo unidos -->
      <aside class="app-column app-column--right">
        <section class="card">
          <header class="card-header card-header--compact">
            <div>
              <h3 class="card-title">Vista previa</h3>
              <p class="card-subtitle">
                Dise√±o final aproximado y detalles de c√≥digo
              </p>
            </div>

          <div class="card-actions">
            <button type="button"
                    class="btn btn-success btn-sm"
                    onclick="renderAll()">
              Refrescar
            </button>
            <button type="button"
                    id="preview-toggle-btn"
                    class="btn btn-outline btn-sm"
                    onclick="togglePreviewMode()">
              &lt;/&gt; C√≥digo
            </button>
          </div>
        </header>

          <!-- Vista previa normal -->
          <div id="preview" class="preview-box">
            <span class="preview-empty">No hay m√≥dulos v√°lidos.</span>

          </div>

          <!-- C√≥digo del inpage (mismo contenido que antes) -->
          <div id="export-panel" class="export-panel export-panel--hidden">
            <div class="export-section">
              <div class="export-header">
                <span class="export-title">HTML final (snippet listo para pegar)</span>
                <button type="button"
                        class="btn btn-ghost btn-sm"
                        onclick="copyHtmlFinal()">
                  Copiar
                </button>
              </div>
              <textarea id="htmlFullOut"
                        rows="6"
                        readonly
                        class="code-textarea"></textarea>
            </div>

            <div class="export-section">
              <span class="export-title">HTML (solo wrapper)</span>
              <textarea id="htmlOut"
                        rows="5"
                        readonly
                        class="code-textarea"></textarea>
            </div>

            <div class="export-section">
              <span class="export-title">CSS (m√≥dulos inpgs)</span>
              <textarea id="cssOut"
                        rows="6"
                        readonly
                        class="code-textarea"></textarea>
            </div>

            <div class="export-section">
              <span class="export-title">JS (si lo hubiera)</span>
              <textarea id="jsOut"
                        rows="3"
                        readonly
                        class="code-textarea"></textarea>
            </div>
          </div>
        </section>
      </aside>

    </section>
  </div><!-- /.app-main -->
</div><!-- /.app-shell -->


<style>
  .material-symbols-outlined {
    font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24;
  }

  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f4f4;
  }

  .mod-box {
    background: #f8fafc;
    border: 1.5px solid #bfc9d9;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(60,72,100,0.05);
    margin: 18px 0;
    padding: 0 0 10px 0;
  }
  .mod-box.collapsed {
    background: #f1f3f7;
    border-color: #d1d5db;
  }
  .mod-header {
    background: #f4f6fa;
    color: #23272f;
    border-radius: 12px;
    border: 1.5px solid #bfc9d9;
    box-shadow: 0 1px 4px rgba(60,72,100,0.04);
    padding: 5px 20px 8px 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .mod-header .mod-badge {
    color: #23272f;
    font-size: 14px;
    font-weight: 700;
  }
  .mod-header .mod-pos {
    color: #7a869a;
    font-size: 11px;
  }
  .mod-header-actions .icon-button {
    color: #7a869a;
    background: #f3f6fa;
    border: 1px solid #e5e7eb;
    margin-left: 2px;
    transition: background 0.12s, color 0.12s;
  }
  .mod-header-actions .icon-button:hover {
    background: #e6eaf2;
    color: #23272f;
  }
  .mod-header .material-symbols-outlined,
  .mod-header .mod-type-pill-icon,
  .mod-header .icon-button-symbol {
    font-size: 20px !important;
    min-width: 20px;
    min-height: 20px;
    color: #7a869a;
    vertical-align: middle;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .mod-type-pill {
    background: #e6eaf2;
    border: 1.5px solid #bfc9d9;
    color: #23272f;
    font-weight: 600;
    padding: 4px 18px;
    border-radius: 9999px;
    font-size: 13px;
    box-shadow: 0 1px 2px rgba(60,72,100,0.04);
  }
  .mod-type-pill:hover {
    background: #e6eaf2;
    border-color: #bfc9d9;
  }
  .mod-section {
    background: #fff;
    border: 1.5px solid #e5e7eb;
    border-radius: 10px;
    margin: 18px 18px 0 18px;
    box-shadow: 0 1px 2px rgba(60,72,100,0.03);
    overflow: hidden;
  }
  .mod-section-header {
    background: #e6eaf2;
    color: #23272f;
    border-bottom: 1.5px solid #bfc9d9;
    font-weight: 700;
    padding: 10px 18px;
    border-radius: 10px 10px 0 0;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  .mod-section.mod-section--collapsed .mod-section-header {
    background: #e6eaf2;
    color: #7a869a;
  }
  .mod-section-body {
    background: #fff;
    padding: 14px 20px 16px 20px;
  }
  .text-item-block, .img-item-block {
    background: #fff;
    border: 1.5px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 12px;
    box-shadow: 0 1px 2px rgba(60,72,100,0.03);
  }
  .text-item-header, .img-item-header {
    background: #f3f6fa;
    color: #23272f;
    border-bottom: 1.5px solid #e5e7eb;
    font-weight: 600;
    padding: 8px 14px;
    border-radius: 8px 8px 0 0;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .param-item label {
    color: #3b4a62;
    font-weight: 700;
  }
  .param-item select,
  .param-item input[type="text"],
  .param-item input[type="number"] {
    background: #f3f6fa;
    border: 1.5px solid #bfc9d9;
    color: #2d3a4b;
    font-weight: 600;
  }
  .param-item select:focus,
  .param-item input[type="text"]:focus,
  .param-item input[type="number"]:focus {
    border-color: #4f46e5;
    outline: none;
    background: #e6eaf2;
  }
  .checks label {
    color: #2d3a4b;
    font-weight: 600;
  }
  .muted {
    color: #7a869a;
  }

  select,
  input[type="text"],
  input[type="number"],
  textarea {
    width: 100%;
    padding: 6px;
    margin: 4px 0 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 13px;
  }

  label {
    font-size: 12px;
    color: #444;
    font-weight: 600;
    display: block;
    margin-bottom: 2px;
  }

  .row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .checks {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 12px;
    margin-top: 8px;
  }

  .checks label {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: normal;
    cursor: pointer;
  }

  .mod-body {
    margin-top: 6px;
  }

  .params-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
    margin-bottom: 8px;
  }

  .param-item {
    display: flex;
    flex-direction: column;
  }

  .param-item label {
    margin-bottom: 2px;
    font-size: 11px;
    color: #555;
  }

  .param-item select,
  .param-item input[type="text"],
  .param-item input[type="number"] {
    margin: 0;
    width: auto;
    max-width: 100px;
    padding: 4px;
    font-size: 12px;
  }

  input[type="color"].mini-color {
    width: 24px;
    height: 24px;
    padding: 0;
    border: 1px solid #ccc;
    background: none;
    cursor: pointer;
    border-radius: 4px;
    overflow: hidden;
    vertical-align: bottom;
  }

  input[type="color"].mini-color::-webkit-color-swatch-wrapper {
    padding: 0;
  }

  input[type="color"].mini-color::-webkit-color-swatch {
    border: none;
    border-radius: 3px;
  }

  .text-toolbar-lineheight {
    max-width: 64px;
  }

  .text-toolbar-select:focus,
  .text-toolbar-button:focus {
    outline: 1px solid #2563eb;
    outline-offset: 1px;
  }

  .text-toolbar-color {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
    border: 0;
    padding: 0;
    margin: 0;
    pointer-events: none;
  }

  .text-color-picker {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .text-color-btn {
    padding: 2px 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .text-color-picker-icon {
    width: 14px;
    height: 14px;
    display: block;
  }

  .text-color-picker-bar {
    width: 14px;
    height: 3px;
    border-radius: 2px;
    background: #333333;
  }

  .icon-align {
    width: 16px;
    height: 12px;
    position: relative;
    display: inline-block;
  }

  .icon-align-left::before {
    top: 0;
    left: 0;
    width: 16px;
  }

  .icon-align-left::after {
    top: 5px;
    left: 0;
    width: 12px;
  }

  .icon-align-left span {
    top: 10px;
    left: 0;
    width: 8px;
  }

  .icon-align-center::before {
    top: 0;
    left: 50%;
    width: 16px;
    transform: translateX(-50%);
  }

  .icon-align-center::after {
    top: 5px;
    left: 50%;
    width: 12px;
    transform: translateX(-50%);
  }

  .icon-align-center span {
    top: 10px;
    left: 50%;
    width: 16px;
    transform: translateX(-50%);
  }

  .icon-align-right::before {
    top: 0;
    right: 0;
    width: 16px;
  }

  .icon-align-right::after {
    top: 5px;
    right: 0;
    width: 12px;
  }

  .icon-align-right span {
    top: 10px;
    right: 0;
    width: 8px;
  }

  .icon-align-justify::before {
    top: 0;
    left: 0;
    right: 0;
  }

  .icon-align-justify::after {
    top: 5px;
    left: 0;
    right: 0;
  }

  .icon-align-justify span {
    top: 10px;
    left: 0;
    right: 0;
  }

  .rich-textarea {
    min-height: 40px;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 6px;
    font-size: 22px;
    background: #fff;
    overflow-y: auto;
    color: #333333;
    font-weight: 400;
  }

  .rich-textarea a,
  .rich-textarea a:link,
  .rich-textarea a:visited {
    color: inherit;
    text-decoration: underline;
  }

  .rich-textarea.excel-bound {
    background: #f3f4f6;
    cursor: default;
  }

  .text-toolbar-inline.excel-bound-toolbar {
    opacity: 0.4;
    pointer-events: none;
  }

  .rich-textarea.empty::before {
    content: "Ingresa el texto...";
    color: #9ca3af;
  }

  .icon-paint-bucket {
    position: relative;
    width: 16px;
    height: 16px;
    display: inline-block;
  }

  .text-toolbar-inline {
    display: flex;
    align-items: center;
    gap: 4px;
    margin: 4px 0;
    font-size: 12px;
    background: #f9fafb;
    border-radius: 4px;
    padding: 4px 6px;
    border: 1px solid #e5e7eb;
  }

  .text-toolbar-button {
    border: 1px solid transparent;
    border-radius: 3px;
    padding: 2px 4px;
    background: transparent;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
    color: #374151;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .text-toolbar-button:hover {
    background: #e5e7eb;
  }

  .text-toolbar-button.active {
    background: #d1d5db;
    border-color: #9ca3af;
    color: #111827;
  }

  .text-toolbar-select,
  .text-toolbar-lineheight {
    border-radius: 4px;
    padding: 0 4px;
    height: 22px;
    font-size: 11px;
    background: #ffffff;
    color: #111827;
    border: 1px solid #d1d5db;
  }

  .text-toolbar-select {
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 0 4px;
    height: 22px;
    font-size: 11px;
    background: #f9fafb;
    max-width: 80px;
  }

  /* Separador visual */
  .text-toolbar-separator {
    color: #9ca3af;
    padding: 0 2px;
  }

  .icon-align::before,
  .icon-align::after,
  .icon-align span {
    content: "";
    position: absolute;
    height: 2px;
    border-radius: 1px;
    background: #4b5563;
  }

  .icon-list {
    width: 18px;
    height: 16px;
    position: relative;
    display: inline-block;
  }

  .icon-list-bullets::before,
  .icon-list-bullets::after {
    content: "";
    position: absolute;
    border-radius: 9999px;
  }

  .icon-list-bullets::before {
    left: 2px;
    top: 2px;
    width: 4px;
    height: 4px;
    background: #343E49;
    box-shadow:
      0 5px 0 #343E49,
      0 10px 0 #343E49;
  }

  .icon-list-bullets::after {
    left: 9px;
    right: 1px;
    top: 3px;
    height: 2px;
    border-radius: 1px;
    background: #343E49;
    box-shadow:
      0 5px 0 #343E49,
      0 10px 0 #343E49;
  }

  .icon-ordered-list {
    display: inline-flex;
    flex-direction: column;
    justify-content: space-between;
    width: 14px;
    height: 10px;
    font-size: 0;
  }

  .icon-ordered-list-item {
    display: flex;
    align-items: center;
    flex: 1 0 0;
  }

  .icon-ordered-list-num {
    font-size: 6px;
    font-weight: 700;
    color: #343E49;
    margin-right: 1px;
    line-height: 1;
    width: 4px;
    text-align: right;
  }

  .icon-ordered-list-line {
    flex-grow: 1;
    height: 1px;
    background-color: #343E49;
    border-radius: 1px;
  }

  .icon-paint-bucket::before {
    border: 2px solid #000000;
  }

  .icon-paint-bucket::after {
    background: #2563eb;
  }

  .icon-paint-bucket::before,
  .icon-paint-bucket::after {
    content: "";
    position: absolute;
  }

  .icon-paint-bucket::before {
    width: 10px;
    height: 8px;
    left: 3px;
    top: 3px;
    border: 2px solid #000;
    border-bottom-left-radius: 2px;
    border-bottom-right-radius: 2px;
  }

  .icon-paint-bucket::after {
    width: 4px;
    height: 6px;
    left: 10px;
    top: 10px;
    border-radius: 9999px;
    background: #2563eb;
  }

  .toolbar-icon-img {
    width: 16px;
    height: 16px;
    display: block;
    object-fit: contain;
    pointer-events: none;
    transform: scale(1.2);
  }

  .img-field-row label {
    width: 70px;
    font-size: 11px;
    color: #444;
    display: block;
    margin-bottom: 0;
  }

  .img-field-row input[type="text"] {
    flex: 1;
    padding: 4px 6px;
    font-size: 11px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin: 0;
  }

  .source-compact-img select {
    padding: 2px 4px;
    font-size: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    margin: 0;
    max-width: 120px;
  }

  .data-field-row {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
  }

  .data-field-row>label {
    width: 70px;
    font-size: 11px;
    color: #444;
    margin-bottom: 0;
    flex-shrink: 0;
  }

  .data-field-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .data-field-main input[type="text"],
  .data-field-main textarea {
    width: 100%;
    padding: 4px 6px;
    font-size: 11px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin: 0;
    box-sizing: border-box;
  }

  .source-compact {
    display: inline-flex;
    align-items: center;
  }

  .source-compact select {
    padding: 2px 4px;
    font-size: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    margin: 0;
    max-width: 120px;
  }

  .img-item-block {
    padding: 8px;
    background: #f9fafb;
    border-radius: 6px;
  }

  .text-item-block {
    margin-bottom: 8px;
    padding: 0;
    background: #ffffff;
    border-radius: 8px;
    border: 1.5px solid #d1d5db;
    box-shadow: 0 1px 2px rgba(60, 72, 100, 0.04);
  }

  .text-item-header {
    width: 100%;
    padding: 8px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    background: #e6eaf2;
    border: 0;
    border-bottom: 1.5px solid #d1d5db;
    cursor: pointer;
    font-weight: 600;
    border-radius: 8px 8px 0 0;
  }

  .text-item-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .text-item-drag {
    font-size: 14px;
    color: #2d3a4b;
  }

  .text-item-title {
    font-size: 12px;
    font-weight: 700;
    color: #2d3a4b;
  }

  .text-item-body {
    padding: 12px 16px 14px 16px;
  }

  .text-item-block.text-item--collapsed .text-item-body {
    display: none;
  }

  .mod-box.dragging {
    opacity: 0.5;
  }

  .app-shell {
    display: flex;
    min-height: 100vh;
    background: #f3f4f6;

  }

  /* Sidebar izquierda */
  .sidebar {
    width: 240px;
    flex-shrink: 0;
    background: #ffffff;
    color: #111827;
    display: flex;
    flex-direction: column;
    padding: 20px 16px;
    gap: 16px;
    border-right: 1px solid #e5e7eb;

  }

  /* Logo / t√≠tulo app */
  .sidebar-logo {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 4px;
  }

  .sidebar-logo-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: #4f46e5;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: #ffffff;
  }

  .sidebar-logo-title {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #111827;
  }

  .sidebar-logo-subtitle {
    display: block;
    font-size: 11px;
    color: #6b7280;
  }

  /* Navegaci√≥n */
  .sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
  }

  .sidebar-nav-item {
    width: 100%;
    border: 0;
    background: transparent;
    border-radius: 8px;
    padding: 8px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #4B5563;
    text-align: left;
    cursor: pointer;
  }

  .sidebar-nav-item--active .material-symbols-outlined {
    font-variation-settings:
      'FILL' 1,
      'wght' 500,
      'GRAD' 0,
      'opsz' 24;
  }

  .sidebar-logout-icon .material-symbols-outlined {
    font-size: 18px;
  }

  .sidebar-nav-item:hover {
    background: rgba(0, 123, 255, 0.06);
    /* similar al primary/10 del ejemplo */
  }

  .sidebar-nav-item--active {
    background: rgba(0, 123, 255, 0.08);
    color: #007BFF;
  }

  .sidebar-nav-icon svg {
    width: 16px;
    height: 16px;
    stroke: currentColor;
  }

  .sidebar-nav-icon {
    width: 22px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .sidebar-nav-icon .material-symbols-outlined {
    font-size: 20px;
  }

  .sidebar-nav-label {
    flex: 1;
  }

  /* Footer: usuario + logout */
  .sidebar-footer {
    margin-top: auto;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .sidebar-user {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sidebar-user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 9999px;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    color: #111827;
  }

  .sidebar-user-meta {
    display: flex;
    flex-direction: column;
  }

  .sidebar-user-name {
    font-size: 13px;
    font-weight: 500;
    color: #111827;
  }

  .sidebar-user-role {
    font-size: 11px;
    color: #6b7280;
  }

  .sidebar-logout {
    margin-top: 4px;
    border: 0;
    background: transparent;
    padding: 6px 4px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #6b7280;
    cursor: pointer;
  }

  .sidebar-logout:hover {
    color: #111827;
  }

  /* El √°rea principal se adapta al lado de la barra */
  .app-main {
    flex: 1;
  }

  /* Que el √°rea principal se adapte al lado de la barra */
  .app-main {
    flex: 1;
  }

  body {
    margin: 0;
    background: #f3f4f6;
    color: #111827;
  }

  .app-main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 24px 40px;
  }

  .app-header {
    margin-bottom: 24px;
  }

  .app-title {
    margin: 0 0 4px;
    font-size: 24px;
    font-weight: 700;
  }

  .app-subtitle {
    margin: 0;
    font-size: 14px;
    color: #6b7280;
  }

  .app-content {
    display: grid;
    grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
    gap: 16px;
    align-items: flex-start;
  }

  .app-column {
    min-width: 0;
  }

  .app-column--right {
    position: sticky;
    top: 16px;
  }

  /* === Cards / contenedores === */
  .card {
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 2px rgba(15, 23, 42, .04);
    padding: 16px 16px 12px;
  }

  .card-header, .card-header--with-actions, .card-header--compact {
    padding: 10px 18px 8px 18px;
    border-radius: 12px;
    background: #fff;
    border: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .card-title {
    margin: 0 0 2px;
    font-size: 16px;
    font-weight: 600;
    color: #23272f;
  }

  .card-subtitle {
    margin: 0;
    font-size: 13px;
    color: #6b7280;
  }

  .card-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .card-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 12px;
  }
.card-toolbar--split {
  justify-content: space-between;
  align-items: center;
  padding: 8px 18px 4px 18px;
  border-bottom: 1px solid #e5e7eb;
  margin-bottom: 12px;
}

.card-toolbar-group {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.card-toolbar-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: #9ca3af;
  margin-right: 4px;
}

.toolbar-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border-radius: 6px;
  padding: 5px 10px;
  font-weight: 600;
  line-height: 1;
  height: 32px;
  box-shadow: none;
}

.toolbar-btn__icon {
  font-size: 16px !important;
  line-height: 1;
}

.toolbar-btn--excel {
  min-width: auto;
  justify-content: center;
}

.toolbar-btn--primary {
  background: #2563eb;
  border-color: #1d4ed8;
  color: #fff;
}

.toolbar-btn--secondary {
  background: #ffffff;
  border-color: #cbd5e1;
  color: #0f172a;
}

.toolbar-btn--ghost {
  background: transparent;
  border-color: #d1d5db;
  color: #374151;
}

.toolbar-btn:hover {
  filter: none;
  background: rgba(37, 99, 235, 0.06);
}

  .card-footer {
    margin-top: 8px;
  }

  .card-footer-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* === Botones reutilizables === */
  .btn {
    border-radius: 8px;
    border: 1px solid transparent;
    padding: 6px 12px;
    font-size: 13px;
    line-height: 1.2;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #ffffff;
    color: #111827;
  }

  .btn-sm {
    padding: 4px 8px;
    font-size: 12px;
  }

  .btn-with-icon .btn-icon {
    width: 14px;
    height: 14px;
  }

  .btn-primary {
    background: #e5e7eb;
    border-color: #e5e7eb;
    color: #23272f;
  }

  .btn-primary:hover {
    background: #d1d5db;
    border-color: #d1d5db;
    color: #23272f;
  }

  .btn-success {
    background: #10b981;
    border-color: #10b981;
    color: #ffffff;
  }

  .btn-outline {
    background: #ffffff;
    border-color: #d1d5db;
    color: #111827;
  }

  .btn-ghost {
    background: transparent;
    border-color: transparent;
    color: #4b5563;
  }

  .btn:hover {
    filter: brightness(0.97);
  }

  /* === Toolbar Excel === */
  .toolbar-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .toolbar-item--hidden {
    display: none;
  }

  .toolbar-label {
    font-size: 12px;
    color: #6b7280;
  }

  .select {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1.5px solid #bfc9d9;
    font-size: 12px;
    box-sizing: border-box;
    background: #f3f6fa;
    color: #2d3a4b;
    font-weight: 600;
  }

  .select-sm {
    padding: 4px 6px;
    font-size: 12px;
  }

  /* === Vista previa y panel de c√≥digo === */
  .preview-box {
    border-radius: 8px;
    border: 1px dashed #d1d5db;
    padding: 10px;
    min-height: 120px;
    background: #ffffff;
    position: relative;
  }

  .preview-empty {
    font-size: 13px;
    color: #9ca3af;
  }

  .export-panel--hidden {
    display: none;
  }

  .export-section {
    margin-top: 10px;
  }

  .export-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }

  .export-title {
    font-size: 12px;
    font-weight: 500;
    color: #374151;
  }

  .code-textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 6px 8px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    resize: vertical;
  }

  .mod-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    cursor: pointer;
    border: 2px solid #e5e7eb;
    padding-bottom: 4px;
  }

  /* Zona central del header del bloque: nombre de m√≥dulo */
  .mod-header-type {
    flex: 1;
    display: flex;
    justify-content: center;
  }

  .mod-type-pill {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 2px 10px;
    border-radius: 9999px;
    background: #e6eaf2;
    border: 1.5px solid #bfc9d9;
    font-size: 11px;
    font-weight: 600;
    color: #2d3a4b;
    cursor: pointer;
    transition: background 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
  }

  .mod-type-pill:hover {
    background: #dbe3f2;
    border-color: #8fa3c7;
    box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
  }

  .mod-type-pill-icon {
    font-size: 16px;
    color: #6B7280;
  }

  .mod-type-pill-text {
    white-space: nowrap;
  }

  .mod-type-pill-caret {
    font-size: 16px;
    color: #9CA3AF;
  }

  .mod-type-select-native {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .mod-type-select:focus {
    border-color: #007BFF;
    box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.25);
  }

  .mod-type-select {
    min-width: 140px;
    padding: 2px 10px;
    border-radius: 9999px;
    border: 1px solid #E5E7EB;
    background: #F9FAFB;
    font-size: 11px;
    font-weight: 500;
    color: #374151;
    outline: none;
    cursor: pointer;
  }

  .mod-type-label {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 2px 10px;
    border-radius: 9999px;
    background: #E5E7EB;
    font-size: 11px;
    font-weight: 500;
    color: #374151;
    text-transform: none;
  }

  .mod-box {
    background: #f7f9fc;
    border-radius: 10px;
    border: 1.5px solid #bfc9d9;
    padding: 10px 12px;
    margin: 10px 0;
    box-shadow: 0 2px 8px rgba(60, 72, 100, 0.08);
  }

  .mod-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .mod-drag-handle {
    font-size: 16px;
    color: #9ca3af;
    cursor: grab;
  }

  .mod-header-text {
    display: flex;
    flex-direction: column;
  }

  .mod-badge {
    font-size: 13px;
    font-weight: 600;
    color: #111827;
  }

  .mod-pos {
    font-size: 11px;
    color: #9ca3af;
  }

  .mod-header-actions {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .icon-button {
    border-radius: 6px;
    border: 1px solid transparent;
    background: #22304a;
    font-size: 11px;
    padding: 2px 6px;
    cursor: pointer;
    color: #bfc9d9;
    transition: background 0.12s, color 0.12s;
  }

  .icon-button.mod-toggle {
    font-size: 18px;
    line-height: 1;
    background: none;
    border: none;
    box-shadow: none;
    padding: 2px 6px;
    color: inherit;
  }

  .icon-button:hover {
    background: #3b4a62;
    color: #fff;
  }

  .mod-toggle {
    transition: transform 0.15s ease;
  }

  .mod-body {
    margin-top: 10px;
  }

  .mod-box.collapsed .mod-body {
    display: none;
  }

  /* Drag visual */
  .mod-box.dragging {
    opacity: 0.5;
  }

  /* === Secciones internas de cada bloque === */
  .mod-section {
    border-radius: 8px;
    border: 1.5px solid #e5e7eb;
    background: #ffffff;
    /* ‚¨ÖÔ∏è antes era #f9fafb */
    margin-bottom: 8px;
    overflow: hidden;
  }

  .mod-section-header {
    width: 100%;
    padding: 10px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f3f6fa;
    border: 0;
    cursor: pointer;
    font-size: 12px;
    font-weight: 700;
    color: #2d3a4b;
    border-bottom: 1.5px solid #e5e7eb;
    border-radius: 10px 10px 0 0;
  }

  .mod-section-title {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .mod-section-body {
    padding: 14px 18px 16px 18px;
  }

  .mod-section.mod-section--collapsed .mod-section-body {
    display: none;
  }

  /* === Items de imagen tipo ‚ÄúImagen 1 / Imagen 2‚Äù === */
  .img-item-block {
    margin-bottom: 8px;
    padding: 0;
    background: #ffffff;
    border-radius: 8px;
    border: 1.5px solid #d1d5db;
    box-shadow: 0 1px 2px rgba(60, 72, 100, 0.04);
  }

  .img-item-header {
    width: 100%;
    padding: 8px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    background: #e6eaf2;
    border: 0;
    border-bottom: 1.5px solid #d1d5db;
    cursor: pointer;
    font-weight: 600;
    border-radius: 8px 8px 0 0;
  }

  .img-item-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .img-item-drag {
    font-size: 14px;
    color: #2d3a4b;
  }

  .img-item-title {
    font-size: 12px;
    font-weight: 700;
    color: #2d3a4b;
  }

  .img-item-body {
    padding: 12px 16px 14px 16px;
  }

  .img-item-block.img-item--collapsed .img-item-body {
    display: none;
  }

  /* === Flechitas tipo "pescadito" (solo punta) === */

  /* Toggle del bloque */
  .mod-toggle-icon {
    display: inline-block;
    width: 5px;
    height: 5px;
    border-right: 2px solid #6b7280;
    border-bottom: 2px solid #6b7280;
    transform: rotate(45deg);
    background: none;
    border-radius: 0;
    box-shadow: none;
    border-left: none;
    border-top: none;
    /* Sin recuadro, solo la flecha */
    transition: transform 0.15s ease;
  }

  .mod-box.collapsed .mod-toggle-icon {
    transform: rotate(-135deg);
  }

  /* Chevrons de secciones e items */
  .mod-section-chevron,
  .text-item-chevron,
  .img-item-chevron {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    font-size: 0;
    transition: transform 0.18s ease;
  }
  .mod-section-chevron::before,
  .text-item-chevron::before,
  .img-item-chevron::before {
    content: "expand_more";
    font-family: "Material Symbols Outlined";
    font-size: 18px;
    color: #6b7280;
    line-height: 1;
  }
  .mod-section.mod-section--collapsed .mod-section-chevron,
  .text-item-block.text-item--collapsed .text-item-chevron,
  .img-item-block.img-item--collapsed .img-item-chevron {
    transform: rotate(-90deg);
  }

  /* checks alineados a la derecha dentro de secciones */
  .checks--inline {
    justify-content: flex-end;
  }

  .export-panel {
    margin-top: 12px;
  }

  /* === Override colores seg√∫n maqueta === */

  /* Fondo general gris claro */
  body,
  .app-shell {
    background: #F8FAFC;
  }

  /* Tarjetas y bloques blancos */
  .card,
  .mod-box,
  .mod-section,
  .text-item-block,
  .img-item-block,
  .preview-box {
    background: #FFFFFF;
  }

  /* Bordes suaves */
  .card,
  .mod-box,
  .mod-section,
  .text-item-block,
  .img-item-block,
  .preview-box,
  .select,
  input[type="text"],
  input[type="number"],
  textarea {
    border-color: #E5E7EB;
  }

  /* Bot√≥n principal azul (tipo "Cargar Excel") */
  .btn-primary {
    background: #e5e7eb;
    border-color: #e5e7eb;
    color: #23272f;
  }

  .btn-primary:hover {
    background: #d1d5db;
    border-color: #d1d5db;
    color: #23272f;
  }

  /* Bot√≥n √©xito en verde */
  .btn-success {
    background: #22C55E;
    border-color: #22C55E;
    color: #FFFFFF;
  }

  /* Bot√≥n outline gris */
  .btn-outline {
    background: #FFFFFF;
    border-color: #D1D5DB;
    color: #111827;
  }

  /* Textos secundarios grises */
  .app-subtitle,
  .card-subtitle,
  .toolbar-label {
    color: #6B7280;
  }

  /* Inputs estilo maqueta */
  input[type="text"],
  input[type="number"],
  textarea,
  .select {
    background: #FFFFFF;
    border-radius: 8px;
    font-size: 13px;
  }

  /* Select peque√±o tambi√©n */
  .select-sm {
    background: #F9FAFB;
  }

  /* Fila de inputs de im√°genes (se mantiene el layout horizontal) */
  .img-fields-row {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr) minmax(0, 1.5fr);
    gap: 12px;
  }

  .img-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .img-field label {
    font-size: 12px;
    font-weight: 500;
    color: #4B5563;
  }

  .img-field-input input[type="text"] {
    width: 100%;
    padding: 6px 10px;
    font-size: 13px;
    border-radius: 8px;
    border: 1px solid #E5E7EB;
    background: #F9FAFB;
  }

  .img-field .source-compact {
    margin-top: 4px;
    align-self: flex-end;
  }

  .img-field .source-compact select {
    font-size: 11px;
    background: #F9FAFB;
  }

  /* Iconos dentro de los botones de acci√≥n de bloque */
  .icon-button-symbol {
    font-size: 18px;
    color: #6B7280;
  }

  /* Por si antes ten√≠as algo rojo, esto lo pisa */
  .icon-button-trash .icon-button-symbol {
    color: #6B7280;
  }

  /* Responsive: en pantallas chicas, apilar los 3 campos */
  @media (max-width: 960px) {
    .img-fields-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- SheetJS for Excel processing -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
const MOD_TYPE_META = {
  "texto": {
    label: "Texto",
    icon: "article"
  },
  "imagen": {
    label: "Imagen",
    icon: "image"
  },
  "texto-imagen-h": {
    label: "Texto + Imagen",
    icon: "view_sidebar"
  },
  "html": {
    label: "HTML personalizado",
    icon: "code"
  },
  "video-autoplay": {
    label: "Video",
    icon: "smart_display"
  }

};

  let modCount = 0;

  let globalExcelData = {
    columns: [],
    rows: [],
    fileName: ""
  };
  let currentRenderRowIndex = null;

  let currentEditor = null;
  // === Auto-preview: render con debounce ===
  let renderTimeout = null;
  let isCodeView = false;  // false = vista previa, true = c√≥digo

  function scheduleRender() {
    if (renderTimeout) {
      clearTimeout(renderTimeout);
    }
    renderTimeout = setTimeout(() => {
      renderAll();
      renderTimeout = null;
    }, 200); // puedes subir/bajar este n√∫mero si quieres m√°s o menos delay
  }

    function isExcelLoaded() {
      return Array.isArray(globalExcelData.columns) && globalExcelData.columns.length > 0;
    }


  function refreshSourceSelects() {
    const hasExcel = isExcelLoaded();
    const selects = document.querySelectorAll('select[data-source-select="1"]');
    const wrappers = document.querySelectorAll('[data-source-wrapper="1"]');

    // Mostrar / ocultar el bloque completo "Fuente de datos"
    wrappers.forEach(w => {
      w.style.display = hasExcel ? '' : 'none';
    });

    // Refrescar selects
    selects.forEach(sel => {
      const previousValue = sel.value || 'manual';

      // Reconstruimos opciones seg√∫n el Excel actual
      sel.innerHTML = getColumnOptions();

      if (hasExcel && Array.from(sel.options).some(o => o.value === previousValue)) {
        sel.value = previousValue;
      } else {
        sel.value = 'manual';
      }

      sel.disabled = !hasExcel;
      sel.title = hasExcel
        ? 'Selecciona columna del Excel'
        : 'Carga un Excel para activar esta opci√≥n';
    });
  }

  /* ========= GLOBAL EXCEL UPLOAD ========= */
  function handleGlobalExcelUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    console.log('Archivo cargado:', file.name);
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (!jsonData || jsonData.length === 0) {
          alert('El archivo parece estar vac√≠o.');
          return;
        }
        // Extract column names
        globalExcelData.columns = Object.keys(jsonData[0]);
        globalExcelData.rows = jsonData;
        globalExcelData.fileName = file.name;

        alert(
          `Excel cargado exitosamente!\n\nColumnas detectadas:\n${globalExcelData.columns.join(', ')}\n\nFilas: ${globalExcelData.rows.length}`
        );

        // Row selector
        populateRowSelector();

        // Mostrar selector (boton descargar siempre visible)
        const selectorContainer = byId('excel-row-selector-container');
        if (selectorContainer) selectorContainer.classList.remove('toolbar-item--hidden');



        // Habilitar selects de fuente de datos
        refreshSourceSelects();

        // üîÑ Muy importante: refrescar campos ya vinculados (si es que hay)
        refreshBoundFieldsForCurrentRow();

        // Render inicial con la fila seleccionada
        renderAll();
      } catch (err) {
        console.error(err);
        alert('Error al leer el archivo: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function downloadExcel() {
    // Si hay Excel cargado, descargamos todos los datos; si no, exportamos el HTML actual.
    if (isExcelLoaded() && globalExcelData.rows && globalExcelData.rows.length) {
      downloadCurrentExcel();
    } else {
      downloadSingleExcel();
    }
  }

  function downloadCurrentExcel() {
    if (!isExcelLoaded() || !globalExcelData.rows || !globalExcelData.rows.length) {
      alert('Primero carga un archivo Excel.');
      return;
    }

    const ws = XLSX.utils.json_to_sheet(globalExcelData.rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Datos');

    const baseName = (globalExcelData.fileName || 'excel_cargado').replace(/\\.xlsx?$/i, '');
    XLSX.writeFile(wb, `${baseName}_descarga.xlsx`);
  }

  function populateRowSelector() {
    const selector = byId('excel-row-selector');
    if (!selector) return;
    selector.innerHTML = '';
    const firstCol = globalExcelData.columns[0];
    globalExcelData.rows.forEach((row, index) => {
      const opt = document.createElement('option');
      opt.value = index;
      opt.textContent = `${row[firstCol]} (Fila ${index + 1})`;
      selector.appendChild(opt);
    });
  }

  function getColumnOptions() {
    if (!globalExcelData.columns || globalExcelData.columns.length === 0) {
      return '<option value="manual">Valor manual</option>';
    }

    let options = '<option value="manual">Valor manual</option>';
    globalExcelData.columns.forEach(col => {
      options += `<option value="${col}">${col}</option>`;
    });
    return options;
  }

  function getCurrentRowIndex() {
    if (!globalExcelData.rows || !globalExcelData.rows.length) return 0;

    // generaci√≥n masiva (generateAllHTML)
    if (currentRenderRowIndex !== null) {
      return currentRenderRowIndex;
    }

    // modo vista previa normal
    const rowSelector = byId('excel-row-selector');
    const idx = rowSelector ? parseInt(rowSelector.value || '0', 10) : 0;
    return isNaN(idx) ? 0 : idx;
  }

  function refreshBoundFieldsForCurrentRow() {
    if (!globalExcelData.rows || !globalExcelData.rows.length) return;

    const rowIndex = getCurrentRowIndex();
    const row = globalExcelData.rows[rowIndex] || {};

    document.querySelectorAll('[data-excel-bound="1"]').forEach(field => {
      const col = field.dataset.excelColumn;
      if (!col) return;

      const raw = row[col];
      const value = (raw !== undefined && raw !== null) ? String(raw) : '';

      const isRich = field.classList && field.classList.contains('rich-textarea');

      if (isRich) {
        field.setAttribute('contenteditable', 'true');

        const base = field.dataset.excelBaseValue || '';
        const tpl = field.dataset.excelTemplate || '';

        let newHtml;

        if (tpl && tpl.indexOf('__EXCEL_VALUE__') !== -1) {
          // ya tenemos plantilla con placeholder
          newHtml = tpl.split('__EXCEL_VALUE__').join(value);
        } else if (base && field.innerHTML && field.innerHTML.indexOf(base) !== -1) {
          // generamos plantilla reemplazando el viejo valor por placeholder
          const currentHtml = field.innerHTML;
          const template = currentHtml.split(base).join('__EXCEL_VALUE__');
          field.dataset.excelTemplate = template;
          newHtml = template.split('__EXCEL_VALUE__').join(value);
        } else {
          // sin estilos definidos todav√≠a: usamos el valor plano
          newHtml = value;
          field.dataset.excelTemplate = value;
        }

        field.innerHTML = newHtml;
        field.dataset.excelBaseValue = value;

        field.classList.toggle(
          'empty',
          value.replace(/<br\s*\/?>/gi, '').trim() === ''
        );
      } else if ('value' in field) {
        const wasReadOnly = !!field.readOnly;
        field.readOnly = false;
        field.value = value;
        field.readOnly = wasReadOnly;
      } else {
        field.textContent = value;
      }
    });
  }

  function handleRowChange() {
    // 1) actualiza los campos del bloque con los datos de la fila seleccionada
    refreshBoundFieldsForCurrentRow();
    // 2) vuelve a generar la vista con esos datos
    renderAll();
  }



  function getExcelValue(columnName) {
    if (!columnName || columnName === 'manual' || !globalExcelData.rows.length) {
      return null;
    }

    const rowIndex = getCurrentRowIndex();
    const row = globalExcelData.rows[rowIndex] || {};
    const value = row[columnName];

    return (value !== undefined && value !== null) ? value : '';
  }



  function generateAllHTML() {
    if (!globalExcelData.rows.length) {
      alert('Primero carga un archivo Excel');
      return;
    }

    const results = [];
    const firstCol = globalExcelData.columns[0];

    // Guardamos la fila actualmente seleccionada en el selector (para restaurar la vista)
    const rowSelector = byId('excel-row-selector');
    const originalRowIndex = rowSelector ? parseInt(rowSelector.value || '0', 10) : 0;

    globalExcelData.rows.forEach((row, index) => {
      // Forzamos que todas las lecturas desde Excel apunten a ESTA fila
      currentRenderRowIndex = index;

      // Actualiza todos los campos ligados a Excel (texto, urls, alt, links, etc.)
      refreshBoundFieldsForCurrentRow();

      // Render con los datos de esta fila
      renderAll();

      const html = byId('htmlFullOut').value;

      results.push({
        id: index + 1,
        longDescription: html
      });
    });


    // Volvemos a modo normal (vista atada al selector visual)
    currentRenderRowIndex = null;
    if (rowSelector) {
      rowSelector.value = originalRowIndex;
      renderAll(); // restaurar la preview a la fila que estaba elegida
    }

    // Descargar Excel con resultados
    const ws = XLSX.utils.json_to_sheet(results);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'HTMLs Generados');
    XLSX.writeFile(wb, 'inpages_generados.xlsx');
    alert(`¬°Listo! Se generaron ${results.length} HTMLs y se descarg√≥ el archivo Excel.`);
  }

  function downloadSingleExcel() {
    // Si hay carga masiva, usar la l√≥gica existente
    if (globalExcelData.rows && globalExcelData.rows.length > 1) {
      // Descarga masiva: id y longDescription
      const results = [];
      globalExcelData.rows.forEach((row, index) => {
        const html = byId('htmlFullOut').value;
        results.push({ id: index + 1, longDescription: html });
      });
      const ws = XLSX.utils.json_to_sheet(results);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'HTMLs Generados');
      XLSX.writeFile(wb, 'inpages_generados.xlsx');
      alert(`¬°Listo! Se generaron ${results.length} HTMLs y se descarg√≥ el archivo Excel.`);
      return;
    }
    // Descarga individual: id=1 y longDescription=html generado
    const html = byId('htmlFullOut').value;
    const data = [{ id: 1, longDescription: html }];
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'HTML Generado');
    XLSX.writeFile(wb, 'inpage_generado.xlsx');
    alert('¬°Listo! Se descarg√≥ el Excel con el HTML generado.');
  }

  /* ========= creaci√≥n / inserci√≥n / orden ========= */

  function addMod() {
    addModAt("end", null);
  }

  function addModAt(where, refId) {
    modCount++;
    const id = "mod_" + modCount;
    const box = createModuleBox(id, modCount);
    const container = document.getElementById("mods");

    if (!where || where === "end" || !refId) {
      container.appendChild(box);
      return;
    }

    const ref = document.getElementById(refId);
    if (!ref) {
      container.appendChild(box);
      return;
    }

    if (where === "before") {
      container.insertBefore(box, ref);
    } else if (where === "after") {
      container.insertBefore(box, ref.nextSibling);
    } else {
      container.appendChild(box);
    }
    updatePositions();
  }

  function updatePositions() {
    const container = document.getElementById("mods");
    if (!container) return;
    // Only select direct children to avoid nested .mod-box elements
    const boxes = Array.from(container.children).filter(el => el.classList.contains("mod-box"));
    boxes.forEach((box, i) => {
      const posLabel = box.querySelector(".mod-pos");
      if (posLabel) posLabel.textContent = "Posici√≥n " + (i + 1);
    });
  }

function createModuleBox(id, index) {
  const box = document.createElement("div");
  box.className = "mod-box";
  box.id = id;
  box.ondragover = (e) => dragOver(e);
  box.ondrop = (e) => drop(e, id);

  box.innerHTML = `
    <div class="mod-header"
         draggable="true"
         ondragstart="dragStart(event, '${id}')"
         ondragend="dragEnd(event)"
         onclick="toggleBody('${id}')">

      <div class="mod-header-left">
        <span class="mod-drag-handle" title="Arrastrar para mover">‚ò∞</span>
        <div class="mod-header-text">
          <span class="mod-badge">Bloque ${index}</span>
          <span class="mod-pos">Posici√≥n ${index}</span>
        </div>
      </div>

      <!-- PILL CENTRAL: por defecto dice "M√≥dulo" -->
      <div class="mod-header-type" onclick="event.stopPropagation();">
        <div class="mod-type-pill">
          <span id="${id}-tipo-icon"
                class="material-symbols-outlined mod-type-pill-icon">
            tune
          </span>
          <span id="${id}-tipo-label"
                class="mod-type-pill-text">
            M√≥dulo
          </span>
          <span class="material-symbols-outlined mod-type-pill-caret">
            expand_more
          </span>

          <!-- select real, invisible -->
          <select id="${id}-tipo"
                  class="mod-type-select-native"
                  onchange="handleTipoChange('${id}')">
            <option value="" selected>M√≥dulo</option>
            <option value="texto">Texto</option>
            <option value="imagen">Imagen</option>
            <option value="texto-imagen-h">Texto + Imagen</option>
            <option value="html">HTML personalizado</option>
            <option value="video-autoplay">Video</option>
          </select>
        </div>
      </div>

      <div class="mod-header-actions" onclick="event.stopPropagation();">
        <button type="button"
                class="icon-button"
                onclick="moveMod('${id}','up')">
          <span class="material-symbols-outlined icon-button-symbol">arrow_upward</span>
        </button>
        <button type="button"
                class="icon-button"
                onclick="moveMod('${id}','down')">
          <span class="material-symbols-outlined icon-button-symbol">arrow_downward</span>
        </button>
        <button type="button"
                class="icon-button icon-button-trash"
                onclick="removeMod('${id}')"
                title="Eliminar bloque">
          <span class="material-symbols-outlined icon-button-symbol">
            delete
          </span>
        </button>
        <button type="button"
                class="icon-button mod-toggle"
                onclick="toggleBody('${id}'); event.stopPropagation();">
          <span class="mod-toggle-icon"></span>
        </button>
      </div>
    </div>

    <div class="mod-body" id="${id}-body">
      <div id="${id}-inputs" class="muted"></div>
    </div>
  `;

  // üëá OJO: ac√° solo renderizamos inputs,
  // ya NO llamamos a updateModTypeUI para no pisar "M√≥dulo"
  setTimeout(() => {
    renderInputs(id);
  }, 0);

  return box;
}

function moveMod(id, dir) {
    const el = document.getElementById(id);
    if (!el) return;
    const parent = el.parentElement;
    if (!parent) return;

    if (dir === "up") {
      const prev = el.previousElementSibling;
      if (prev) parent.insertBefore(el, prev);
    } else if (dir === "down") {
      const next = el.nextElementSibling;
      if (next) parent.insertBefore(next, el);
    }
    updatePositions();
  }

  function toggleBody(id) {
    const box = byId(id);
    if (!box) return;
    box.classList.toggle('collapsed');
  }


  function removeMod(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
    updatePositions();
    scheduleRender();
  }


  /* ========= inputs por tipo ========= */

  function renderInputs(id) {
    const tipo = val(id + "-tipo");
    const cont = byId(id + "-inputs");

if (tipo === "texto") {
  cont.innerHTML = `
    <div class="mod-section mod-section--open">
      <button type="button"
              class="mod-section-header"
              onclick="toggleSection(this)">
        <span class="mod-section-title">Configuraci√≥n</span>
<span class="mod-section-chevron"></span>
      </button>
      <div class="mod-section-body">
        <div class="params-grid">
          <div class="param-item">
            <label>Cantidad</label>
            <input id="${id}-tcount"
                   type="number"
                   min="1"
                   max="10"
                   value="1"
                   style="width:50px"
                   oninput="updateTextCount('${id}')">
          </div>

          <div class="param-item">
            <label>Color fondo</label>
            <input id="${id}-bg"
                   type="color"
                   class="mini-color"
                   value="#ffffff"
                   title="Color de fondo">
          </div>

          <div class="param-item">
            <label>Ancho (%)</label>
            <input id="${id}-w"
                   type="number"
                   min="10"
                   max="100"
                   value="100"
                   style="width:60px">
          </div>

          <div class="param-item">
            <label>Margen inferior</label>
            <select id="${id}-mb">
              <option value="0">Ninguno</option>
              <option value="2" selected>Bajo</option>
              <option value="4">Medio</option>
              <option value="8">Alto</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="mod-section mod-section--open">
      <button type="button"
              class="mod-section-header"
              onclick="toggleSection(this)">
        <span class="mod-section-title">Textos</span>
<span class="mod-section-chevron"></span>
      </button>
      <div class="mod-section-body">
        <div id="${id}-titems"></div>
      </div>
    </div>
  `;
  updateTextCount(id);
  return;
}
if (tipo === "imagen") {
  cont.innerHTML = `
    <div class="mod-section mod-section--open">
      <button type="button"
              class="mod-section-header"
              onclick="toggleSection(this)">
        <span class="mod-section-title">Configuraci√≥n</span>
      <span class="mod-section-chevron"></span>
      </button>
      <div class="mod-section-body">
        <div class="params-grid">
          <div class="param-item">
            <label>Cantidad</label>
            <input id="${id}-count"
                   type="number"
                   min="1"
                   max="10"
                   value="1"
                   style="width:50px"
                   oninput="updateImgCount('${id}')">
          </div>

          <div class="param-item">
            <label>Posici√≥n</label>
            <select id="${id}-ialign">
              <option value="left">Izquierda</option>
              <option value="center" selected>Centro</option>
              <option value="right">Derecha</option>
              <option value="justify">Justificado</option>
            </select>
          </div>

          <div class="param-item">
            <label>Curva (%)</label>
            <input id="${id}-radius"
                   type="number"
                   min="0"
                   max="100"
                   value="0"
                   style="width:60px">
          </div>

          <div class="param-item">
            <label>Ancho (%)</label>
            <input id="${id}-isize"
                   type="number"
                   min="10"
                   max="100"
                   value="100"
                   style="width:60px">
          </div>

          <div class="param-item">
            <label>Margen inferior</label>
            <select id="${id}-mb">
              <option value="0">Ninguno</option>
              <option value="2" selected>Bajo</option>
              <option value="4">Medio</option>
              <option value="8">Alto</option>
            </select>

          </div>
        </div>
      </div>
    </div>

    <div class="mod-section mod-section--open">
      <button type="button"
              class="mod-section-header"
              onclick="toggleSection(this)">
        <span class="mod-section-title">Im√°genes</span>
        <span class="mod-section-chevron">‚ñæ</span>
      </button>
      <div class="mod-section-body">
        <div id="${id}-items"></div>
      </div>
    </div>
  `;
  updateImgCount(id);
  return;
}

if (tipo === "texto-imagen-h") {
  const defaultLeft = "texto";
  const defaultRight = "imagen";

  cont.innerHTML = `
    <div class="mod-section mod-section--open">
      <button type="button"
              class="mod-section-header"
              onclick="toggleSection(this)">
        <span class="mod-section-title">Configuraci√≥n</span>
        <span class="mod-section-chevron">‚ñæ</span>
      </button>
      <div class="mod-section-body">
        <div class="params-grid">
          <div class="param-item">
            <label>Izquierda</label>
            <select id="${id}-hleft">
              <option value="texto" ${defaultLeft === "texto" ? "selected" : ""}>Texto</option>
              <option value="imagen" ${defaultLeft === "imagen" ? "selected" : ""}>Imagen</option>
            </select>
          </div>

          <div class="param-item">
            <label>Derecha</label>
            <select id="${id}-hright">
              <option value="texto" ${defaultRight === "texto" ? "selected" : ""}>Texto</option>
              <option value="imagen" ${defaultRight === "imagen" ? "selected" : ""}>Imagen</option>
            </select>
          </div>

          <div class="param-item">
            <label>% Izq</label>
            <input id="${id}-wleft"
                   type="number"
                   min="10"
                   max="90"
                   value="50"
                   style="width:60px">
          </div>

          <div class="param-item">
            <label>% Der</label>
            <input id="${id}-wright"
                   type="number"
                   min="10"
                   max="90"
                   value="50"
                   style="width:60px">
          </div>

          <div class="param-item">
            <label>Color fondo</label>
            <input id="${id}-hbg"
                   type="color"
                   class="mini-color"
                   value="#ffffff"
                   title="Color de fondo">
          </div>

          <div class="param-item">
            <label>Margen inferior</label>
              <select id="${id}-hmb">
              <option value="0">Ninguno</option>
              <option value="2" selected>Bajo</option>
              <option value="4">Medio</option>
              <option value="8">Alto</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="mod-section mod-section--open">
      <button type="button"
              class="mod-section-header"
              onclick="toggleSection(this)">
        <span class="mod-section-title">Texto</span>
        <span class="mod-section-chevron">‚ñæ</span>
      </button>
      <div class="mod-section-body">
        <div class="params-grid">
          <div class="param-item">
            <label>Cantidad</label>
            <input id="${id}-htcount"
                   type="number"
                   min="1"
                   max="10"
                   value="1"
                   style="width:50px"
                   oninput="updateHTextCount('${id}')">
          </div>
        </div>

        <div id="${id}-htitems"></div>
      </div>
    </div>

    <div class="mod-section mod-section--open">
      <button type="button"
              class="mod-section-header"
              onclick="toggleSection(this)">
        <span class="mod-section-title">Im√°genes</span>
        <span class="mod-section-chevron">‚ñæ</span>
      </button>
      <div class="mod-section-body">
        <div class="params-grid">
          <div class="param-item">
            <label>Cantidad</label>
            <input id="${id}-hicount"
                   type="number"
                   min="1"
                   max="10"
                   value="1"
                   style="width:50px"
                   oninput="updateHImgCount('${id}')">
          </div>

          <div class="param-item">
            <label>Posici√≥n</label>
            <select id="${id}-hialign">
              <option value="left">Izquierda</option>
              <option value="center" selected>Centro</option>
              <option value="right">Derecha</option>
            </select>
          </div>

          <div class="param-item">
            <label>Curva (%)</label>
            <input id="${id}-hiradius"
                   type="number"
                   min="0"
                   max="100"
                   value="0"
                   style="width:60px">
          </div>
        </div>

        <div id="${id}-hitems"></div>
      </div>
    </div>
  `;

  updateHTextCount(id);
  updateHImgCount(id);
  return;
}

    if (tipo === "html") {
      cont.innerHTML = `
      <div class="img-item-block">
        <div class="data-field-row">
          <label>HTML</label>

          <div class="data-field-main">
            <textarea
              id="${id}-htmlcode"
              rows="8"
              placeholder="<div>Tu HTML aqu√≠...</div>"
              style="font-family:monospace; font-size:12px;"></textarea>
          </div>

          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-htmlcode-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-htmlcode')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>

        <p style="font-size:11px; color:#666; margin:4px 0 0;">
          Puedes escribir HTML manual o traerlo desde una columna del Excel. Lo que edites se guarda por fila (ID).
        </p>
      </div>
    `;
      refreshSourceSelects();
      return;
    }

    if (tipo === "video-autoplay") {
      cont.innerHTML = `
        <div class="mod-section mod-section--open">
          <button type="button"
                  class="mod-section-header"
                  onclick="toggleSection(this)">
            <span class="mod-section-title">Video</span>
            <span class="mod-section-chevron">‚ñæ</span>
          </button>
          <div class="mod-section-body">
            <div class="data-field-row">
              <label>Video</label>
              <div class="data-field-main">
                <input
                  id="${id}-video-url"
                  type="text"
                  placeholder="https://example.com/video.mp4">
              </div>
              <div class="source-compact" data-source-wrapper="1">
                <select
                  id="${id}-video-url-source"
                  data-source-select="1"
                  ${isExcelLoaded() ? '' : 'disabled'}
                  onchange="handleSourceChange('${id}-video-url')">
                  ${getColumnOptions()}
                </select>
              </div>
            </div>
            <p class="muted" style="margin-top:4px;">
              Se generar√° un bloque 16:9 responsive con autoplay, muted, loop y playsinline.
            </p>
          </div>
        </div>
      `;
      refreshSourceSelects();
      return;
    }

    cont.innerHTML = `<span class="muted">Selecciona un tipo de m√≥dulo para ver sus opciones.</span>`;
  }
  /* ========= textos con m√∫ltiples items ========= */
function handleTipoChange(id) {
  updateModTypeUI(id);  // refresca texto + icono del pill
  renderInputs(id);     // redibuja contenido del bloque
  scheduleRender();     // opcional, pero ayuda a ver el cambio al tiro
}
function updateModTypeUI(id) {
  const sel = byId(id + "-tipo");
  const labelEl = byId(id + "-tipo-label");
  const iconEl = byId(id + "-tipo-icon");
  if (!sel || !labelEl) return;

  const value = sel.value;
  const meta = MOD_TYPE_META[value] || { label: value, icon: "tune" };

  labelEl.textContent = meta.label;
  if (iconEl) {
    iconEl.textContent = meta.icon;
  }
}


function updateModTypeLabel(id) {
  const sel = byId(id + "-tipo");
  const labelEl = byId(id + "-tipo-label");
  if (!sel || !labelEl) return;

  const opt = sel.options[sel.selectedIndex];
  const text = opt ? opt.textContent.trim() : 'M√≥dulo';

  labelEl.textContent = text;
}

function updateTextCount(id) {
  const container = byId(id + "-titems");
  if (!container) return;

  // 1) Guardar lo que ya hay
  const snapshot = snapshotModuleFields(container);

  // 2) Normalizar cantidad
  let count = parseInt(val(id + "-tcount"), 10) || 1;
  if (count < 1) count = 1;
  if (count > 10) count = 10;
  byId(id + "-tcount").value = String(count);

  // 3) Recrear markup
  container.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    const wrapper = document.createElement("div");
    wrapper.className = "text-item-block";

    wrapper.innerHTML = `
      <button type="button"
              class="text-item-header"
              onclick="toggleTextItem(this)">
        <div class="text-item-header-left">
          <span class="text-item-drag">‚ãÆ‚ãÆ</span>
          <span class="text-item-title">Texto ${i}</span>
        </div>
        <span class="text-item-chevron"></span>
      </button>

      <div class="text-item-body">
        <div class="data-field-row">
          <div class="data-field-main">
            <div class="text-toolbar-inline">
              <select class="text-toolbar-select"
                      onchange="applyFontSize(this, event)">
                <option value="">Normal</option>
                <option value="10">10</option>
                <option value="12">12</option>
                <option value="14">14</option>
                <option value="16">16</option>
                <option value="18">18</option>
                <option value="20">20</option>
                <option value="22" selected>22</option>
                <option value="24">24</option>
                <option value="28">28</option>
                <option value="32">32</option>
              </select>

              <span class="text-toolbar-separator">|</span>

              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="bold"
                      onmousedown="toolbarCommand(this, event)">
                <b>B</b>
              </button>
              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="italic"
                      onmousedown="toolbarCommand(this, event)">
                <i>K</i>
              </button>
              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="underline"
                      onmousedown="toolbarCommand(this, event)">
                <u>U</u>
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="createLink"
                      onmousedown="toolbarCommand(this, event)">
                üîó
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      onmousedown="applyInlineFormat('insertUnorderedList', event)"
                      title="Vi√±etas">
                <img src="./assets/icons/list-ul.svg"
                     alt="Lista con vi√±etas"
                     class="toolbar-icon-img">
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      onmousedown="applyInlineFormat('insertOrderedList', event)"
                      title="Numeraci√≥n">
                <img src="assets/icons/list-ol.svg"
                     alt="Lista numerada"
                     class="toolbar-icon-img">
              </button>

              <div class="text-color-picker">
                <button type="button"
                        class="text-toolbar-button text-color-btn"
                        title="Color de texto"
                        onmousedown="event.preventDefault(); this.nextElementSibling.click();">
                  <img src="assets/icons/paint-bucket.svg"
                       alt="Color de texto"
                       class="text-color-picker-icon">
                  <span class="text-color-picker-bar"></span>
                </button>

                <input type="color"
                       class="text-toolbar-color"
                       value="#333333"
                       onchange="applyTextColor(this, event)"
                       oninput="updateTextColorBar(this)"
                       onmousedown="event.stopPropagation();">
              </div>

              <select class="text-toolbar-select text-toolbar-lineheight"
                      onchange="applyLineHeight(this, event)"
                      title="Interlineado">
                <option value="">‚Üï</option>
                <option value="1">1.0</option>
                <option value="1.15">1.15</option>
                <option value="1.5">1.5</option>
                <option value="2">2.0</option>
              </select>

              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyLeft"
                      onmousedown="toolbarCommand(this, event)"
                      title="Alinear a la izquierda">
                <span class="icon-align icon-align-left"><span></span></span>
              </button>

              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyCenter"
                      onmousedown="toolbarCommand(this, event)"
                      title="Centrar">
                <span class="icon-align icon-align-center"><span></span></span>
              </button>
              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyRight"
                      onmousedown="toolbarCommand(this, event)"
                      title="Alinear a la derecha">
                <span class="icon-align icon-align-right"><span></span></span>
              </button>
              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyFull"
                      onmousedown="toolbarCommand(this, event)"
                      title="Justificado">
                <span class="icon-align icon-align-justify"><span></span></span>
              </button>
            </div>

            <div id="${id}-txt${i}"
                 class="rich-textarea empty"
                 contenteditable="true"
                 data-type="rich-text">
            </div>
          </div>

          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-txt${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-txt${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>
      </div>
    `;

    container.appendChild(wrapper);
  }

  // 4) Refrescar selects Excel y restaurar valores
  refreshSourceSelects();
  restoreModuleFields(snapshot);
}

  function handleSourceChange(fieldId) {
    const sourceSelect = byId(fieldId + '-source');
    const field = byId(fieldId);
    if (!sourceSelect || !field) return;

    const source = sourceSelect.value;
    const isRich = field.classList && field.classList.contains('rich-textarea');

    // limpiar metadata previa de binding
    if (field.dataset) {
      delete field.dataset.excelBound;
      delete field.dataset.excelColumn;
    }

    // MODO MANUAL ‚Üí editable normal
    if (source === 'manual') {
      if (isRich) {
        if (field.innerHTML.replace(/<br\s*\/?>/gi, '').trim() === '') {
          field.classList.add('empty');
        } else {
          field.classList.remove('empty');
        }
        // activamos editor y barra sobre este campo
        activateRichEditor(field);
      } else {
        if ('readOnly' in field) field.readOnly = false;
        if ('disabled' in field) field.disabled = false;
        if ('placeholder' in field) field.placeholder = 'Ingresa el texto...';
      }
      scheduleRender();
      return;
    }

    // MODO EXCEL ‚Üí trae el valor de la columna
    const excelValue = getExcelValue(source);
    const v = (excelValue !== null && excelValue !== undefined) ? String(excelValue) : '';

    if (isRich) {
      // seguimos usando rich-text, pero con data del Excel
      field.innerHTML = v;
      if (v.replace(/<br\s*\/?>/gi, '').trim() === '') {
        field.classList.add('empty');
      } else {
        field.classList.remove('empty');
      }
      // activamos editor (cursor + barra apuntando ac√°)
      activateRichEditor(field);
    } else {
      // inputs normales: solo lectura si vienen de Excel
      if ('value' in field) field.value = v;
      if ('placeholder' in field) field.placeholder = 'Dato desde Excel (solo lectura)';
      if ('readOnly' in field) field.readOnly = true;
      if ('disabled' in field) field.disabled = false;
    }

    // marcamos que este campo depende de Excel (para cambios de fila y bloqueo de edici√≥n de texto)
    if (field.dataset) {
      field.dataset.excelBound = '1';
      field.dataset.excelColumn = source;
    }

    // refrescar preview autom√°ticamente
    scheduleRender();
  }

  function handleHtmlEdited(modId) {

  }

  /* ========= im√°genes con input+lista ========= */

function updateImgCount(id) {
  const container = byId(id + "-items");
  if (!container) return;

  // 1) Guardar lo ya ingresado
  const snapshot = snapshotModuleFields(container);

  // 2) Normalizar cantidad
  let count = parseInt(val(id + "-count"), 10) || 1;
  if (count < 1) count = 1;
  if (count > 10) count = 10;
  byId(id + "-count").value = String(count);

  // 3) Recrear UI
  container.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    const div = document.createElement("div");
    div.className = "img-item-block";

    div.innerHTML = `
      <button type="button"
              class="img-item-header"
              onclick="toggleImgItem(this)">
        <div class="img-item-header-left">
          <span class="img-item-drag">‚ãÆ‚ãÆ</span>
          <span class="img-item-title">Imagen ${i}</span>
        </div>
        <span class="img-item-chevron"></span>
      </button>

      <div class="img-item-body">
        <div class="img-fields-row">
          <!-- Columna 1: URL -->
          <div class="img-field">
            <label>URL de imagen</label>
            <div class="img-field-input">
              <input
                type="text"
                id="${id}-img${i}"
                placeholder="https://...">
            </div>
            <div class="source-compact" data-source-wrapper="1">
              <select
                id="${id}-img${i}-source"
                data-source-select="1"
                ${isExcelLoaded() ? '' : 'disabled'}
                onchange="handleSourceChange('${id}-img${i}')">
                ${getColumnOptions()}
              </select>
            </div>
          </div>

          <!-- Columna 2: ALT -->
          <div class="img-field">
            <label>Texto alt (opcional)</label>
            <div class="img-field-input">
              <input
                type="text"
                id="${id}-alt${i}"
                placeholder="Descripci√≥n de la imagen">
            </div>
            <div class="source-compact" data-source-wrapper="1">
              <select
                id="${id}-alt${i}-source"
                data-source-select="1"
                ${isExcelLoaded() ? '' : 'disabled'}
                onchange="handleSourceChange('${id}-alt${i}')">
                ${getColumnOptions()}
              </select>
            </div>
          </div>

          <!-- Columna 3: LINK -->
          <div class="img-field">
            <label>Enlace (opcional)</label>
            <div class="img-field-input">
              <input
                type="text"
                id="${id}-link${i}"
                placeholder="https://...">
            </div>
            <div class="source-compact" data-source-wrapper="1">
              <select
                id="${id}-link${i}-source"
                data-source-select="1"
                ${isExcelLoaded() ? '' : 'disabled'}
                onchange="handleSourceChange('${id}-link${i}')">
                ${getColumnOptions()}
              </select>
            </div>
          </div>
        </div>
      </div>
    `;

    container.appendChild(div);
  }

  // 4) Refrescar selects Excel y restaurar valores
  refreshSourceSelects();
  restoreModuleFields(snapshot);
}

  /* ========= horizontal layout helpers ========= */

function updateHTextCount(id) {
  const cont = byId(id + "-htitems");
  if (!cont) return;

  const snapshot = snapshotModuleFields(cont);

  const raw = (val(id + "-htcount") || "").trim();
  if (raw === "") return;

  let n = parseInt(raw, 10);
  if (isNaN(n) || n < 1) n = 1;
  if (n > 10) n = 10;
  byId(id + "-htcount").value = String(n);

  cont.innerHTML = "";

  for (let i = 1; i <= n; i++) {
    const box = document.createElement("div");
    box.className = "text-item-block";

    box.innerHTML = `
      <button type="button"
              class="text-item-header"
              onclick="toggleTextItem(this)">
        <div class="text-item-header-left">
          <span class="text-item-drag">‚ãÆ‚ãÆ</span>
          <span class="text-item-title">Texto ${i}</span>
        </div>
        <span class="text-item-chevron"></span>
      </button>

      <div class="text-item-body">
        <div class="data-field-row">


          <div class="data-field-main">
            <div class="text-toolbar-inline">
              <select class="text-toolbar-select"
                      onchange="applyFontSize(this, event)">
                <option value="">Normal</option>
                <option value="10">10</option>
                <option value="12">12</option>
                <option value="14">14</option>
                <option value="16">16</option>
                <option value="18">18</option>
                <option value="20">20</option>
                <option value="22" selected>22</option>
                <option value="24">24</option>
                <option value="28">28</option>
                <option value="32">32</option>
              </select>

              <span class="text-toolbar-separator">|</span>

              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="bold"
                      onmousedown="toolbarCommand(this, event)">
                <b>B</b>
              </button>
              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="italic"
                      onmousedown="toolbarCommand(this, event)">
                <i>K</i>
              </button>
              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="underline"
                      onmousedown="toolbarCommand(this, event)">
                <u>U</u>
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="createLink"
                      onmousedown="toolbarCommand(this, event)">
                üîó
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      onmousedown="applyInlineFormat('insertUnorderedList', event)"
                      title="Vi√±etas">
                <img src="./assets/icons/list-ul.svg"
                     alt="Lista con vi√±etas"
                     class="toolbar-icon-img">
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      onmousedown="applyInlineFormat('insertOrderedList', event)"
                      title="Numeraci√≥n">
                <img src="assets/icons/list-ol.svg"
                     alt="Lista numerada"
                     class="toolbar-icon-img">
              </button>

              <div class="text-color-picker">
                <button type="button"
                        class="text-toolbar-button text-color-btn"
                        title="Color de texto"
                        onmousedown="event.preventDefault(); this.nextElementSibling.click();">
                  <img src="assets/icons/paint-bucket.svg"
                       alt="Color de texto"
                       class="text-color-picker-icon">
                  <span class="text-color-picker-bar"></span>
                </button>

                <input type="color"
                       class="text-toolbar-color"
                       value="#333333"
                       onchange="applyTextColor(this, event)"
                       oninput="updateTextColorBar(this)"
                       onmousedown="event.stopPropagation();">
              </div>

              <select class="text-toolbar-select text-toolbar-lineheight"
                      onchange="applyLineHeight(this, event)"
                      title="Interlineado">
                <option value="">‚Üï</option>
                <option value="1">1.0</option>
                <option value="1.15">1.15</option>
                <option value="1.5">1.5</option>
                <option value="2">2.0</option>
              </select>

              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyLeft"
                      onmousedown="toolbarCommand(this, event)"
                      title="Alinear a la izquierda">
                <span class="icon-align icon-align-left"><span></span></span>
              </button>

              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyCenter"
                      onmousedown="toolbarCommand(this, event)"
                      title="Centrar">
                <span class="icon-align icon-align-center"><span></span></span>
              </button>
              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyRight"
                      onmousedown="toolbarCommand(this, event)"
                      title="Alinear a la derecha">
                <span class="icon-align icon-align-right"><span></span></span>
              </button>
              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyFull"
                      onmousedown="toolbarCommand(this, event)"
                      title="Justificado">
                <span class="icon-align icon-align-justify"><span></span></span>
              </button>
            </div>

            <div id="${id}-htxt${i}"
                 class="rich-textarea empty"
                 contenteditable="true"
                 data-type="rich-text">
            </div>
          </div>

          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-htxt${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-htxt${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>
      </div>
    `;

    cont.appendChild(box);
  }

  refreshSourceSelects();
  restoreModuleFields(snapshot);
}

  function updateHImgCount(id) {
  const raw = (val(id + "-hicount") || "").trim();
  if (raw === "") return;

  let n = parseInt(raw, 10);
  if (isNaN(n) || n < 1) n = 1;
  if (n > 10) n = 10;
  byId(id + "-hicount").value = String(n);

  const cont = byId(id + "-hitems");
  if (!cont) return;
  cont.innerHTML = "";

  for (let i = 1; i <= n; i++) {
    const box = document.createElement("div");
    box.className = "img-item-block";

    box.innerHTML = `
      <button type="button"
              class="img-item-header"
              onclick="toggleImgItem(this)">
        <div class="img-item-header-left">
          <span class="img-item-drag">‚ãÆ‚ãÆ</span>
          <span class="img-item-title">Imagen ${i}</span>
        </div>
        <span class="img-item-chevron"></span>
      </button>

      <div class="img-item-body">
        <div class="data-field-row">
          <label>URL</label>
          <div class="data-field-main">
            <input id="${id}-himg${i}"
                   type="text"
                   placeholder="https://mi-sitio.com/imagen${i}.jpg">
          </div>
          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-himg${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-himg${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>

        <div class="data-field-row">
          <label>Alt</label>
          <div class="data-field-main">
            <input id="${id}-halt${i}"
                   type="text"
                   placeholder="Ejemplo: Foto ${i}">
          </div>
          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-halt${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-halt${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>

        <div class="data-field-row">
          <label>Enlace</label>
          <div class="data-field-main">
            <input id="${id}-hlink${i}"
                   type="text"
                   placeholder="https://mi-sitio.com/destino${i}">
          </div>
          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-hlink${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-hlink${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>
      </div>
    `;

    cont.appendChild(box);
  }

  refreshSourceSelects();
}

  /* ========= RENDER: genera HTML, CSS, JS para inpgs-wrapper ========= */

  function renderAll() {
    let htmlBody = "";
    let css = "";
    let js = ""; // reservado
    let modIndex = 0;

    document.querySelectorAll("#mods > .mod-box").forEach(box => {
      const id = box.id;
      if (!byId(id + "-tipo")) return;

      const tipo = val(id + "-tipo");
      if (!tipo) return;
      modIndex++;

      /* === TEXTO: varios h2 en una sola fila === */
      if (tipo === "texto") {
        const rawCount = (val(id + "-tcount") || "").trim();
        let count = parseInt(rawCount || "1", 10);
        if (isNaN(count) || count < 1) count = 1;
        if (count > 10) count = 10;

        const textos = [];
        for (let i = 1; i <= count; i++) {
          const field = byId(`${id}-txt${i}`);
          if (!field) continue;

          const html = field.innerHTML || "";
          const cleaned = html.replace(/<br\s*\/?>/gi, "").trim();
          if (!cleaned) continue;

          const size = field.dataset.fontSize || '';
          textos.push({ html, size });
        }

        if (textos.length === 0) return;

        const w = clampPct(val(id + "-w"));
        const bg = val(id + "-bg") || "#ffffff";

        let mbUnit = parseInt(val(id + "-mb") || "0", 10);
        if (isNaN(mbUnit) || mbUnit < 0) mbUnit = 0;
        const mb = mbUnit * 5;

        const grpCls = "inpgs-txtgrp-" + modIndex;
        const txtCls = "inpgs-txt-" + modIndex;

        htmlBody += `<div class="${grpCls}">\n`;
        textos.forEach(({ html, size }) => {
          const inner = size
            ? `<span style="font-size:${size}px">${html}</span>`
            : html;

          htmlBody += `  <h2 class="${txtCls}">${inner}</h2>\n`;
        });
        htmlBody += `</div>\n`;

        css += `
.inpgs-wrapper .${grpCls}{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:8px !important;
  width:${w}% !important;
  background:${bg} !important;
  margin:0 0 ${mb}px 0 !important;
  padding:0 !important;
  justify-content:flex-start !important;
  align-items:flex-start !important;
}
.inpgs-wrapper .${txtCls}{
  flex:1 1 0 !important;
  min-width:0 !important;
  margin:0 !important;
  padding:0 !important;
  font-family:inherit !important;
}
`.trim() + "\n\n";
      }

      /* === IM√ÅGENES EN FILA === */
      if (tipo === "imagen") {
        const rawCount = (val(id + "-count") || "").trim();
        let count = parseInt(rawCount || "1", 10);
        if (isNaN(count) || count < 1) count = 1;
        if (count > 10) count = 10;

        const items = [];
        for (let i = 1; i <= count; i++) {
          const sourceSelect = byId(`${id}-img${i}-source`);
          const source = sourceSelect ? sourceSelect.value : 'manual';

          let src = '';

          if (source && source !== 'manual') {
            const excelVal = getExcelValue(source);
            src = (excelVal !== null && excelVal !== undefined) ? String(excelVal) : '';
          } else {
            src = val(`${id}-img${i}`);
          }

          if (!src) continue;

          items.push({
            src,
            alt: val(id + "-alt" + i) || "",
            link: val(id + "-link" + i) || ""
          });
        }

        if (items.length === 0) return;

        const radius = clampPctAllowZero(val(id + "-radius") || "0");
        const align = val(id + "-ialign") || "center";

        // Ancho imagen en %
        const imgWidth = clampPct(val(id + "-isize") || "100");


        let mbUnit = parseInt(val(id + "-mb") || "0", 10);
        if (isNaN(mbUnit) || mbUnit < 0) mbUnit = 0;
        const mb = mbUnit * 5;

        const newTab = false;


        const rowCls = "inpgs-row-" + modIndex;
        const cellCls = rowCls + "__cell";
        const imgCls = rowCls + "__img";


        htmlBody += `<div class="${rowCls}">\n`;
        items.forEach(it => {
          let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
          if (it.link) {
            innerImg = `<a href="${escAttr(it.link)}">${innerImg}</a>`;
          }
          htmlBody += `  <div class="${cellCls}">${innerImg}</div>\n`;
        });
        htmlBody += `</div>\n`;

        const justify =
          align === "left" ? "flex-start" :
            align === "right" ? "flex-end" :
              align === "center" ? "center" : "space-between";

        css += `
  .inpgs-wrapper .${rowCls}{
    display:flex !important;
    flex-wrap:nowrap !important;
    gap:8px !important;
    margin:0 0 ${mb}px 0 !important;
    padding:0 !important;
    align-items:center !important;
    justify-content:${justify} !important;
  }
  .inpgs-wrapper .${cellCls}{
    flex:1 1 0 !important;
    min-width:0 !important;
    text-align:center !important;
  }
  .inpgs-wrapper .${imgCls}{
    width:${imgWidth}% !important;
    max-width:100% !important;
    height:auto !important;
    border-radius:${radius}% !important;
    display:block !important;
    margin:0 auto !important;
    padding:0 !important;
  }
  `.trim() + "\n\n";

      }

      /* === HORIZONTAL: Texto+Imagen === */
      if (tipo === "texto-imagen-h") {
        const leftType = val(id + "-hleft") || "texto";
        const rightType = val(id + "-hright") || "imagen";
        const wLeft = parseInt(val(id + "-wleft") || "50", 10);
        const wRight = parseInt(val(id + "-wright") || "50", 10);
        const bg = val(id + "-hbg") || "#ffffff";

        // TEXTOS
        const rawTextCount = (val(id + "-htcount") || "").trim();
        let textCount = parseInt(rawTextCount || "1", 10);
        if (isNaN(textCount) || textCount < 1) textCount = 1;
        if (textCount > 10) textCount = 10;

        const texts = [];
        for (let i = 1; i <= textCount; i++) {
          const field = byId(id + "-htxt" + i);
          if (!field) continue;

          const html = field.innerHTML || "";
          const cleaned = html.replace(/<br\s*\/?>/gi, "").trim();
          if (!cleaned) continue;

          const size = field.dataset.fontSize || '';
          texts.push({ html, size });
        }

        // IM√ÅGENES
        const rawImgCount = (val(id + "-hicount") || "").trim();
        let imgCount = parseInt(rawImgCount || "1", 10);
        if (isNaN(imgCount) || imgCount < 1) imgCount = 1;
        if (imgCount > 10) imgCount = 10;

        const images = [];
        for (let i = 1; i <= imgCount; i++) {
          const src = val(id + "-himg" + i);
          if (!src) continue;
          images.push({
            src,
            alt: val(id + "-halt" + i) || "",
            link: val(id + "-hlink" + i) || ""
          });
        }

        const imgAlign = val(id + "-hialign") || "center";
        const imgRadius = clampPctAllowZero(val(id + "-hiradius") || "0");
        const imgNewTab = false;

        // ‚úÖ Margen inferior com√∫n del bloque Texto + Imagen
        let mbUnit = parseInt(val(id + "-hmb") || "0", 10);
        if (isNaN(mbUnit) || mbUnit < 0) mbUnit = 0;
        const mb = mbUnit * 5;


        // si no hay nada, no pintamos bloque
        if (texts.length === 0 && images.length === 0) return;

        const containerCls = "inpgs-hcontainer-" + modIndex;
        const leftCls = containerCls + "__left";
        const rightCls = containerCls + "__right";
        const textCls = containerCls + "__text";
        const imgRowCls = containerCls + "__imgrow";
        const imgCellCls = imgRowCls + "__cell";
        const imgCls = imgRowCls + "__img";

        htmlBody += `<div class="${containerCls}">\n`;

        // COLUMNA IZQUIERDA
        htmlBody += `  <div class="${leftCls}">\n`;
        if (leftType === "texto" && texts.length > 0) {
          texts.forEach(({ html, size }) => {
            const inner = size
              ? `<span style="font-size:${size}px">${html}</span>`
              : html;
            htmlBody += `    <h2 class="${textCls}">${inner}</h2>\n`;
          });
        } else if (leftType === "imagen" && images.length > 0) {
          htmlBody += `    <div class="${imgRowCls}">\n`;
          images.forEach(it => {
            let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
            if (it.link) {
              innerImg = `<a href="${escAttr(it.link)}">${innerImg}</a>`;
            }
            htmlBody += `      <div class="${imgCellCls}">${innerImg}</div>\n`;
          });
          htmlBody += `    </div>\n`;
        }
        htmlBody += `  </div>\n`;

        // COLUMNA DERECHA
        htmlBody += `  <div class="${rightCls}">\n`;
        if (rightType === "texto" && texts.length > 0) {
          texts.forEach(({ html, size }) => {
            const inner = size
              ? `<span style="font-size:${size}px">${html}</span>`
              : html;
            htmlBody += `    <h2 class="${textCls}">${inner}</h2>\n`;
          });
        } else if (rightType === "imagen" && images.length > 0) {
          htmlBody += `    <div class="${imgRowCls}">\n`;
          images.forEach(it => {
            let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
            if (it.link) {
              innerImg = `<a href="${escAttr(it.link)}">${innerImg}</a>`;
            }
            htmlBody += `      <div class="${imgCellCls}">${innerImg}</div>\n`;
          });
          htmlBody += `    </div>\n`;
        }
        htmlBody += `  </div>\n`;
        htmlBody += `</div>\n`;

        const imgJustify =
          imgAlign === "left" ? "flex-start" :
            imgAlign === "right" ? "flex-end" :
              imgAlign === "center" ? "center" : "space-between";

        css += `
.inpgs-wrapper .${containerCls}{
  display:flex !important;
  flex-direction:row !important;
  gap:0 !important;
  background:${bg} !important;
  margin:0 0 ${mb}px 0 !important;   
  padding:0 !important;
}
.inpgs-wrapper .${leftCls}{
  width:${wLeft}% !important;
  padding:0 !important;
  display:flex !important;
  flex-direction:column !important;
  justify-content:center !important;
}
.inpgs-wrapper .${rightCls}{
  width:${wRight}% !important;
  padding:0 !important;
  display:flex !important;
  flex-direction:column !important;
  justify-content:center !important;
}
.inpgs-wrapper .${textCls}{
  margin:0 !important;
  padding:0 !important;
  font-family:inherit !important;
}
.inpgs-wrapper .${imgRowCls}{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:8px !important;
  margin:0 !important;
  padding:0 !important;
  align-items:center !important;
  justify-content:${imgJustify} !important;
}
.inpgs-wrapper .${imgCellCls}{
  flex:1 1 0 !important;
  min-width:0 !important;
  text-align:center !important;
}
.inpgs-wrapper .${imgCls}{
  width:100% !important;
  height:auto !important;
  border-radius:${imgRadius}% !important;
  display:block !important;
  padding:0 !important;      
}
`.trim() + "\n\n";

      }

      /* === CUSTOM HTML === */
      if (tipo === "html") {
        const sourceSelect = byId(id + "-htmlcode-source");
        const source = sourceSelect ? sourceSelect.value : 'manual';

        let customHtml = '';

        if (source && source !== 'manual') {
          const excelVal = getExcelValue(source);
          customHtml = excelVal != null ? String(excelVal) : '';

          const ta = byId(id + "-htmlcode");
          if (ta && ta.value !== customHtml) {
            ta.value = customHtml;
          }
        } else {
          customHtml = val(id + "-htmlcode") || '';
        }

        // Por si viene escapado tipo &lt;div&gt;
        customHtml = decodeHtmlIfNeeded(customHtml);

        if (customHtml.trim()) {
          // üîß ac√° se aplica el ‚Äúfixer‚Äù SOLO de sintaxis
          const fixedHtml = fixHtmlFragment(customHtml);

          // Si quieres ver el HTML ya corregido en el textarea, puedes actualizarlo:
          const ta = byId(id + "-htmlcode");
          if (ta && ta.value !== fixedHtml) {
            ta.value = fixedHtml;
          }

          htmlBody += fixedHtml + "\n";
        }
      }


      /* === VIDEO AUTOPLAY === */
      /* === VIDEO AUTOPLAY (flexible: mp4, YouTube, Vimeo, iframe) === */
      if (tipo === "video-autoplay") {
        const sourceSelect = byId(`${id}-video-url-source`);
        const source = sourceSelect ? sourceSelect.value : 'manual';
        let videoInput = '';

        if (source && source !== 'manual') {
          const excelVal = getExcelValue(source);
          videoInput = (excelVal !== null && excelVal !== undefined) ? String(excelVal) : '';
        } else {
          videoInput = val(id + "-video-url");
        }

        if (videoInput) {
          const embed = buildVideoEmbedHTML(videoInput, modIndex);

          htmlBody += `
          <div class="${embed.wrapperClass}">
            ${embed.innerHtml}
          </div>
          `;

          css += `
          .inpgs-wrapper .${embed.wrapperClass}{
            position:relative !important;
            width:100% !important;
            padding-bottom:56.25% !important;
            height:0 !important;
            margin-bottom:16px !important;
          }

          .inpgs-wrapper .${embed.wrapperClass}__iframe{
            position:absolute !important;
            top:0 !important;
            left:0 !important;
            width:100% !important;
            height:100% !important;
            border:none !important;
            object-fit:cover !important;
          }
          `.trim() + "\n\n";
        }
      }


    });

    if (htmlBody.trim() === "") {
      byId("preview").innerHTML = "<div class='muted'>No hay m√≥dulos v√°lidos.</div>";
      byId("htmlOut").value = "";
      byId("cssOut").value = "";
      byId("jsOut").value = "";
      byId("htmlFullOut").value = "";
      return;
    }

    const wrapperStart = `<div class="inpgs-wrapper">`;
    const wrapperEnd = `</div>`;
    const htmlWrapper = wrapperStart + "\n" + htmlBody.trim() + "\n" + wrapperEnd;

const cssWrapper = `
  .inpgs-wrapper{
    font: inherit !important;
    line-height:1.35 !important;   
    padding:0 !important;
    color:inherit !important;    
    font-weight:inherit !important;
  }
  .inpgs-wrapper *,
  .inpgs-wrapper *::before,
  .inpgs-wrapper *::after{
    box-sizing:border-box !important;
    line-height:inherit !important;
  }
  .inpgs-wrapper h1,
  .inpgs-wrapper h2,
  .inpgs-wrapper h3,
  .inpgs-wrapper h4,
  .inpgs-wrapper h5,
  .inpgs-wrapper h6,
  .inpgs-wrapper p,
  .inpgs-wrapper a,
  .inpgs-wrapper li,
  .inpgs-wrapper label,
  .inpgs-wrapper input,
  .inpgs-wrapper textarea,
  .inpgs-wrapper select,
  .inpgs-wrapper button{
    font-size:inherit !important;
    line-height:inherit !important;
  }

  .inpgs-wrapper a,
  .inpgs-wrapper a:link,
  .inpgs-wrapper a:visited {
    color: inherit;
    text-decoration: underline;
  }

  .inpgs-wrapper h1,
  .inpgs-wrapper h2,
  .inpgs-wrapper h3,
  .inpgs-wrapper h4,
  .inpgs-wrapper h5,
  .inpgs-wrapper h6{
    font-weight:400 !important;
  }
  .amp::before{
    content:"\\0026";
  }
`;

    const finalCSS = cssWrapper + css.trim();

    const preview = byId("preview");
    preview.innerHTML = htmlWrapper;

    const fontLinkId = "inpgs-font-link-preview";
    let fontLink = document.getElementById(fontLinkId);
    if (!fontLink) {
      fontLink = document.createElement("link");
      fontLink.id = fontLinkId;
      fontLink.rel = "stylesheet";
      fontLink.href = "https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap";
      document.head.appendChild(fontLink);
    }

    const styleId = "inpgs-style-preview";
    let styleEl = document.getElementById(styleId);
    if (styleEl) styleEl.remove();
    styleEl = document.createElement("style");
    styleEl.id = styleId;
    styleEl.textContent = finalCSS;
    document.head.appendChild(styleEl);

    byId("htmlOut").value = htmlWrapper;
    byId("cssOut").value = finalCSS;
    byId("jsOut").value = js;

    let fullHtml =
      "<style>\n" + finalCSS + "\n</style>\n" +
      htmlWrapper;

    if (js.trim()) {
      fullHtml += "\n<script>\n" + js + "\n</scr" + "ipt>\n";
    }

    fullHtml += '\n<span hidden>CREADOR INPAGE ESPECIALISTA/IA </span>';

    byId("htmlFullOut").value = fullHtml;
  }
  // === NUEVO: helpers para preservar valores al cambiar "Cantidad" ===
  function snapshotModuleFields(container) {
    const data = {};
    if (!container) return data;

    container.querySelectorAll(
      'input[type="text"], input[type="number"], textarea, .rich-textarea, select[data-source-select="1"]'
    ).forEach(function (el) {
      if (!el.id) return;

      const ds = el.dataset || {};

      if (el.classList.contains('rich-textarea')) {
        data[el.id] = {
          type: 'rich',
          html: el.innerHTML,
          fontSize: el.style.fontSize || '',
          dataset: {
            fontSize: ds.fontSize || '',
            excelBound: ds.excelBound || '',
            excelColumn: ds.excelColumn || '',
            excelBaseValue: ds.excelBaseValue || '',
            excelTemplate: ds.excelTemplate || ''
          }
        };
      } else {
        data[el.id] = {
          type: 'input',
          value: el.value,
          readOnly: el.readOnly,
          disabled: el.disabled,
          placeholder: el.placeholder || '',
          dataset: {
            excelBound: ds.excelBound || '',
            excelColumn: ds.excelColumn || ''
          }
        };
      }
    });

    return data;
  }

  function restoreModuleFields(snapshot) {
    if (!snapshot) return;

    Object.keys(snapshot).forEach(function (id) {
      const info = snapshot[id];
      const el = document.getElementById(id);
      if (!el) return;

      if (info.type === 'rich') {
        el.innerHTML = info.html;

        if (info.fontSize) {
          el.style.fontSize = info.fontSize;
        }

        if (info.dataset) {
          if (info.dataset.fontSize) el.dataset.fontSize = info.dataset.fontSize;
          if (info.dataset.excelBound) el.dataset.excelBound = info.dataset.excelBound;
          if (info.dataset.excelColumn) el.dataset.excelColumn = info.dataset.excelColumn;
          if (info.dataset.excelBaseValue) el.dataset.excelBaseValue = info.dataset.excelBaseValue;
          if (info.dataset.excelTemplate) el.dataset.excelTemplate = info.dataset.excelTemplate;
        }

        // volver a marcar empty / no empty
        if (el.innerHTML.replace(/<br\s*\/?>/gi, '').trim() === '') {
          el.classList.add('empty');
        } else {
          el.classList.remove('empty');
        }

      } else { // inputs normales
        el.value = info.value;
        el.readOnly = !!info.readOnly;
        el.disabled = !!info.disabled;
        el.placeholder = info.placeholder || '';

        if (info.dataset) {
          if (info.dataset.excelBound) el.dataset.excelBound = info.dataset.excelBound;
          if (info.dataset.excelColumn) el.dataset.excelColumn = info.dataset.excelColumn;
        }
      }
    });
  }

  /* ========= helpers ========= */

  function togglePreviewMode() {
    const preview = byId("preview");
    const codePanel = byId("export-panel");
    const btn = byId("preview-toggle-btn");

    if (!preview || !codePanel || !btn) return;

    isCodeView = !isCodeView;

    if (isCodeView) {
      // üëâ Modo C√ìDIGO
      preview.style.display = "none";
      codePanel.classList.remove("export-panel--hidden");
      btn.innerHTML = "üëÅ Vista";
      btn.title = "Volver a la vista previa";
    } else {
      // üëâ Modo VISTA PREVIA
      preview.style.display = "";
      codePanel.classList.add("export-panel--hidden");
      btn.innerHTML = "&lt;/&gt; C√≥digo";
      btn.title = "Ver HTML / CSS / JS generados";
    }
  }

  function copyHtmlFinal() {
    const ta = byId("htmlFullOut");
    if (!ta) return;
    const text = ta.value || "";
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(() => { });
    } else {
      ta.select();
      ta.setSelectionRange(0, text.length);
      try { document.execCommand("copy"); } catch (e) { }
    }
  }

  function byId(id) { return document.getElementById(id); }
  function val(id) { const el = byId(id); return el ? el.value : ""; }
  let savedSelection = null;


  function saveSelection() {
    const active = document.activeElement;
    if (active && active.matches('.rich-textarea')) {
      currentEditor = active;
      const sel = window.getSelection();
      if (sel && sel.rangeCount > 0) {
        savedSelection = sel.getRangeAt(0);
      }
    }
  }
  function activateRichEditor(field) {
    if (!field) return;
    field.setAttribute('contenteditable', 'true');
    field.focus();
    try {
      const range = document.createRange();
      range.selectNodeContents(field);
      range.collapse(false); // cursor al final
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      currentEditor = field;
      savedSelection = range;
    } catch (e) {
      // si falla no es grave
    }
  }

  function restoreSelection() {
    if (!savedSelection || !currentEditor) return;
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(savedSelection);
  }

  function refreshToolbarState(editor) {
    if (!editor) return;
    const toolbar = editor.previousElementSibling;
    if (!toolbar) return;
    const buttons = toolbar.querySelectorAll('.text-toolbar-button[data-cmd]');
    buttons.forEach(btn => {
      const cmd = btn.dataset.cmd;
      let state = false;
      try {
        state = document.queryCommandState(cmd);
      } catch (e) { state = false; }
      btn.classList.toggle('active', !!state);
    });
  }

  function toolbarCommand(btn, ev) {
    if (ev) ev.preventDefault();
    restoreSelection();
    if (!currentEditor) return;

    const cmd = btn.dataset.cmd;
    if (!cmd) return;

    if (cmd === 'createLink') {
      const url = prompt('URL del enlace:');
      if (!url) return;
      document.execCommand('createLink', false, url);
    } else {
      document.execCommand(cmd, false, null);
    }

    refreshToolbarState(currentEditor);
  }





  function applyLineHeight(select, ev) {
    if (ev) ev.preventDefault();
    if (!currentEditor) return;
    const lh = select.value;
    currentEditor.style.lineHeight = lh || '';
  }
  function applyInlineFormat(cmd, ev) {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation();
    }

    restoreSelection();
    if (!currentEditor) return;

    document.execCommand(cmd, false, null);

    const btn = ev && ev.currentTarget;
    if (btn && btn.classList) {
      btn.classList.toggle('active');
    }
  }


  // Guardar selecci√≥n cuando se interact√∫a con el editor
  document.addEventListener('mouseup', saveSelection);
  document.addEventListener('keyup', saveSelection);
  document.addEventListener('selectionchange', function () {
    const active = document.activeElement;
    if (active && active.matches('.rich-textarea')) {
      saveSelection();
      refreshToolbarState(active);
    }
  });

  function applyTextColor(input, ev) {
    if (ev) ev.preventDefault();
    restoreSelection();
    if (!currentEditor || !input.value) return;
    document.execCommand('foreColor', false, input.value);
    refreshToolbarState(currentEditor);
  }

  function applyFontSize(select, ev) {
    if (ev) ev.preventDefault();

    // buscamos el editor (rich-textarea) que vive junto a este select
    const dataFieldMain = select.closest('.data-field-main');
    if (!dataFieldMain) return;

    const editor = dataFieldMain.querySelector('.rich-textarea');
    if (!editor) return;

    const px = select.value; // "" o "10", "12", "14", etc.

    if (!px) {
      // "Normal": volvemos al tama√±o base (heredado)
      editor.style.fontSize = '';
      delete editor.dataset.fontSize;
    } else {
      // guardamos el tama√±o en el editor y lo aplicamos visualmente
      editor.style.fontSize = px + 'px';
      editor.dataset.fontSize = px;
    }

    // opcional: si quieres devolverle el foco al editor:
    // editor.focus();
  }

  function applyCreateLink(ev) {
    if (ev) ev.preventDefault();
    restoreSelection();
    const url = prompt('URL del enlace:');
    if (!url) return;
    document.execCommand('createLink', false, url);
  }



  function clampPct(v) {
    const n = parseInt(v || "100", 10);
    if (isNaN(n)) return 100;
    return Math.min(100, Math.max(10, n));
  }

  function clampPctAllowZero(v) {
    const n = parseInt(v || "0", 10);
    if (isNaN(n)) return 0;
    return Math.min(100, Math.max(0, n));
  }
  function escHTML(s) {
    return (s || "").replace(/[&<>]/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m]));
  }
  function escAttr(s) {
    return (s || "").replace(/"/g, "&quot;");
  }
  function decodeHtmlIfNeeded(str) {
    if (!str || typeof str !== 'string') return '';

    // Si no parece HTML escapado, lo dejamos tal cual
    if (!str.includes('&lt;') && !str.includes('&gt;') && !str.includes('&amp;')) {
      return str;
    }

    const txt = document.createElement('textarea');
    txt.innerHTML = str;
    return txt.value;
  }
  function buildVideoEmbedHTML(raw, modIndex) {
    const wrapperClass = `inpgs-video-${modIndex}`;
    const baseIframeClass = `${wrapperClass}__iframe`;
    const value = (raw || '').trim();

    // 1) Si viene un <iframe> pegado
    if (/^<iframe[\s\S]*<\/iframe>$/i.test(value) || value.toLowerCase().includes('<iframe')) {
      // Intentamos extraer el src; si no, dejamos el iframe tal cual dentro del wrapper
      const srcMatch = value.match(/src=["']([^"']+)["']/i);
      if (srcMatch && srcMatch[1]) {
        const src = escAttr(srcMatch[1]);
        const iframeHtml =
          `<iframe class="${baseIframeClass}" src="${src}"` +
          ` frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"` +
          ` allowfullscreen loading="lazy"></iframe>`;
        return { wrapperClass, innerHtml: iframeHtml };
      }

      // fallback: si no encontramos src, devolvemos el iframe original
      return { wrapperClass, innerHtml: value };
    }

    // 2) YouTube: watch, youtu.be o embed
    const ytMatch = value.match(
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtube\.com\/embed\/|youtu\.be\/)([a-zA-Z0-9_-]{6,})/
    );
    if (ytMatch && ytMatch[1]) {
      const id = ytMatch[1];
      const embedUrl =
        `https://www.youtube.com/embed/${id}` +
        `?autoplay=1&mute=1&playsinline=1&loop=1&playlist=${id}&rel=0&showinfo=0`;

      const iframeHtml =
        `<iframe class="${baseIframeClass}" src="${escAttr(embedUrl)}"` +
        ` frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"` +
        ` allowfullscreen loading="lazy"></iframe>`;
      return { wrapperClass, innerHtml: iframeHtml };
    }

    // 3) Vimeo
    const vimeoMatch = value.match(
      /(?:https?:\/\/)?(?:www\.)?(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)/
    );
    if (vimeoMatch && vimeoMatch[1]) {
      const id = vimeoMatch[1];
      const embedUrl =
        `https://player.vimeo.com/video/${id}` +
        `?autoplay=1&muted=1&loop=1&title=0&byline=0&portrait=0`;

      const iframeHtml =
        `<iframe class="${baseIframeClass}" src="${escAttr(embedUrl)}"` +
        ` frameborder="0" allow="autoplay; fullscreen; picture-in-picture"` +
        ` allowfullscreen loading="lazy"></iframe>`;
      return { wrapperClass, innerHtml: iframeHtml };
    }

    // 4) Default: asumimos que es URL directa a v√≠deo (mp4, webm, etc.)
    const escUrl = escAttr(value);
    const videoHtml =
      `<video class="${baseIframeClass}" src="${escUrl}"` +
      ` autoplay muted playsinline loop controls></video>`;
    return { wrapperClass, innerHtml: videoHtml };
  }

  function fixHtmlFragment(input) {
    if (!input || typeof input !== 'string') return '';

    // El navegador parsea y ‚Äúcierra‚Äù lo que est√© roto
    const container = document.createElement('div');
    container.innerHTML = input;

    // No se elimina nada: ni <script>, ni onClick, ni nada.
    return container.innerHTML;
  }

  /* ========= color sync ========= */
  function syncHex(colorInput, textId) {
    const txt = document.getElementById(textId);
    if (txt) txt.value = colorInput.value;
  }
  function syncColor(textInput, colorId) {
    const col = document.getElementById(colorId);
    let val = textInput.value;
    if (!val.startsWith("#")) val = "#" + val;
    if (/^#[0-9A-F]{6}$/i.test(val)) {
      if (col) col.value = val;
    }
  }
  /* ========= Drag and Drop ========= */
  let draggedItem = null;

  function collapseAll() {
    document.querySelectorAll(".mod-box").forEach(b => {
      b.classList.add("collapsed");
    });
  }

  function toggleSection(headerBtn) {
    const section = headerBtn.closest('.mod-section');
    if (!section) return;
    section.classList.toggle('mod-section--collapsed');
  }

  function toggleImgItem(headerBtn) {
    const item = headerBtn.closest('.img-item-block');
    if (!item) return;
    item.classList.toggle('img-item--collapsed');
  }
  function toggleTextItem(headerBtn) {
    const item = headerBtn.closest('.text-item-block');
    if (!item) return;
    item.classList.toggle('text-item--collapsed');
  }

  function dragStart(e, id) {
    draggedItem = document.getElementById(id);
    if (!draggedItem) return;

    // opcional: seguir colapsando todo al arrastrar
    collapseAll();

    draggedItem.classList.add("dragging");

    // necesario para que el drag funcione en todos los navegadores
    if (e.dataTransfer) {
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", id);
    }
  }

  function dragOver(e) {
    e.preventDefault(); // sin esto no se permite soltar
    if (!draggedItem) return;

    const container = document.getElementById("mods");
    if (!container) return;

    const afterElement = getDragAfterElement(container, e.clientY);

    if (!afterElement) {
      // si estoy debajo de todo, lo mando al final
      container.appendChild(draggedItem);
    } else {
      // si estoy sobre alg√∫n bloque, lo inserto antes de ese bloque
      container.insertBefore(draggedItem, afterElement);
    }
  }

  function drop(e) {
    e.preventDefault();
    if (!draggedItem) return;

    draggedItem.classList.remove("dragging");
    draggedItem = null;

    updatePositions();
    // si quieres que la vista previa se actualice al reordenar:
    renderAll();
  }

  function dragEnd(e) {
    // por si el drop se hace fuera del contenedor
    if (draggedItem) {
      draggedItem.classList.remove("dragging");
      draggedItem = null;
      updatePositions();
      // renderAll();
    }
  }

  // calcula delante de qu√© bloque soltar seg√∫n la posici√≥n Y del mouse
  function getDragAfterElement(container, y) {
    const draggableElements = [
      ...container.querySelectorAll(".mod-box:not(.dragging)")
    ];

    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

    draggableElements.forEach(child => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;

      // offset < 0  ‚Üí el mouse est√° por encima del centro del bloque
      // elegimos el m√°s cercano a 0 (pero negativo)
      if (offset < 0 && offset > closest.offset) {
        closest = { offset, element: child };
      }
    });

    return closest.element;
  }



  document.addEventListener('input', function (e) {
    const el = e.target;

    if (el.matches('.rich-textarea')) {
      if (el.innerHTML.replace(/<br\s*\/?>/gi, '').trim() === '') {
        el.classList.add('empty');
      } else {
        el.classList.remove('empty');
      }

      // si est√° ligado a Excel, actualizamos la plantilla de estilos
      if (el.dataset && el.dataset.excelBound === '1') {
        const base = el.dataset.excelBaseValue || '';
        if (base) {
          const html = el.innerHTML;
          const placeholder = '__EXCEL_VALUE__';
          const template = html.split(base).join(placeholder);
          el.dataset.excelTemplate = template;
        }
      }
    }

    // si el input pertenece a los bloques (#mods), actualizamos la vista previa
    if (el.closest && el.closest('#mods')) {
      scheduleRender();
    }
  });


document.addEventListener('change', function (e) {
  const el = e.target;
  if (!el || !el.closest || !el.closest('#mods')) return;
  scheduleRender();
});



  function updateTextColorBar(input) {
    const picker = input.closest('.text-color-picker');
    if (!picker) return;
    const bar = picker.querySelector('.text-color-picker-bar');
    if (!bar) return;
    bar.style.background = input.value || '#111827';
  }
  // Bloquear edici√≥n manual del texto cuando viene de Excel,
  // pero seguir permitiendo selecci√≥n + estilos desde la barra.
  document.addEventListener('keydown', function (e) {
    const el = e.target;
    if (!el || !el.matches('.rich-textarea')) return;
    if (!el.dataset || el.dataset.excelBound !== '1') return;

    const key = e.key;

    // teclas que s√≠ permitimos aunque venga de Excel (mover cursor, etc.)
    const allowedNonChar = [
      'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
      'Home', 'End', 'PageUp', 'PageDown',
      'Shift', 'Control', 'Alt', 'Meta', 'Tab', 'Escape'
    ];

    const isChar = key.length === 1; // cualquier letra/n√∫mero/signo
    const isDeleteKey = (key === 'Backspace' || 'Delete' || 'Enter');

    // si es car√°cter o borrado, y no viene con Ctrl/Meta/Alt ‚Üí lo bloqueamos
    if (
      (!e.ctrlKey && !e.metaKey && !e.altKey) &&
      (isChar || isDeleteKey) &&
      !allowedNonChar.includes(key)
    ) {
      e.preventDefault();
    }
  });

  document.addEventListener('paste', function (e) {
    const el = e.target;
    if (!el || !el.classList || !el.classList.contains('rich-textarea')) return;

    const fieldId = el.id;
    const sourceSelect = byId(fieldId + '-source');
    if (!sourceSelect) return;

    const source = sourceSelect.value;
    if (!source || source === 'manual') return;

    // datos desde Excel: no dejamos pegar texto encima
    e.preventDefault();
  });

</script>