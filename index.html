<!DOCTYPE html>
<div style="display:flex; align-items:center; justify-content:space-between; padding:12px;">
  <h2 style="flex:1; text-align:center; margin:0;">Constructor de Inpages</h2>
  <div style="width:150px;"></div> <!-- Spacer for centering -->
</div>

<div style="display:flex;gap:12px;padding:12px;align-items:flex-start;">
  <!--  Columna izquierda: m√≥dulos  -->
  <div style="flex:2;max-width:60%;">
    <div
      style="margin-bottom:10px; display:flex; justify-content:flex-start; gap:8px; align-items:center; flex-wrap:wrap;">
      <button onclick="collapseAll()"
        style="padding:5px 10px;background:#64748b;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:12px;">
        Contraer todo
      </button>
      <label
        style="padding:5px 10px;background:#10b981;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;gap:6px;">
        <img src="assets/icons/upload.svg" alt="Subir Excel" style="width:14px;height:14px;">
        Cargar Excel
        <input type="file" id="global-excel-upload" accept=".xlsx,.xls" style="display:none;"
          onchange="handleGlobalExcelUpload(event)">
      </label>

      <!-- Row selector (hidden initially) -->
      <div id="excel-row-selector-container" style="display:none; align-items:center; gap:6px;">
        <label style="font-size:12px; color:#444;">Fila a visualizar:</label>
        <select id="excel-row-selector" onchange="handleRowChange()"
          style="padding:4px 8px; border:1px solid #ccc; border-radius:4px; font-size:12px;">
        </select>

      </div>

      <!-- Generate all button (hidden initially) -->
      <button id="generate-all-btn" onclick="generateAllHTML()"
        style="display:none; padding:5px 10px; background:#10b981; color:#fff; border:0; border-radius:4px; cursor:pointer; font-size:12px; align-items:center; gap:6px;">
        <img src="assets/icons/download.svg" alt="Descargar Excel" style="width:14px;height:14px;">
        Descargar Excel
      </button>

    </div>
    <div id="mods" ondragover="dragOver(event)" ondrop="drop(event)"></div>

    <div style="display:flex;gap:8px;margin-top:8px;">
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <button onclick="addMod()"
          style="padding:8px 12px;background:#3498db;color:#fff;border:0;border-radius:6px;cursor:pointer;">
          Agregar Bloque
        </button>
        <button onclick="renderAll()"
          style="padding:8px 12px; background:#10b981; color:#fff; border:0; border-radius:6px; cursor:pointer;">
          Generar vista
        </button>
      </div>

    </div>
  </div>

  <!-- Columna derecha: vista + export -->
  <div
    style="flex:1;background:#fff;padding:12px;border-radius:8px;box-shadow:0 0 8px rgba(0,0,0,.06);max-height:90vh;overflow:auto;position:sticky;top:12px;">
    <div style="margin-bottom:12px;">
      <button onclick="renderAll()"
        style="padding:6px 12px; background:#10b981; color:#fff; border:0; border-radius:6px; cursor:pointer; font-size:13px;">
        Generar vista
      </button>
    </div>
    <h3 style="margin-top:0;">Vista previa</h3>
    <div id="preview" style="border:1px dashed #ddd;border-radius:6px;padding:10px;min-height:80px;"></div>

    <button type="button" onclick="toggleExportPanel()"
      style="margin-top:10px;padding:6px 10px;background:#e5e7eb;border:0;border-radius:6px;cursor:pointer;font-size:13px;">
      Mostrar / ocultar c√≥digo (HTML / CSS / JS)
    </button>

    <div id="export-panel" style="display:none;margin-top:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
        <h3 style="margin:0;">HTML final (snippet listo para pegar)</h3>
        <button type="button" onclick="copyHtmlFinal()"
          style="padding:4px 8px;background:#4b5563;color:#fff;border:0;border-radius:6px;cursor:pointer;font-size:12px;">
          Copiar HTML
        </button>
      </div>
      <textarea id="htmlFullOut" rows="6" readonly
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></textarea>

      <h3 style="margin-top:12px;">HTML (solo wrapper)</h3>
      <textarea id="htmlOut" rows="5" readonly
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>

      <h3 style="margin-top:12px;">CSS (m√≥dulos inpgs)</h3>
      <textarea id="cssOut" rows="6" readonly
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>

      <h3 style="margin-top:12px;">JS (si lo hubiera)</h3>
      <textarea id="jsOut" rows="3" readonly
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>
    </div>
  </div>
</div>

<style>
  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f4f4;
  }

  .mod-box {
    background: #fff;
    padding: 8px 12px;
    margin: 8px 0;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0, 0, 0, .06);
  }

  .mod-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    cursor: default;
  }

  .mod-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .mod-header h4 {
    margin: 0;
    font-size: 14px;
  }

  .muted {
    font-size: 12px;
    color: #666;
  }

  select,
  input[type="text"],
  input[type="number"],
  textarea {
    width: 100%;
    padding: 6px;
    margin: 4px 0 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 13px;
  }

  label {
    font-size: 12px;
    color: #444;
    font-weight: 600;
    display: block;
    margin-bottom: 2px;
  }

  .row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .checks {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 12px;
    margin-top: 8px;
  }

  .checks label {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: normal;
    cursor: pointer;
  }

  .mod-body {
    margin-top: 6px;
  }

  .params-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
    margin-bottom: 8px;
  }

  .param-item {
    display: flex;
    flex-direction: column;
  }

  .param-item label {
    margin-bottom: 2px;
    font-size: 11px;
    color: #555;
  }

  .param-item select,
  .param-item input[type="text"],
  .param-item input[type="number"] {
    margin: 0;
    width: auto;
    max-width: 100px;
    padding: 4px;
    font-size: 12px;
  }

  input[type="color"].mini-color {
    width: 24px;
    height: 24px;
    padding: 0;
    border: 1px solid #ccc;
    background: none;
    cursor: pointer;
    border-radius: 4px;
    overflow: hidden;
    vertical-align: bottom;
  }

  input[type="color"].mini-color::-webkit-color-swatch-wrapper {
    padding: 0;
  }

  input[type="color"].mini-color::-webkit-color-swatch {
    border: none;
    border-radius: 3px;
  }


  .text-toolbar-lineheight {
    max-width: 64px;
  }

  .text-toolbar-select:focus,
  .text-toolbar-button:focus {
    outline: 1px solid #2563eb;
    outline-offset: 1px;
  }


  .text-toolbar-color {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
    border: 0;
    padding: 0;
    margin: 0;
    pointer-events: none;
  }

  .text-color-picker {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .text-color-btn {
    padding: 2px 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .text-color-picker-icon {
    width: 14px;
    height: 14px;
    display: block;
  }

  .text-color-picker-bar {
    width: 14px;
    height: 3px;
    border-radius: 2px;
    background: #333333;
  }


  .icon-align {
    width: 16px;
    height: 12px;
    position: relative;
    display: inline-block;
  }

  .icon-align-left::before {
    top: 0;
    left: 0;
    width: 16px;
  }

  .icon-align-left::after {
    top: 5px;
    left: 0;
    width: 12px;
  }

  .icon-align-left span {
    top: 10px;
    left: 0;
    width: 8px;
  }

  .icon-align-center::before {
    top: 0;
    left: 50%;
    width: 16px;
    transform: translateX(-50%);
  }

  .icon-align-center::after {
    top: 5px;
    left: 50%;
    width: 12px;
    transform: translateX(-50%);
  }

  .icon-align-center span {
    top: 10px;
    left: 50%;
    width: 16px;
    transform: translateX(-50%);
  }

  .icon-align-right::before {
    top: 0;
    right: 0;
    width: 16px;
  }

  .icon-align-right::after {
    top: 5px;
    right: 0;
    width: 12px;
  }

  .icon-align-right span {
    top: 10px;
    right: 0;
    width: 8px;
  }

  .icon-align-justify::before {
    top: 0;
    left: 0;
    right: 0;
  }

  .icon-align-justify::after {
    top: 5px;
    left: 0;
    right: 0;
  }

  .icon-align-justify span {
    top: 10px;
    left: 0;
    right: 0;
  }

  .rich-textarea {
    min-height: 40px;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 6px;
    font-size: 22px;
    background: #fff;
    overflow-y: auto;
    color: #333333;
    font-weight: 400;
  }



  .rich-textarea.excel-bound {
    background: #f3f4f6;
    cursor: default;
  }

  .text-toolbar-inline.excel-bound-toolbar {
    opacity: 0.4;
    pointer-events: none;
  }

  .rich-textarea.empty::before {
    content: "Ingresa el texto...";
    color: #9ca3af;
  }

  .icon-paint-bucket {
    position: relative;
    width: 16px;
    height: 16px;
    display: inline-block;
  }

  .text-toolbar-inline {
    display: flex;
    align-items: center;
    gap: 4px;
    margin: 4px 0;
    font-size: 12px;
    background: #f9fafb;
    border-radius: 4px;
    padding: 4px 6px;
    border: 1px solid #e5e7eb;
  }

  .text-toolbar-button {
    border: 1px solid transparent;
    border-radius: 3px;
    padding: 2px 4px;
    background: transparent;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
    color: #374151;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .text-toolbar-button:hover {
    background: #e5e7eb;
  }

  .text-toolbar-button.active {
    background: #d1d5db;
    border-color: #9ca3af;
    color: #111827;
  }

  .text-toolbar-select,
  .text-toolbar-lineheight {
    border-radius: 4px;
    padding: 0 4px;
    height: 22px;
    font-size: 11px;
    background: #ffffff;
    color: #111827;
    border: 1px solid #d1d5db;
  }

  .text-toolbar-select {
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 0 4px;
    height: 22px;
    font-size: 11px;
    background: #f9fafb;
    max-width: 80px;
  }

  /* Separador visual */
  .text-toolbar-separator {
    color: #9ca3af;
    padding: 0 2px;
  }

  .icon-align::before,
  .icon-align::after,
  .icon-align span {
    content: "";
    position: absolute;
    height: 2px;
    border-radius: 1px;
    background: #4b5563;
  }


  .icon-list {
    width: 18px;
    height: 16px;
    position: relative;
    display: inline-block;
  }

  .icon-list-bullets::before,
  .icon-list-bullets::after {
    content: "";
    position: absolute;
    border-radius: 9999px;
  }

  .icon-list-bullets::before {
    left: 2px;
    top: 2px;
    width: 4px;
    height: 4px;
    background: #343E49;
    box-shadow:
      0 5px 0 #343E49,
      0 10px 0 #343E49;
  }

  .icon-list-bullets::after {
    left: 9px;
    right: 1px;
    top: 3px;
    height: 2px;
    border-radius: 1px;
    background: #343E49;
    box-shadow:
      0 5px 0 #343E49,
      0 10px 0 #343E49;
  }

  .icon-ordered-list {
    display: inline-flex;
    flex-direction: column;
    justify-content: space-between;
    width: 14px;
    height: 10px;
    font-size: 0;
  }

  .icon-ordered-list-item {
    display: flex;
    align-items: center;
    flex: 1 0 0;
  }

  .icon-ordered-list-num {
    font-size: 6px;
    font-weight: 700;
    color: #343E49;
    margin-right: 1px;
    line-height: 1;
    width: 4px;
    text-align: right;
  }

  .icon-ordered-list-line {
    flex-grow: 1;
    height: 1px;
    background-color: #343E49;
    border-radius: 1px;
  }


  .icon-paint-bucket::before {
    border: 2px solid #000000;
  }

  .icon-paint-bucket::after {
    background: #2563eb;
  }

  .icon-paint-bucket::before,
  .icon-paint-bucket::after {
    content: "";
    position: absolute;
  }

  .icon-paint-bucket::before {
    width: 10px;
    height: 8px;
    left: 3px;
    top: 3px;
    border: 2px solid #000;
    border-bottom-left-radius: 2px;
    border-bottom-right-radius: 2px;
  }

  .icon-paint-bucket::after {
    width: 4px;
    height: 6px;
    left: 10px;
    top: 10px;
    border-radius: 9999px;
    background: #2563eb;
  }

  .toolbar-icon-img {
    width: 16px;
    height: 16px;
    display: block;
    object-fit: contain;
    pointer-events: none;
    transform: scale(1.2);

  }





  .img-field-row label {
    width: 70px;
    font-size: 11px;
    color: #444;
    display: block;
    margin-bottom: 0;
  }

  .img-field-row input[type="text"] {
    flex: 1;
    padding: 4px 6px;
    font-size: 11px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin: 0;
  }



  .source-compact-img select {
    padding: 2px 4px;
    font-size: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    margin: 0;
    max-width: 120px;
  }

  .data-field-row {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
  }

  .data-field-row>label {
    width: 70px;
    font-size: 11px;
    color: #444;
    margin-bottom: 0;
    flex-shrink: 0;
  }

  .data-field-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .data-field-main input[type="text"],
  .data-field-main textarea {
    width: 100%;
    padding: 4px 6px;
    font-size: 11px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin: 0;
    box-sizing: border-box;
  }

  .source-compact {
    display: inline-flex;
    align-items: center;
  }

  .source-compact select {
    padding: 2px 4px;
    font-size: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    margin: 0;
    max-width: 120px;
  }

  .img-item-block {
    margin-bottom: 10px;
    padding: 8px;
    background: #f9fafb;
    border-radius: 6px;
  }

  .mod-box.dragging {
    opacity: 0.5;
  }
</style>

<!-- SheetJS for Excel processing -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
  let modCount = 0;

  let globalExcelData = {
    columns: [],
    rows: [],
    fileName: ""
  };
  let currentRenderRowIndex = null;

  let currentEditor = null;

  function isExcelLoaded() {
    return Array.isArray(globalExcelData.columns) && globalExcelData.columns.length > 0;
  }


  function refreshSourceSelects() {
    const hasExcel = isExcelLoaded();
    const selects = document.querySelectorAll('select[data-source-select="1"]');
    const wrappers = document.querySelectorAll('[data-source-wrapper="1"]');

    // Mostrar / ocultar el bloque completo "Fuente de datos"
    wrappers.forEach(w => {
      w.style.display = hasExcel ? '' : 'none';
    });

    // Refrescar selects
    selects.forEach(sel => {
      const previousValue = sel.value || 'manual';

      // Reconstruimos opciones seg√∫n el Excel actual
      sel.innerHTML = getColumnOptions();

      if (hasExcel && Array.from(sel.options).some(o => o.value === previousValue)) {
        sel.value = previousValue;
      } else {
        sel.value = 'manual';
      }

      sel.disabled = !hasExcel;
      sel.title = hasExcel
        ? 'Selecciona columna del Excel'
        : 'Carga un Excel para activar esta opci√≥n';
    });
  }

  /* ========= GLOBAL EXCEL UPLOAD ========= */
  function handleGlobalExcelUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    console.log('Archivo cargado:', file.name);
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (!jsonData || jsonData.length === 0) {
          alert('El archivo parece estar vac√≠o.');
          return;
        }
        // Extract column names
        globalExcelData.columns = Object.keys(jsonData[0]);
        globalExcelData.rows = jsonData;
        globalExcelData.fileName = file.name;

        alert(
          `Excel cargado exitosamente!\n\nColumnas detectadas:\n${globalExcelData.columns.join(', ')}\n\nFilas: ${globalExcelData.rows.length}`
        );

        // Row selector
        populateRowSelector();

        // Mostrar selector y bot√≥n generar
        const selectorContainer = byId('excel-row-selector-container');
        const generateBtn = byId('generate-all-btn');
        if (selectorContainer) selectorContainer.style.display = 'flex';
        if (generateBtn) generateBtn.style.display = 'inline-flex';

        // Habilitar selects de fuente de datos
        refreshSourceSelects();

        // üîÑ Muy importante: refrescar campos ya vinculados (si es que hay)
        refreshBoundFieldsForCurrentRow();

        // Render inicial con la fila seleccionada
        renderAll();
      } catch (err) {
        console.error(err);
        alert('Error al leer el archivo: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function populateRowSelector() {
    const selector = byId('excel-row-selector');
    if (!selector) return;
    selector.innerHTML = '';
    const firstCol = globalExcelData.columns[0];
    globalExcelData.rows.forEach((row, index) => {
      const opt = document.createElement('option');
      opt.value = index;
      opt.textContent = `${row[firstCol]} (Fila ${index + 1})`;
      selector.appendChild(opt);
    });
  }

  function getColumnOptions() {
    if (!globalExcelData.columns || globalExcelData.columns.length === 0) {
      return '<option value="manual">Valor manual</option>';
    }

    let options = '<option value="manual">Valor manual</option>';
    globalExcelData.columns.forEach(col => {
      options += `<option value="${col}">${col}</option>`;
    });
    return options;
  }

  function getCurrentRowIndex() {
    if (!globalExcelData.rows || !globalExcelData.rows.length) return 0;

    // generaci√≥n masiva (generateAllHTML)
    if (currentRenderRowIndex !== null) {
      return currentRenderRowIndex;
    }

    // modo vista previa normal
    const rowSelector = byId('excel-row-selector');
    const idx = rowSelector ? parseInt(rowSelector.value || '0', 10) : 0;
    return isNaN(idx) ? 0 : idx;
  }

  function refreshBoundFieldsForCurrentRow() {
    if (!globalExcelData.rows || !globalExcelData.rows.length) return;

    const rowIndex = getCurrentRowIndex();
    const row = globalExcelData.rows[rowIndex] || {};

    document.querySelectorAll('[data-excel-bound="1"]').forEach(field => {
      const col = field.dataset.excelColumn;
      if (!col) return;

      const raw = row[col];
      const value = (raw !== undefined && raw !== null) ? String(raw) : '';

      const isRich = field.classList && field.classList.contains('rich-textarea');

      if (isRich) {
        field.setAttribute('contenteditable', 'true');

        const base = field.dataset.excelBaseValue || '';
        const tpl = field.dataset.excelTemplate || '';

        let newHtml;

        if (tpl && tpl.indexOf('__EXCEL_VALUE__') !== -1) {
          // ya tenemos plantilla con placeholder
          newHtml = tpl.split('__EXCEL_VALUE__').join(value);
        } else if (base && field.innerHTML && field.innerHTML.indexOf(base) !== -1) {
          // generamos plantilla reemplazando el viejo valor por placeholder
          const currentHtml = field.innerHTML;
          const template = currentHtml.split(base).join('__EXCEL_VALUE__');
          field.dataset.excelTemplate = template;
          newHtml = template.split('__EXCEL_VALUE__').join(value);
        } else {
          // sin estilos definidos todav√≠a: usamos el valor plano
          newHtml = value;
          field.dataset.excelTemplate = value;
        }

        field.innerHTML = newHtml;
        field.dataset.excelBaseValue = value;

        field.classList.toggle(
          'empty',
          value.replace(/<br\s*\/?>/gi, '').trim() === ''
        );
      } else if ('value' in field) {
        const wasReadOnly = !!field.readOnly;
        field.readOnly = false;
        field.value = value;
        field.readOnly = wasReadOnly;
      } else {
        field.textContent = value;
      }
    });
  }

  function handleRowChange() {
    // 1) actualiza los campos del bloque con los datos de la fila seleccionada
    refreshBoundFieldsForCurrentRow();
    // 2) vuelve a generar la vista con esos datos
    renderAll();
  }



  function getExcelValue(columnName) {
    if (!columnName || columnName === 'manual' || !globalExcelData.rows.length) {
      return null;
    }

    const rowIndex = getCurrentRowIndex();
    const row = globalExcelData.rows[rowIndex] || {};
    const value = row[columnName];

    return (value !== undefined && value !== null) ? value : '';
  }



  function generateAllHTML() {
    if (!globalExcelData.rows.length) {
      alert('Primero carga un archivo Excel');
      return;
    }

    const results = [];
    const firstCol = globalExcelData.columns[0];

    // Guardamos la fila actualmente seleccionada en el selector (para restaurar la vista)
    const rowSelector = byId('excel-row-selector');
    const originalRowIndex = rowSelector ? parseInt(rowSelector.value || '0', 10) : 0;

    globalExcelData.rows.forEach((row, index) => {
      // Forzamos que todas las lecturas desde Excel apunten a ESTA fila
      currentRenderRowIndex = index;

      // Actualiza todos los campos ligados a Excel (texto, urls, alt, links, etc.)
      refreshBoundFieldsForCurrentRow();

      // Render con los datos de esta fila
      renderAll();

      const html = byId('htmlFullOut').value;

      results.push({
        [firstCol]: row[firstCol],
        HTML: html
      });
    });


    // Volvemos a modo normal (vista atada al selector visual)
    currentRenderRowIndex = null;
    if (rowSelector) {
      rowSelector.value = originalRowIndex;
      renderAll(); // restaurar la preview a la fila que estaba elegida
    }

    // Descargar Excel con resultados
    const ws = XLSX.utils.json_to_sheet(results);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'HTMLs Generados');
    XLSX.writeFile(wb, 'inpages_generados.xlsx');
    alert(`¬°Listo! Se generaron ${results.length} HTMLs y se descarg√≥ el archivo Excel.`);
  }

  /* ========= creaci√≥n / inserci√≥n / orden ========= */

  function addMod() {
    addModAt("end", null);
  }

  function addModAt(where, refId) {
    modCount++;
    const id = "mod_" + modCount;
    const box = createModuleBox(id, modCount);
    const container = document.getElementById("mods");

    if (!where || where === "end" || !refId) {
      container.appendChild(box);
      return;
    }

    const ref = document.getElementById(refId);
    if (!ref) {
      container.appendChild(box);
      return;
    }

    if (where === "before") {
      container.insertBefore(box, ref);
    } else if (where === "after") {
      container.insertBefore(box, ref.nextSibling);
    } else {
      container.appendChild(box);
    }
    updatePositions();
  }

  function updatePositions() {
    const container = document.getElementById("mods");
    if (!container) return;
    // Only select direct children to avoid nested .mod-box elements
    const boxes = Array.from(container.children).filter(el => el.classList.contains("mod-box"));
    boxes.forEach((box, i) => {
      const posLabel = box.querySelector(".mod-pos");
      if (posLabel) posLabel.textContent = "Posici√≥n " + (i + 1);
    });
  }

  function createModuleBox(id, index) {
    const box = document.createElement("div");
    box.className = "mod-box";
    box.id = id;
    // Keep ondragover and ondrop on the box for drop target functionality
    box.ondragover = (e) => dragOver(e);
    box.ondrop = (e) => drop(e, id);

    box.innerHTML = `
      <div class="mod-header" draggable="true" 
           ondragstart="dragStart(event, '${id}')" 
           ondragend="dragEnd(event)"
           style="cursor:grab;">
        <div class="mod-header-left">
          <span style="font-size:16px;color:#999;margin-right:4px;" title="Arrastrar para mover">‚ò∞</span>
          <button type="button" onclick="toggleBody('${id}');event.stopPropagation();" style="padding:3px 6px;background:#e5e7eb;border:0;border-radius:4px;cursor:pointer;font-size:11px;">Mostrar / ocultar</button>
          <h4>Bloque ${index} <span class="mod-pos" style="font-size:11px;font-weight:normal;color:#666;margin-left:6px;">Posici√≥n ${index}</span></h4>
        </div>
        <div style="display:flex;gap:4px;align-items:center;">
          <button type="button" onclick="moveMod('${id}','up');event.stopPropagation();" style="padding:3px 6px;border:0;border-radius:4px;cursor:pointer;font-size:11px;">‚Üë</button>
          <button type="button" onclick="moveMod('${id}','down');event.stopPropagation();" style="padding:3px 6px;border:0;border-radius:4px;cursor:pointer;font-size:11px;">‚Üì</button>
          <button
            type="button"
            onclick="removeMod('${id}')"
            style="padding:4px 6px;border:0;border-radius:6px;cursor:pointer;font-size:0;background:transparent;"
            title="Eliminar bloque">
            <img
              src="assets/icons/trash.svg"
              alt="Eliminar bloque"
              class="toolbar-icon-img">
          </button>        
        </div>
      </div>

      <div class="mod-body" id="${id}-body">
        <label>Seleccionar M√≥dulo</label>
        <select id="${id}-tipo" onchange="renderInputs('${id}')">
          <option value="texto" selected>Texto</option>
          <option value="imagen">Imagen</option>
          <option value="texto-imagen-h">Texto + Imagen</option>
          <option value="html">HTML personalizado</option>
          <option value="video-autoplay">Video</option>
        </select>


        <div id="${id}-inputs" class="muted"></div>
      </div>
    `;
    // Render inputs immediately for the default "texto"
    setTimeout(() => renderInputs(id), 0);
    return box;
  }

  function moveMod(id, dir) {
    const el = document.getElementById(id);
    if (!el) return;
    const parent = el.parentElement;
    if (!parent) return;

    if (dir === "up") {
      const prev = el.previousElementSibling;
      if (prev) parent.insertBefore(el, prev);
    } else if (dir === "down") {
      const next = el.nextElementSibling;
      if (next) parent.insertBefore(next, el);
    }
    updatePositions();
  }

  function toggleBody(id) {
    const body = byId(id + "-body");
    if (!body) return;
    body.style.display = body.style.display === "none" ? "" : "none";
  }

  function removeMod(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
    updatePositions();
    renderAll();
  }

  /* ========= inputs por tipo ========= */

  function renderInputs(id) {
    const tipo = val(id + "-tipo");
    const cont = byId(id + "-inputs");

    if (tipo === "texto") {
      cont.innerHTML = `
      <div class="params-grid">
        <div class="param-item">
          <label>Cantidad</label>
          <input id="${id}-tcount"
                 type="number"
                 min="1"
                 max="10"
                 value="1"
                 style="width:50px"
                 oninput="updateTextCount('${id}')">
        </div>

        <div class="param-item">
          <label>Color fondo</label>
          <input id="${id}-bg"
                 type="color"
                 class="mini-color"
                 value="#ffffff"
                 title="Color de fondo">
        </div>

        <div class="param-item">
          <label>Ancho (%)</label>
          <input id="${id}-w"
                 type="number"
                 min="10"
                 max="100"
                 value="100"
                 style="width:60px">
        </div>

        <div class="param-item">
          <label>Margen inferior</label>
          <select id="${id}-mb">
            <option value="0" selected>Ninguno</option>
            <option value="2">Bajo</option>
            <option value="4">Medio</option>
            <option value="8">Alto</option>
          </select>
        </div>
      </div>

      <div id="${id}-titems"
           style="margin-top:4px; margin-bottom:12px;"></div>
    `;
      updateTextCount(id);
      return;
    }

    if (tipo === "imagen") {
      cont.innerHTML = `
      <div class="params-grid">
        <div class="param-item">
          <label>Cantidad</label>
          <input id="${id}-count" type="number" min="1" max="10" value="1" style="width:50px" oninput="updateImgCount('${id}')">
        </div>

        <div class="param-item">
          <label>Posici√≥n</label>
          <select id="${id}-ialign">
            <option value="left">Izquierda</option>
            <option value="center" selected>Centro</option>
            <option value="right">Derecha</option>
            <option value="justify">Justificado</option>
          </select>
        </div>

        <div class="param-item">
          <label>Curva</label>
          <select id="${id}-radius">
            <option value="0" selected>Ninguna</option>
            <option value="8">Baja</option>
            <option value="16">Media</option>
            <option value="24">Alta</option>
          </select>
        </div>

        <div class="param-item">
          <label>Ancho (%)</label>
          <input id="${id}-isize"
                type="number"
                min="10"
                max="100"
                value="100"
                style="width:60px">
        </div>

        <div class="param-item">
          <label>Margen inferior</label>
          <select id="${id}-mb">
            <option value="0" selected>Ninguno</option>
            <option value="2">Bajo</option>
            <option value="4">Medio</option>
            <option value="8">Alto</option>
          </select>
        </div>
      </div>

      <div id="${id}-items" style="margin-top:4px; margin-bottom:12px;"></div>

      <div class="checks">
        <label><input type="checkbox" id="${id}-newtab" checked> Abrir enlaces en pesta√±a nueva</label>
      </div>
    `;
      updateImgCount(id);
      return;
    }

    if (tipo === "texto-imagen-h") {
      const defaultLeft = "texto";
      const defaultRight = "imagen";

      cont.innerHTML = `
      <div class="params-grid">
        <div class="param-item">
          <label>Izquierda</label>
          <select id="${id}-hleft">
            <option value="texto" ${defaultLeft === "texto" ? "selected" : ""}>Texto</option>
            <option value="imagen" ${defaultLeft === "imagen" ? "selected" : ""}>Imagen</option>
          </select>
        </div>
        
        <div class="param-item">
          <label>Derecha</label>
          <select id="${id}-hright">
            <option value="texto" ${defaultRight === "texto" ? "selected" : ""}>Texto</option>
            <option value="imagen" ${defaultRight === "imagen" ? "selected" : ""}>Imagen</option>
          </select>
        </div>
        
        <div class="param-item">
          <label>% Izq</label>
          <input id="${id}-wleft" type="number" min="10" max="90" value="50" style="width:60px">
        </div>
        
        <div class="param-item">
          <label>% Der</label>
          <input id="${id}-wright" type="number" min="10" max="90" value="50" style="width:60px">
        </div>

        <div class="param-item">
          <label>Color fondo</label>
          <input id="${id}-hbg" type="color" class="mini-color" value="#ffffff" title="Color de fondo">
        </div>

        <!-- ‚úÖ Margen inferior com√∫n del bloque -->
        <div class="param-item">
          <label>Margen inferior</label>
          <select id="${id}-hmb">
            <option value="0" selected>Ninguno</option>
            <option value="2">Bajo</option>
            <option value="4">Medio</option>
            <option value="8">Alto</option>
          </select>
        </div>
      </div>
      
      <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;">
      
      <h5 style="margin:8px 0 6px; font-size:13px; color:#4b5563;">Configuraci√≥n Texto</h5>
      <div class="params-grid">
        <div class="param-item">
          <label>Cantidad</label>
          <input id="${id}-htcount" type="number" min="1" max="10" value="1" style="width:50px" oninput="updateHTextCount('${id}')">
        </div>
      </div>

      
      <div id="${id}-htitems" style="margin-top:4px; margin-bottom:12px;"></div>
      
      <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;">
      
      <h5 style="margin:8px 0 6px; font-size:13px; color:#4b5563;">Configuraci√≥n Imagen</h5>
      <div class="params-grid">
        <div class="param-item">
          <label>Cantidad</label>
          <input id="${id}-hicount" type="number" min="1" max="10" value="1" style="width:50px" oninput="updateHImgCount('${id}')">
        </div>
        
        <div class="param-item">
          <label>Posici√≥n</label>
          <select id="${id}-hialign">
            <option value="left">Izquierda</option>
            <option value="center" selected>Centro</option>
            <option value="right">Derecha</option>
          </select>
        </div>
        
        <div class="param-item">
          <label>Curva</label>
          <select id="${id}-hiradius">
            <option value="0" selected>Ninguna</option>
            <option value="8">Baja</option>
            <option value="16">Media</option>
            <option value="24">Alta</option>
          </select>
        </div>

      </div>
      
      <div id="${id}-hitems" style="margin-top:4px; margin-bottom:12px;"></div>
      
      <div class="checks">
        <label><input type="checkbox" id="${id}-hinewtab" checked> Abrir enlaces en pesta√±a nueva</label>
      </div>
    `;
      updateHTextCount(id);
      updateHImgCount(id);
      return;
    }
    if (tipo === "html") {
      cont.innerHTML = `
      <div class="img-item-block">
        <div class="data-field-row">
          <label>HTML</label>

          <div class="data-field-main">
            <textarea
              id="${id}-htmlcode"
              rows="8"
              placeholder="<div>Tu HTML aqu√≠...</div>"
              style="font-family:monospace; font-size:12px;"></textarea>
          </div>

          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-htmlcode-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-htmlcode')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>

        <p style="font-size:11px; color:#666; margin:4px 0 0;">
          Puedes escribir HTML manual o traerlo desde una columna del Excel. Lo que edites se guarda por fila (ID).
        </p>
      </div>
    `;
      refreshSourceSelects();
      return;
    }



    if (tipo === "video-autoplay") {
      cont.innerHTML = `
      <div class="img-item-block">
        <div class="data-field-row">
          <label>Video</label>
          <div class="data-field-main">
            <input
              id="${id}-video-url"
              type="text"
              placeholder="https://example.com/video.mp4">
          </div>
          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-video-url-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-video-url')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>
        <p class="muted" style="margin-top:4px;">
          Se generar√° un bloque 16:9 responsive con autoplay, muted, loop y playsinline.
        </p>
      </div>
    `;
      refreshSourceSelects();
      return;
    }


    cont.innerHTML = `<span class="muted">Selecciona un tipo de m√≥dulo para ver sus opciones.</span>`;
  }
  /* ========= textos con m√∫ltiples items ========= */

  function updateTextCount(id) {
    const container = byId(id + "-titems");
    if (!container) return;

    // 1) Guardar lo que ya hay
    const snapshot = snapshotModuleFields(container);

    // 2) Normalizar cantidad
    let count = parseInt(val(id + "-tcount"), 10) || 1;
    if (count < 1) count = 1;
    if (count > 10) count = 10;
    byId(id + "-tcount").value = String(count);

    // 3) Recrear markup
    container.innerHTML = "";

    for (let i = 1; i <= count; i++) {
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "8px";

      wrapper.innerHTML = `
      <div class="data-field-row">
        <label>Texto ${i}</label>

        <div class="data-field-main">
          <div class="text-toolbar-inline">
            <select class="text-toolbar-select"
                    onchange="applyFontSize(this, event)">
              <option value="">Normal</option>
              <option value="10">10</option>
              <option value="12">12</option>
              <option value="14">14</option>
              <option value="16">16</option>
              <option value="18">18</option>
              <option value="20">20</option>
              <option value="22" selected>22</option>
              <option value="24">24</option>
              <option value="28">28</option>
              <option value="32">32</option>
            </select>

            <span class="text-toolbar-separator">|</span>

            <button type="button"
                    class="text-toolbar-button"
                    data-cmd="bold"
                    onmousedown="toolbarCommand(this, event)">
              <b>B</b>
            </button>
            <button type="button"
                    class="text-toolbar-button"
                    data-cmd="italic"
                    onmousedown="toolbarCommand(this, event)">
              <i>K</i>
            </button>
            <button type="button"
                    class="text-toolbar-button"
                    data-cmd="underline"
                    onmousedown="toolbarCommand(this, event)">
              <u>U</u>
            </button>

            <button type="button"
                    class="text-toolbar-button"
                    data-cmd="createLink"
                    onmousedown="toolbarCommand(this, event)">
              üîó
            </button>

            <!-- Bullets -->
            <button type="button"
                    class="text-toolbar-button"
                    onmousedown="applyInlineFormat('insertUnorderedList', event)"
                    title="Vi√±etas">
              <img src="./assets/icons/list-ul.svg"
                   alt="Lista con vi√±etas"
                   class="toolbar-icon-img">
            </button>

            <button type="button"
                    class="text-toolbar-button"
                    onmousedown="applyInlineFormat('insertOrderedList', event)"
                    title="Numeraci√≥n">
              <img src="assets/icons/list-ol.svg"
                   alt="Lista numerada"
                   class="toolbar-icon-img">
            </button>

            <div class="text-color-picker">
              <button type="button"
                      class="text-toolbar-button text-color-btn"
                      title="Color de texto"
                      onmousedown="event.preventDefault(); this.nextElementSibling.click();">
                <img src="assets/icons/paint-bucket.svg"
                     alt="Color de texto"
                     class="text-color-picker-icon">
                <span class="text-color-picker-bar"></span>
              </button>

              <input type="color"
                     class="text-toolbar-color"
                     value="#333333"
                     onchange="applyTextColor(this, event)"
                     oninput="updateTextColorBar(this)"
                     onmousedown="event.stopPropagation();">
            </div>

            <select class="text-toolbar-select text-toolbar-lineheight"
                    onchange="applyLineHeight(this, event)"
                    title="Interlineado">
              <option value="">‚Üï</option>
              <option value="1">1.0</option>
              <option value="1.15">1.15</option>
              <option value="1.5">1.5</option>
              <option value="2">2.0</option>
            </select>

            <button type="button"
                    class="text-toolbar-button text-align-btn"
                    data-cmd="justifyLeft"
                    onmousedown="toolbarCommand(this, event)"
                    title="Alinear a la izquierda">
              <span class="icon-align icon-align-left"><span></span></span>
            </button>

            <button type="button"
                    class="text-toolbar-button text-align-btn"
                    data-cmd="justifyCenter"
                    onmousedown="toolbarCommand(this, event)"
                    title="Centrar">
              <span class="icon-align icon-align-center"><span></span></span>
            </button>
            <button type="button"
                    class="text-toolbar-button text-align-btn"
                    data-cmd="justifyRight"
                    onmousedown="toolbarCommand(this, event)"
                    title="Alinear a la derecha">
              <span class="icon-align icon-align-right"><span></span></span>
            </button>
            <button type="button"
                    class="text-toolbar-button text-align-btn"
                    data-cmd="justifyFull"
                    onmousedown="toolbarCommand(this, event)"
                    title="Justificado">
              <span class="icon-align icon-align-justify"><span></span></span>
            </button>
          </div>

          <div id="${id}-txt${i}"
               class="rich-textarea empty"
               contenteditable="true"
               data-type="rich-text">
          </div>
        </div>

        <div class="source-compact" data-source-wrapper="1">
          <select
            id="${id}-txt${i}-source"
            data-source-select="1"
            ${isExcelLoaded() ? '' : 'disabled'}
            onchange="handleSourceChange('${id}-txt${i}')">
            ${getColumnOptions()}
          </select>
        </div>
      </div>
    `;

      container.appendChild(wrapper);
    }

    // 4) Volver a conectar selects Excel
    refreshSourceSelects();

    // 5) Restaurar valores y estilos anteriores
    restoreModuleFields(snapshot);
  }

  function handleSourceChange(fieldId) {
    const sourceSelect = byId(fieldId + '-source');
    const field = byId(fieldId);
    if (!sourceSelect || !field) return;

    const source = sourceSelect.value;
    const isRich = field.classList && field.classList.contains('rich-textarea');

    // limpiar metadata previa de binding
    if (field.dataset) {
      delete field.dataset.excelBound;
      delete field.dataset.excelColumn;
    }

    // MODO MANUAL ‚Üí editable normal
    if (source === 'manual') {
      if (isRich) {
        if (field.innerHTML.replace(/<br\s*\/?>/gi, '').trim() === '') {
          field.classList.add('empty');
        } else {
          field.classList.remove('empty');
        }
        // activamos editor y barra sobre este campo
        activateRichEditor(field);
      } else {
        if ('readOnly' in field) field.readOnly = false;
        if ('disabled' in field) field.disabled = false;
        if ('placeholder' in field) field.placeholder = 'Ingresa el texto...';
      }
      return;
    }

    // MODO EXCEL ‚Üí trae el valor de la columna
    const excelValue = getExcelValue(source);
    const v = (excelValue !== null && excelValue !== undefined) ? String(excelValue) : '';

    if (isRich) {
      // seguimos usando rich-text, pero con data del Excel
      field.innerHTML = v;
      if (v.replace(/<br\s*\/?>/gi, '').trim() === '') {
        field.classList.add('empty');
      } else {
        field.classList.remove('empty');
      }
      // activamos editor (cursor + barra apuntando ac√°)
      activateRichEditor(field);
    } else {
      // inputs normales: solo lectura si vienen de Excel
      if ('value' in field) field.value = v;
      if ('placeholder' in field) field.placeholder = 'Dato desde Excel (solo lectura)';
      if ('readOnly' in field) field.readOnly = true;
      if ('disabled' in field) field.disabled = false;
    }

    // marcamos que este campo depende de Excel (para cambios de fila y bloqueo de edici√≥n de texto)
    if (field.dataset) {
      field.dataset.excelBound = '1';
      field.dataset.excelColumn = source;
    }
  }
  function handleHtmlEdited(modId) {

  }

  /* ========= im√°genes con input+lista ========= */

  function updateImgCount(id) {
    const container = byId(id + "-items");
    if (!container) return;

    // 1) Guardar lo ya ingresado
    const snapshot = snapshotModuleFields(container);

    // 2) Normalizar cantidad
    let count = parseInt(val(id + "-count"), 10) || 1;
    if (count < 1) count = 1;
    if (count > 10) count = 10;
    byId(id + "-count").value = String(count);

    // 3) Recrear UI
    container.innerHTML = "";

    for (let i = 1; i <= count; i++) {
      const div = document.createElement("div");
      div.className = "img-item-block";

      div.innerHTML = `
      <label style="font-weight:600; display:block; margin-bottom:4px;">Imagen ${i}</label>

      <div class="data-field-row">
        <label>URL</label>
        <div class="data-field-main">
          <input
            type="text"
            id="${id}-img${i}"
            placeholder="https://example.com/imagen.jpg">
        </div>
        <div class="source-compact" data-source-wrapper="1">
          <select
            id="${id}-img${i}-source"
            data-source-select="1"
            ${isExcelLoaded() ? '' : 'disabled'}
            onchange="handleSourceChange('${id}-img${i}')">
            ${getColumnOptions()}
          </select>
        </div>
      </div>

      <div class="data-field-row">
        <label>Alt text</label>
        <div class="data-field-main">
          <input
            type="text"
            id="${id}-alt${i}"
            placeholder="Descripci√≥n de la imagen">
        </div>
        <div class="source-compact" data-source-wrapper="1">
          <select
            id="${id}-alt${i}-source"
            data-source-select="1"
            ${isExcelLoaded() ? '' : 'disabled'}
            onchange="handleSourceChange('${id}-alt${i}')">
            ${getColumnOptions()}
          </select>
        </div>
      </div>

      <div class="data-field-row">
        <label>Enlace</label>
        <div class="data-field-main">
          <input
            type="text"
            id="${id}-link${i}"
            placeholder="https://...">
        </div>
        <div class="source-compact" data-source-wrapper="1">
          <select
            id="${id}-link${i}-source"
            data-source-select="1"
            ${isExcelLoaded() ? '' : 'disabled'}
            onchange="handleSourceChange('${id}-link${i}')">
            ${getColumnOptions()}
          </select>
        </div>
      </div>
    `;

      container.appendChild(div);
    }

    // 4) Refrescar selects Excel
    refreshSourceSelects();

    // 5) Restaurar valores anteriores (URL, alt, links y mapeos de Excel)
    restoreModuleFields(snapshot);
  }

  /* ========= horizontal layout helpers ========= */

  function updateHTextCount(id) {
    const raw = (val(id + "-htcount") || "").trim();
    if (raw === "") {
      return;
    }
    let n = parseInt(raw, 10);
    if (isNaN(n) || n < 1) n = 1;
    if (n > 10) n = 10;
    byId(id + "-htcount").value = String(n);

    const cont = byId(id + "-htitems");
    if (!cont) return;
    cont.innerHTML = "";

    for (let i = 1; i <= n; i++) {
      const box = document.createElement("div");
      box.style.margin = "6px 0";
      box.style.padding = "0";

      box.innerHTML = `
        <div class="data-field-row">
          <label>Texto ${i}</label>

          <div class="data-field-main">
            <div class="text-toolbar-inline">
            <select class="text-toolbar-select"
                    onchange="applyFontSize(this, event)">
              <!-- Opci√≥n de reset / tama√±o base -->
              <option value="">Normal</option>

              <!-- Tama√±os en px, todos con value num√©rico -->
              <option value="10">10</option>
              <option value="12">12</option>
              <option value="14">14</option>
              <option value="16">16</option>
              <option value="18">18</option>
              <option value="20">20</option>
              <option value="22" selected>22</option>
              <option value="24">24</option>
              <option value="28">28</option>
              <option value="32">32</option>
            </select>

              <span class="text-toolbar-separator">|</span>

              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="bold"
                      onmousedown="toolbarCommand(this, event)">
                <b>B</b>
              </button>
              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="italic"
                      onmousedown="toolbarCommand(this, event)">
                <i>K</i>
              </button>
              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="underline"
                      onmousedown="toolbarCommand(this, event)">
                <u>U</u>
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      data-cmd="createLink"
                      onmousedown="toolbarCommand(this, event)">
                üîó
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      onmousedown="applyInlineFormat('insertUnorderedList', event)"
                      title="Vi√±etas">
                <img src="./assets/icons/list-ul.svg"
                     alt="Lista con vi√±etas"
                     class="toolbar-icon-img">
              </button>

              <button type="button"
                      class="text-toolbar-button"
                      onmousedown="applyInlineFormat('insertOrderedList', event)"
                      title="Numeraci√≥n">
                <img src="assets/icons/list-ol.svg"
                     alt="Lista numerada"
                     class="toolbar-icon-img">
              </button>

              <div class="text-color-picker">
                <button type="button"
                        class="text-toolbar-button text-color-btn"
                        title="Color de texto"
                        onmousedown="event.preventDefault(); this.nextElementSibling.click();">
                  <img src="assets/icons/paint-bucket.svg"
                       alt="Color de texto"
                       class="text-color-picker-icon">
                  <span class="text-color-picker-bar"></span>
                </button>

                <input type="color"
                       class="text-toolbar-color"
                       value="#333333"
                       onchange="applyTextColor(this, event)"
                       oninput="updateTextColorBar(this)"
                       onmousedown="event.stopPropagation();">

              </div>

              <select class="text-toolbar-select text-toolbar-lineheight"
                      onchange="applyLineHeight(this, event)"
                      title="Interlineado">
                <option value="">‚Üï</option>
                <option value="1">1.0</option>
                <option value="1.15">1.15</option>
                <option value="1.5">1.5</option>
                <option value="2">2.0</option>
              </select>

              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyLeft"
                      onmousedown="toolbarCommand(this, event)"
                      title="Alinear a la izquierda">
                <span class="icon-align icon-align-left"><span></span></span>
              </button>

              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyCenter"
                      onmousedown="toolbarCommand(this, event)"
                      title="Centrar">
                <span class="icon-align icon-align-center"><span></span></span>
              </button>
              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyRight"
                      onmousedown="toolbarCommand(this, event)"
                      title="Alinear a la derecha">
                <span class="icon-align icon-align-right"><span></span></span>
              </button>
              <button type="button"
                      class="text-toolbar-button text-align-btn"
                      data-cmd="justifyFull"
                      onmousedown="toolbarCommand(this, event)"
                      title="Justificado">
                <span class="icon-align icon-align-justify"><span></span></span>
              </button>
            </div>

            <div id="${id}-htxt${i}"
                 class="rich-textarea empty"
                 contenteditable="true"
                 data-type="rich-text">
            </div>
          </div>

          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-htxt${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-htxt${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>
      `;

      cont.appendChild(box);
    }

    refreshSourceSelects();
  }
  function updateHImgCount(id) {
    const raw = (val(id + "-hicount") || "").trim();
    if (raw === "") {
      return;
    }
    let n = parseInt(raw, 10);
    if (isNaN(n) || n < 1) n = 1;
    if (n > 10) n = 10;
    byId(id + "-hicount").value = String(n);

    const cont = byId(id + "-hitems");
    if (!cont) return;
    cont.innerHTML = "";
    for (let i = 1; i <= n; i++) {
      const box = document.createElement("div");
      box.className = "img-item-block";

      box.innerHTML = `
        <label style="font-weight:600; display:block; margin-bottom:4px;">Imagen ${i}</label>

        <div class="data-field-row">
          <label>URL</label>
          <div class="data-field-main">
            <input id="${id}-himg${i}" type="text" placeholder="https://mi-sitio.com/imagen${i}.jpg">
          </div>
          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-himg${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-himg${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>

        <div class="data-field-row">
          <label>Alt</label>
          <div class="data-field-main">
            <input id="${id}-halt${i}" type="text" placeholder="Ejemplo: Foto ${i}">
          </div>
          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-halt${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-halt${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>

        <div class="data-field-row">
          <label>Enlace</label>
          <div class="data-field-main">
            <input id="${id}-hlink${i}" type="text" placeholder="https://mi-sitio.com/destino${i}">
          </div>
          <div class="source-compact" data-source-wrapper="1">
            <select
              id="${id}-hlink${i}-source"
              data-source-select="1"
              ${isExcelLoaded() ? '' : 'disabled'}
              onchange="handleSourceChange('${id}-hlink${i}')">
              ${getColumnOptions()}
            </select>
          </div>
        </div>
      `;
      cont.appendChild(box);
    }

    refreshSourceSelects();
  }
  /* ========= RENDER: genera HTML, CSS, JS para inpgs-wrapper ========= */

  function renderAll() {
    let htmlBody = "";
    let css = "";
    let js = ""; // reservado
    let modIndex = 0;

    document.querySelectorAll("#mods > .mod-box").forEach(box => {
      const id = box.id;
      if (!byId(id + "-tipo")) return;

      const tipo = val(id + "-tipo");
      if (!tipo) return;
      modIndex++;

      /* === TEXTO: varios h2 en una sola fila === */
      if (tipo === "texto") {
        const rawCount = (val(id + "-tcount") || "").trim();
        let count = parseInt(rawCount || "1", 10);
        if (isNaN(count) || count < 1) count = 1;
        if (count > 10) count = 10;

        const textos = [];
        for (let i = 1; i <= count; i++) {
          const field = byId(`${id}-txt${i}`);
          if (!field) continue;

          const html = field.innerHTML || "";
          const cleaned = html.replace(/<br\s*\/?>/gi, "").trim();
          if (!cleaned) continue;

          const size = field.dataset.fontSize || '';
          textos.push({ html, size });
        }

        if (textos.length === 0) return;

        const w = clampPct(val(id + "-w"));
        const bg = val(id + "-bg") || "#ffffff";

        let mbUnit = parseInt(val(id + "-mb") || "0", 10);
        if (isNaN(mbUnit) || mbUnit < 0) mbUnit = 0;
        const mb = mbUnit * 5;

        const grpCls = "inpgs-txtgrp-" + modIndex;
        const txtCls = "inpgs-txt-" + modIndex;

        htmlBody += `<div class="${grpCls}">\n`;
        textos.forEach(({ html, size }) => {
          const inner = size
            ? `<span style="font-size:${size}px">${html}</span>`
            : html;

          htmlBody += `  <h2 class="${txtCls}">${inner}</h2>\n`;
        });
        htmlBody += `</div>\n`;

        css += `
.inpgs-wrapper .${grpCls}{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:8px !important;
  width:${w}% !important;
  background:${bg} !important;
  margin:0 0 ${mb}px 0 !important;
  padding:0 !important;
  justify-content:flex-start !important;
  align-items:flex-start !important;
}
.inpgs-wrapper .${txtCls}{
  flex:1 1 0 !important;
  min-width:0 !important;
  margin:0 !important;
  padding:0 !important;
  font-family:inherit !important;
}
`.trim() + "\n\n";
      }

      /* === IM√ÅGENES EN FILA === */
      if (tipo === "imagen") {
        const rawCount = (val(id + "-count") || "").trim();
        let count = parseInt(rawCount || "1", 10);
        if (isNaN(count) || count < 1) count = 1;
        if (count > 10) count = 10;

        const items = [];
        for (let i = 1; i <= count; i++) {
          const sourceSelect = byId(`${id}-img${i}-source`);
          const source = sourceSelect ? sourceSelect.value : 'manual';

          let src = '';

          if (source && source !== 'manual') {
            const excelVal = getExcelValue(source);
            src = (excelVal !== null && excelVal !== undefined) ? String(excelVal) : '';
          } else {
            src = val(`${id}-img${i}`);
          }

          if (!src) continue;

          items.push({
            src,
            alt: val(id + "-alt" + i) || "",
            link: val(id + "-link" + i) || ""
          });
        }

        if (items.length === 0) return;

        const radius = parseInt(val(id + "-radius") || "0", 10) || 0;
        const align = val(id + "-ialign") || "center";

        // Ancho imagen en %
        const imgWidth = clampPct(val(id + "-isize") || "100");


        let mbUnit = parseInt(val(id + "-mb") || "0", 10);
        if (isNaN(mbUnit) || mbUnit < 0) mbUnit = 0;
        const mb = mbUnit * 5;

        const newTab = byId(id + "-newtab")?.checked;


        const rowCls = "inpgs-row-" + modIndex;
        const cellCls = rowCls + "__cell";
        const imgCls = rowCls + "__img";


        htmlBody += `<div class="${rowCls}">\n`;
        items.forEach(it => {
          let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
          if (it.link) {
            const targetAttr = newTab ? ' target="_blank" rel="noopener noreferrer"' : "";
            innerImg = `<a href="${escAttr(it.link)}"${targetAttr}>${innerImg}</a>`;
          }
          htmlBody += `  <div class="${cellCls}">${innerImg}</div>\n`;
        });
        htmlBody += `</div>\n`;

        const justify =
          align === "left" ? "flex-start" :
            align === "right" ? "flex-end" :
              align === "center" ? "center" : "space-between";

        css += `
.inpgs-wrapper .${rowCls}{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:8px !important;
  margin:0 0 ${mb}px 0 !important;
  padding:0 !important;
  align-items:center !important;
  justify-content:${justify} !important;
}
.inpgs-wrapper .${cellCls}{
  flex:1 1 0 !important;
  min-width:0 !important;
  text-align:center !important;
}
.inpgs-wrapper .${imgCls}{
  width:${imgWidth}% !important;
  max-width:100% !important;
  height:auto !important;
  border-radius:${radius}px !important;
  display:block !important;
  margin:0 auto !important;
}
`.trim() + "\n\n";

      }

      /* === HORIZONTAL: Texto+Imagen === */
      if (tipo === "texto-imagen-h") {
        const leftType = val(id + "-hleft") || "texto";
        const rightType = val(id + "-hright") || "imagen";
        const wLeft = parseInt(val(id + "-wleft") || "50", 10);
        const wRight = parseInt(val(id + "-wright") || "50", 10);
        const bg = val(id + "-hbg") || "#ffffff";

        // TEXTOS
        const rawTextCount = (val(id + "-htcount") || "").trim();
        let textCount = parseInt(rawTextCount || "1", 10);
        if (isNaN(textCount) || textCount < 1) textCount = 1;
        if (textCount > 10) textCount = 10;

        const texts = [];
        for (let i = 1; i <= textCount; i++) {
          const field = byId(id + "-htxt" + i);
          if (!field) continue;

          const html = field.innerHTML || "";
          const cleaned = html.replace(/<br\s*\/?>/gi, "").trim();
          if (!cleaned) continue;

          const size = field.dataset.fontSize || '';
          texts.push({ html, size });
        }

        // IM√ÅGENES
        const rawImgCount = (val(id + "-hicount") || "").trim();
        let imgCount = parseInt(rawImgCount || "1", 10);
        if (isNaN(imgCount) || imgCount < 1) imgCount = 1;
        if (imgCount > 10) imgCount = 10;

        const images = [];
        for (let i = 1; i <= imgCount; i++) {
          const src = val(id + "-himg" + i);
          if (!src) continue;
          images.push({
            src,
            alt: val(id + "-halt" + i) || "",
            link: val(id + "-hlink" + i) || ""
          });
        }

        const imgAlign = val(id + "-hialign") || "center";
        const imgRadius = parseInt(val(id + "-hiradius") || "0", 10) || 0;
        const imgNewTab = byId(id + "-hinewtab")?.checked;

        // ‚úÖ Margen inferior com√∫n del bloque Texto + Imagen
        let mbUnit = parseInt(val(id + "-hmb") || "0", 10);
        if (isNaN(mbUnit) || mbUnit < 0) mbUnit = 0;
        const mb = mbUnit * 5;


        // si no hay nada, no pintamos bloque
        if (texts.length === 0 && images.length === 0) return;

        const containerCls = "inpgs-hcontainer-" + modIndex;
        const leftCls = containerCls + "__left";
        const rightCls = containerCls + "__right";
        const textCls = containerCls + "__text";
        const imgRowCls = containerCls + "__imgrow";
        const imgCellCls = imgRowCls + "__cell";
        const imgCls = imgRowCls + "__img";

        htmlBody += `<div class="${containerCls}">\n`;

        // COLUMNA IZQUIERDA
        htmlBody += `  <div class="${leftCls}">\n`;
        if (leftType === "texto" && texts.length > 0) {
          texts.forEach(({ html, size }) => {
            const inner = size
              ? `<span style="font-size:${size}px">${html}</span>`
              : html;
            htmlBody += `    <h2 class="${textCls}">${inner}</h2>\n`;
          });
        } else if (leftType === "imagen" && images.length > 0) {
          htmlBody += `    <div class="${imgRowCls}">\n`;
          images.forEach(it => {
            let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
            if (it.link) {
              const targetAttr = imgNewTab ? ' target="_blank" rel="noopener noreferrer"' : "";
              innerImg = `<a href="${escAttr(it.link)}"${targetAttr}>${innerImg}</a>`;
            }
            htmlBody += `      <div class="${imgCellCls}">${innerImg}</div>\n`;
          });
          htmlBody += `    </div>\n`;
        }
        htmlBody += `  </div>\n`;

        // COLUMNA DERECHA
        htmlBody += `  <div class="${rightCls}">\n`;
        if (rightType === "texto" && texts.length > 0) {
          texts.forEach(({ html, size }) => {
            const inner = size
              ? `<span style="font-size:${size}px">${html}</span>`
              : html;
            htmlBody += `    <h2 class="${textCls}">${inner}</h2>\n`;
          });
        } else if (rightType === "imagen" && images.length > 0) {
          htmlBody += `    <div class="${imgRowCls}">\n`;
          images.forEach(it => {
            let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
            if (it.link) {
              const targetAttr = imgNewTab ? ' target="_blank" rel="noopener noreferrer"' : "";
              innerImg = `<a href="${escAttr(it.link)}"${targetAttr}>${innerImg}</a>`;
            }
            htmlBody += `      <div class="${imgCellCls}">${innerImg}</div>\n`;
          });
          htmlBody += `    </div>\n`;
        }
        htmlBody += `  </div>\n`;
        htmlBody += `</div>\n`;

        const imgJustify =
          imgAlign === "left" ? "flex-start" :
            imgAlign === "right" ? "flex-end" :
              imgAlign === "center" ? "center" : "space-between";

        css += `
.inpgs-wrapper .${containerCls}{
  display:flex !important;
  flex-direction:row !important;
  gap:0 !important;
  background:${bg} !important;
  margin:0 0 ${mb}px 0 !important;   /* ‚úÖ antes usaba imgMb */
  padding:0 !important;
}
.inpgs-wrapper .${leftCls}{
  width:${wLeft}% !important;
  padding:0 !important;
  display:flex !important;
  flex-direction:column !important;
  justify-content:center !important;
}
.inpgs-wrapper .${rightCls}{
  width:${wRight}% !important;
  padding:0 !important;
  display:flex !important;
  flex-direction:column !important;
  justify-content:center !important;
}
.inpgs-wrapper .${textCls}{
  margin:0 !important;
  padding:0 !important;
  font-family:inherit !important;
}
.inpgs-wrapper .${imgRowCls}{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:8px !important;
  margin:0 !important;
  padding:0 !important;
  align-items:center !important;
  justify-content:${imgJustify} !important;
}
.inpgs-wrapper .${imgCellCls}{
  flex:1 1 0 !important;
  min-width:0 !important;
  text-align:center !important;
}
.inpgs-wrapper .${imgCls}{
  width:100% !important;
  height:auto !important;
  border-radius:${imgRadius}px !important;
  display:block !important;
}
`.trim() + "\n\n";
      }

  /* === CUSTOM HTML === */
  if (tipo === "html") {
    const sourceSelect = byId(id + "-htmlcode-source");
    const source = sourceSelect ? sourceSelect.value : 'manual';

    let customHtml = '';

    if (source && source !== 'manual') {
      const excelVal = getExcelValue(source);
      customHtml = excelVal != null ? String(excelVal) : '';

      const ta = byId(id + "-htmlcode");
      if (ta && ta.value !== customHtml) {
        ta.value = customHtml;
      }
    } else {
      customHtml = val(id + "-htmlcode") || '';
    }

    // Por si viene escapado tipo &lt;div&gt;
    customHtml = decodeHtmlIfNeeded(customHtml);

    if (customHtml.trim()) {
      // üîß ac√° se aplica el ‚Äúfixer‚Äù SOLO de sintaxis
      const fixedHtml = fixHtmlFragment(customHtml);

      // Si quieres ver el HTML ya corregido en el textarea, puedes actualizarlo:
      const ta = byId(id + "-htmlcode");
      if (ta && ta.value !== fixedHtml) {
        ta.value = fixedHtml;
      }

      htmlBody += fixedHtml + "\n";
    }
  }


      /* === VIDEO AUTOPLAY === */
      if (tipo === "video-autoplay") {
        const sourceSelect = byId(`${id}-video-url-source`);
        const source = sourceSelect ? sourceSelect.value : 'manual';
        let videoUrl = '';

        if (source && source !== 'manual') {
          const excelVal = getExcelValue(source);
          videoUrl = (excelVal !== null && excelVal !== undefined) ? String(excelVal) : '';
        } else {
          videoUrl = val(id + "-video-url");
        }

        if (videoUrl) {
          const escUrl = escAttr(videoUrl);

          htmlBody += `
          <div class="inpgs-video-${modIndex}">
            <video class="inpgs-video-${modIndex}__iframe"
                  src="${escUrl}"
                  autoplay
                  muted
                  playsinline
                  loop
                  controls>
            </video>
          </div>
          `;


          css += `
          .inpgs-wrapper .inpgs-video-${modIndex}{
            position:relative !important;
            width:100% !important;
            padding-bottom:56.25% !important; /* 16:9 */
            height:0 !important;
            margin-bottom:16px !important;
          }

          .inpgs-wrapper .inpgs-video-${modIndex}__iframe{
            position:absolute !important;
            top:0 !important;
            left:0 !important;
            width:100% !important;
            height:100% !important;
            border:none !important;
            object-fit:cover !important;
          }
          `.trim() + "\n\n";

        }
      }


    });

    if (htmlBody.trim() === "") {
      byId("preview").innerHTML = "<div class='muted'>No hay m√≥dulos v√°lidos.</div>";
      byId("htmlOut").value = "";
      byId("cssOut").value = "";
      byId("jsOut").value = "";
      byId("htmlFullOut").value = "";
      return;
    }

    const wrapperStart = `<div class="inpgs-wrapper">`;
    const wrapperEnd = `</div>`;
    const htmlWrapper = wrapperStart + "\n" + htmlBody.trim() + "\n" + wrapperEnd;

    const cssWrapper = `
  .inpgs-wrapper{
    font-family:'Lato',sans-serif !important;
    --inpgs-fs:1.4rem;
    font-size:var(--inpgs-fs) !important;
    line-height:1.35 !important;
    padding:0 !important;
    color:#333333 !important;
    font-weight:400 !important;
  }
  .inpgs-wrapper *,
  .inpgs-wrapper *::before,
  .inpgs-wrapper *::after{
    box-sizing:border-box !important;
    line-height:inherit !important;
  }

  .inpgs-wrapper h1,
  .inpgs-wrapper h2,
  .inpgs-wrapper h3,
  .inpgs-wrapper h4,
  .inpgs-wrapper h5,
  .inpgs-wrapper h6,
  .inpgs-wrapper p,
  .inpgs-wrapper a,
  .inpgs-wrapper li,
  .inpgs-wrapper label,
  .inpgs-wrapper input,
  .inpgs-wrapper textarea,
  .inpgs-wrapper select,
  .inpgs-wrapper button{
    font-size:inherit !important;
    line-height:inherit !important;
  }

  .inpgs-wrapper a,
  .inpgs-wrapper a:link,
  .inpgs-wrapper a:visited {
    color: inherit;
    text-decoration: underline;
  }

  .inpgs-wrapper h1,
  .inpgs-wrapper h2,
  .inpgs-wrapper h3,
  .inpgs-wrapper h4,
  .inpgs-wrapper h5,
  .inpgs-wrapper h6{
    font-weight:400 !important;
  }
  .inpgs-wrapper [style*="font-size"]{
    font-size: inherit !important;
  }
  .amp::before{
    content:"\\0026";
  }
  `.trim() + "\n\n";

    const finalCSS = cssWrapper + css.trim();

    const preview = byId("preview");
    preview.innerHTML = htmlWrapper;

    const fontLinkId = "inpgs-font-link-preview";
    let fontLink = document.getElementById(fontLinkId);
    if (!fontLink) {
      fontLink = document.createElement("link");
      fontLink.id = fontLinkId;
      fontLink.rel = "stylesheet";
      fontLink.href = "https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap";
      document.head.appendChild(fontLink);
    }

    const styleId = "inpgs-style-preview";
    let styleEl = document.getElementById(styleId);
    if (styleEl) styleEl.remove();
    styleEl = document.createElement("style");
    styleEl.id = styleId;
    styleEl.textContent = finalCSS;
    document.head.appendChild(styleEl);

    byId("htmlOut").value = htmlWrapper;
    byId("cssOut").value = finalCSS;
    byId("jsOut").value = js;

    let fullHtml =
      '<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&amp;display=swap" rel="stylesheet">\n' +
      "<style>\n" + finalCSS + "\n</style>\n" +
      htmlWrapper;

    if (js.trim()) {
      fullHtml += "\n<script>\n" + js + "\n</scr" + "ipt>\n";
    }

    fullHtml += '\n<span hidden>INPAGE ESPECIALISTA/IA</span>';

    byId("htmlFullOut").value = fullHtml;
  }
  // === NUEVO: helpers para preservar valores al cambiar "Cantidad" ===
  function snapshotModuleFields(container) {
    const data = {};
    if (!container) return data;

    container.querySelectorAll(
      'input[type="text"], input[type="number"], textarea, .rich-textarea, select[data-source-select="1"]'
    ).forEach(function (el) {
      if (!el.id) return;

      const ds = el.dataset || {};

      if (el.classList.contains('rich-textarea')) {
        data[el.id] = {
          type: 'rich',
          html: el.innerHTML,
          fontSize: el.style.fontSize || '',
          dataset: {
            fontSize: ds.fontSize || '',
            excelBound: ds.excelBound || '',
            excelColumn: ds.excelColumn || '',
            excelBaseValue: ds.excelBaseValue || '',
            excelTemplate: ds.excelTemplate || ''
          }
        };
      } else {
        data[el.id] = {
          type: 'input',
          value: el.value,
          readOnly: el.readOnly,
          disabled: el.disabled,
          placeholder: el.placeholder || '',
          dataset: {
            excelBound: ds.excelBound || '',
            excelColumn: ds.excelColumn || ''
          }
        };
      }
    });

    return data;
  }

  function restoreModuleFields(snapshot) {
    if (!snapshot) return;

    Object.keys(snapshot).forEach(function (id) {
      const info = snapshot[id];
      const el = document.getElementById(id);
      if (!el) return;

      if (info.type === 'rich') {
        el.innerHTML = info.html;

        if (info.fontSize) {
          el.style.fontSize = info.fontSize;
        }

        if (info.dataset) {
          if (info.dataset.fontSize) el.dataset.fontSize = info.dataset.fontSize;
          if (info.dataset.excelBound) el.dataset.excelBound = info.dataset.excelBound;
          if (info.dataset.excelColumn) el.dataset.excelColumn = info.dataset.excelColumn;
          if (info.dataset.excelBaseValue) el.dataset.excelBaseValue = info.dataset.excelBaseValue;
          if (info.dataset.excelTemplate) el.dataset.excelTemplate = info.dataset.excelTemplate;
        }

        // volver a marcar empty / no empty
        if (el.innerHTML.replace(/<br\s*\/?>/gi, '').trim() === '') {
          el.classList.add('empty');
        } else {
          el.classList.remove('empty');
        }

      } else { // inputs normales
        el.value = info.value;
        el.readOnly = !!info.readOnly;
        el.disabled = !!info.disabled;
        el.placeholder = info.placeholder || '';

        if (info.dataset) {
          if (info.dataset.excelBound) el.dataset.excelBound = info.dataset.excelBound;
          if (info.dataset.excelColumn) el.dataset.excelColumn = info.dataset.excelColumn;
        }
      }
    });
  }

  /* ========= helpers ========= */

  function toggleExportPanel() {
    const p = byId("export-panel");
    if (!p) return;
    p.style.display = p.style.display === "none" ? "" : "none";
  }

  function copyHtmlFinal() {
    const ta = byId("htmlFullOut");
    if (!ta) return;
    const text = ta.value || "";
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(() => { });
    } else {
      ta.select();
      ta.setSelectionRange(0, text.length);
      try { document.execCommand("copy"); } catch (e) { }
    }
  }

  function byId(id) { return document.getElementById(id); }
  function val(id) { const el = byId(id); return el ? el.value : ""; }
  let savedSelection = null;


  function saveSelection() {
    const active = document.activeElement;
    if (active && active.matches('.rich-textarea')) {
      currentEditor = active;
      const sel = window.getSelection();
      if (sel && sel.rangeCount > 0) {
        savedSelection = sel.getRangeAt(0);
      }
    }
  }
  function activateRichEditor(field) {
    if (!field) return;
    field.setAttribute('contenteditable', 'true');
    field.focus();
    try {
      const range = document.createRange();
      range.selectNodeContents(field);
      range.collapse(false); // cursor al final
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      currentEditor = field;
      savedSelection = range;
    } catch (e) {
      // si falla no es grave
    }
  }

  function restoreSelection() {
    if (!savedSelection || !currentEditor) return;
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(savedSelection);
  }

  function refreshToolbarState(editor) {
    if (!editor) return;
    const toolbar = editor.previousElementSibling;
    if (!toolbar) return;
    const buttons = toolbar.querySelectorAll('.text-toolbar-button[data-cmd]');
    buttons.forEach(btn => {
      const cmd = btn.dataset.cmd;
      let state = false;
      try {
        state = document.queryCommandState(cmd);
      } catch (e) { state = false; }
      btn.classList.toggle('active', !!state);
    });
  }

  function toolbarCommand(btn, ev) {
    if (ev) ev.preventDefault();
    restoreSelection();
    if (!currentEditor) return;

    const cmd = btn.dataset.cmd;
    if (!cmd) return;

    if (cmd === 'createLink') {
      const url = prompt('URL del enlace:');
      if (!url) return;
      document.execCommand('createLink', false, url);
    } else {
      document.execCommand(cmd, false, null);
    }

    refreshToolbarState(currentEditor);
  }





  function applyLineHeight(select, ev) {
    if (ev) ev.preventDefault();
    if (!currentEditor) return;
    const lh = select.value;
    currentEditor.style.lineHeight = lh || '';
  }
  function applyInlineFormat(cmd, ev) {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation();
    }

    restoreSelection();
    if (!currentEditor) return;

    document.execCommand(cmd, false, null);

    const btn = ev && ev.currentTarget;
    if (btn && btn.classList) {
      btn.classList.toggle('active');
    }
  }


  // Guardar selecci√≥n cuando se interact√∫a con el editor
  document.addEventListener('mouseup', saveSelection);
  document.addEventListener('keyup', saveSelection);
  document.addEventListener('selectionchange', function () {
    const active = document.activeElement;
    if (active && active.matches('.rich-textarea')) {
      saveSelection();
      refreshToolbarState(active);
    }
  });

  function applyTextColor(input, ev) {
    if (ev) ev.preventDefault();
    restoreSelection();
    if (!currentEditor || !input.value) return;
    document.execCommand('foreColor', false, input.value);
    refreshToolbarState(currentEditor);
  }

  function applyFontSize(select, ev) {
    if (ev) ev.preventDefault();

    // buscamos el editor (rich-textarea) que vive junto a este select
    const dataFieldMain = select.closest('.data-field-main');
    if (!dataFieldMain) return;

    const editor = dataFieldMain.querySelector('.rich-textarea');
    if (!editor) return;

    const px = select.value; // "" o "10", "12", "14", etc.

    if (!px) {
      // "Normal": volvemos al tama√±o base (heredado)
      editor.style.fontSize = '';
      delete editor.dataset.fontSize;
    } else {
      // guardamos el tama√±o en el editor y lo aplicamos visualmente
      editor.style.fontSize = px + 'px';
      editor.dataset.fontSize = px;
    }

    // opcional: si quieres devolverle el foco al editor:
    // editor.focus();
  }

  function applyCreateLink(ev) {
    if (ev) ev.preventDefault();
    restoreSelection();
    const url = prompt('URL del enlace:');
    if (!url) return;
    document.execCommand('createLink', false, url);
  }



  function clampPct(v) {
    const n = parseInt(v || "100", 10);
    if (isNaN(n)) return 100;
    return Math.min(100, Math.max(10, n));
  }
  function escHTML(s) {
    return (s || "").replace(/[&<>]/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m]));
  }
  function escAttr(s) {
    return (s || "").replace(/"/g, "&quot;");
  }
  function decodeHtmlIfNeeded(str) {
    if (!str || typeof str !== 'string') return '';

    // Si no parece HTML escapado, lo dejamos tal cual
    if (!str.includes('&lt;') && !str.includes('&gt;') && !str.includes('&amp;')) {
      return str;
    }

    const txt = document.createElement('textarea');
    txt.innerHTML = str;
    return txt.value;
  }

  function fixHtmlFragment(input) {
    if (!input || typeof input !== 'string') return '';

    // El navegador parsea y ‚Äúcierra‚Äù lo que est√© roto
    const container = document.createElement('div');
    container.innerHTML = input;

    // No se elimina nada: ni <script>, ni onClick, ni nada.
    return container.innerHTML;
  }

  /* ========= color sync ========= */
  function syncHex(colorInput, textId) {
    const txt = document.getElementById(textId);
    if (txt) txt.value = colorInput.value;
  }
  function syncColor(textInput, colorId) {
    const col = document.getElementById(colorId);
    let val = textInput.value;
    if (!val.startsWith("#")) val = "#" + val;
    if (/^#[0-9A-F]{6}$/i.test(val)) {
      if (col) col.value = val;
    }
  }
  /* ========= Drag and Drop ========= */
  let draggedItem = null;

  function collapseAll() {
    document.querySelectorAll(".mod-body").forEach(b => b.style.display = "none");
  }

  function dragStart(e, id) {
    draggedItem = document.getElementById(id);
    if (!draggedItem) return;

    // opcional: seguir colapsando todo al arrastrar
    collapseAll();

    draggedItem.classList.add("dragging");

    // necesario para que el drag funcione en todos los navegadores
    if (e.dataTransfer) {
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", id);
    }
  }

  function dragOver(e) {
    e.preventDefault(); // sin esto no se permite soltar
    if (!draggedItem) return;

    const container = document.getElementById("mods");
    if (!container) return;

    const afterElement = getDragAfterElement(container, e.clientY);

    if (!afterElement) {
      // si estoy debajo de todo, lo mando al final
      container.appendChild(draggedItem);
    } else {
      // si estoy sobre alg√∫n bloque, lo inserto antes de ese bloque
      container.insertBefore(draggedItem, afterElement);
    }
  }

  function drop(e) {
    e.preventDefault();
    if (!draggedItem) return;

    draggedItem.classList.remove("dragging");
    draggedItem = null;

    updatePositions();
    // si quieres que la vista previa se actualice al reordenar:
    renderAll();
  }

  function dragEnd(e) {
    // por si el drop se hace fuera del contenedor
    if (draggedItem) {
      draggedItem.classList.remove("dragging");
      draggedItem = null;
      updatePositions();
      // renderAll();
    }
  }

  // calcula delante de qu√© bloque soltar seg√∫n la posici√≥n Y del mouse
  function getDragAfterElement(container, y) {
    const draggableElements = [
      ...container.querySelectorAll(".mod-box:not(.dragging)")
    ];

    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

    draggableElements.forEach(child => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;

      // offset < 0  ‚Üí el mouse est√° por encima del centro del bloque
      // elegimos el m√°s cercano a 0 (pero negativo)
      if (offset < 0 && offset > closest.offset) {
        closest = { offset, element: child };
      }
    });

    return closest.element;
  }



  document.addEventListener('input', function (e) {
    const el = e.target;

    if (el.matches('.rich-textarea')) {
      if (el.innerHTML.replace(/<br\s*\/?>/gi, '').trim() === '') {
        el.classList.add('empty');
      } else {
        el.classList.remove('empty');
      }

      // si est√° ligado a Excel, actualizamos la plantilla de estilos
      if (el.dataset && el.dataset.excelBound === '1') {
        const base = el.dataset.excelBaseValue || '';
        if (base) {
          const html = el.innerHTML;
          const placeholder = '__EXCEL_VALUE__';
          const template = html.split(base).join(placeholder);
          el.dataset.excelTemplate = template;
        }
      }
    }
  });




  function updateTextColorBar(input) {
    const picker = input.closest('.text-color-picker');
    if (!picker) return;
    const bar = picker.querySelector('.text-color-picker-bar');
    if (!bar) return;
    bar.style.background = input.value || '#111827';
  }
  // Bloquear edici√≥n manual del texto cuando viene de Excel,
  // pero seguir permitiendo selecci√≥n + estilos desde la barra.
  document.addEventListener('keydown', function (e) {
    const el = e.target;
    if (!el || !el.matches('.rich-textarea')) return;
    if (!el.dataset || el.dataset.excelBound !== '1') return;

    const key = e.key;

    // teclas que s√≠ permitimos aunque venga de Excel (mover cursor, etc.)
    const allowedNonChar = [
      'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
      'Home', 'End', 'PageUp', 'PageDown',
      'Shift', 'Control', 'Alt', 'Meta', 'Tab', 'Escape'
    ];

    const isChar = key.length === 1; // cualquier letra/n√∫mero/signo
    const isDeleteKey = (key === 'Backspace' || key === 'Delete' || key === 'Enter');

    // si es car√°cter o borrado, y no viene con Ctrl/Meta/Alt ‚Üí lo bloqueamos
    if (
      (!e.ctrlKey && !e.metaKey && !e.altKey) &&
      (isChar || isDeleteKey) &&
      !allowedNonChar.includes(key)
    ) {
      e.preventDefault();
    }
  });

  document.addEventListener('paste', function (e) {
    const el = e.target;
    if (!el || !el.classList || !el.classList.contains('rich-textarea')) return;

    const fieldId = el.id;
    const sourceSelect = byId(fieldId + '-source');
    if (!sourceSelect) return;

    const source = sourceSelect.value;
    if (!source || source === 'manual') return;

    // datos desde Excel: no dejamos pegar texto encima
    e.preventDefault();
  });

</script>