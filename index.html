<!DOCTYPE html>
<div style="display:flex; align-items:center; justify-content:space-between; padding:12px;">
  <img
    src="https://images.falabella.com/v3/assets/blt7c5c2f2f888a7cc3/blt9a6cb2faab703fa5/65a68ebb130790558acbf0cb/falabella.com_green_icon.svg"
    alt="Falabella" style="width:150px; height:auto;">
  <h2 style="flex:1; text-align:center; margin:0;">Constructor de Inpages</h2>
  <div style="width:150px;"></div> <!-- Spacer for centering -->
</div>

<div style="display:flex;gap:12px;padding:12px;align-items:flex-start;">
  <!--  Columna izquierda: m√≥dulos  -->
  <div style="flex:2;max-width:60%;">
    <div
      style="margin-bottom:10px; display:flex; justify-content:flex-start; gap:8px; align-items:center; flex-wrap:wrap;">
      <button onclick="collapseAll()"
        style="padding:5px 10px;background:#64748b;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:12px;">
        Contraer todo
      </button>
      <label
        style="padding:5px 10px;background:#2563eb;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:12px;display:inline-block;">
        üìÅ Cargar Excel
        <input type="file" id="global-excel-upload" accept=".xlsx,.xls" style="display:none;"
          onchange="handleGlobalExcelUpload(event)">
      </label>

      <!-- Row selector (hidden initially) -->
      <div id="excel-row-selector-container" style="display:none; align-items:center; gap:6px;">
        <label style="font-size:12px; color:#444;">Fila a visualizar:</label>
        <select id="excel-row-selector" onchange="renderAll()"
          style="padding:4px 8px; border:1px solid #ccc; border-radius:4px; font-size:12px;">
        </select>
      </div>

      <!-- Generate all button (hidden initially) -->
      <button id="generate-all-btn" onclick="generateAllHTML()"
        style="display:none; padding:5px 10px; background:#10b981; color:#fff; border:0; border-radius:4px; cursor:pointer; font-size:12px;">
        ‚ú® Generar todos los HTMLs
      </button>
    </div>
    <div id="mods"></div>

    <div style="display:flex;gap:8px;margin-top:8px;">
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <button onclick="addMod()"
          style="padding:8px 12px;background:#3498db;color:#fff;border:0;border-radius:6px;cursor:pointer;">
          Agregar Bloque
        </button>
        <button onclick="renderAll()"
          style="padding:8px 12px; background:#10b981; color:#fff; border:0; border-radius:6px; cursor:pointer;">
          Generar vista
        </button>
      </div>

    </div>
  </div>

  <!-- Columna derecha: vista + export -->
  <div
    style="flex:1;background:#fff;padding:12px;border-radius:8px;box-shadow:0 0 8px rgba(0,0,0,.06);max-height:90vh;overflow:auto;position:sticky;top:12px;">
    <div style="margin-bottom:12px;">
      <button onclick="renderAll()"
        style="padding:6px 12px; background:#10b981; color:#fff; border:0; border-radius:6px; cursor:pointer; font-size:13px;">
        Generar vista
      </button>
    </div>
    <h3 style="margin-top:0;">Vista previa</h3>
    <div id="preview" style="border:1px dashed #ddd;border-radius:6px;padding:10px;min-height:80px;"></div>

    <button type="button" onclick="toggleExportPanel()"
      style="margin-top:10px;padding:6px 10px;background:#e5e7eb;border:0;border-radius:6px;cursor:pointer;font-size:13px;">
      Mostrar / ocultar c√≥digo (HTML / CSS / JS)
    </button>

    <div id="export-panel" style="display:none;margin-top:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
        <h3 style="margin:0;">HTML final (snippet listo para pegar)</h3>
        <button type="button" onclick="copyHtmlFinal()"
          style="padding:4px 8px;background:#4b5563;color:#fff;border:0;border-radius:6px;cursor:pointer;font-size:12px;">
          Copiar HTML
        </button>
      </div>
      <textarea id="htmlFullOut" rows="6" readonly
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></textarea>

      <h3 style="margin-top:12px;">HTML (solo wrapper)</h3>
      <textarea id="htmlOut" rows="5" readonly
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>

      <h3 style="margin-top:12px;">CSS (m√≥dulos inpgs)</h3>
      <textarea id="cssOut" rows="6" readonly
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>

      <h3 style="margin-top:12px;">JS (si lo hubiera)</h3>
      <textarea id="jsOut" rows="3" readonly
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>
    </div>
  </div>
</div>

<style>
  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f4f4;
  }

  .mod-box {
    background: #fff;
    padding: 8px 12px;
    margin: 8px 0;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0, 0, 0, .06);
  }

  .mod-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    cursor: default;
  }

  .mod-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .mod-header h4 {
    margin: 0;
    font-size: 14px;
  }

  .muted {
    font-size: 12px;
    color: #666;
  }

  /* General Inputs */
  select,
  input[type="text"],
  input[type="number"],
  textarea {
    width: 100%;
    padding: 6px;
    margin: 4px 0 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 13px;
  }

  label {
    font-size: 12px;
    color: #444;
    font-weight: 600;
    display: block;
    margin-bottom: 2px;
  }

  /* Layout Utils */
  .row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .checks {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 12px;
    margin-top: 8px;
  }

  .checks label {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: normal;
    cursor: pointer;
  }

  .mod-body {
    margin-top: 6px;
  }

  /* Minimalist Controls - Grid Layout */
  .params-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
    margin-bottom: 8px;
  }

  .param-item {
    display: flex;
    flex-direction: column;
  }

  .param-item label {
    margin-bottom: 2px;
    font-size: 11px;
    color: #555;
  }

  /* Compact inputs in param-item */
  .param-item select,
  .param-item input[type="text"],
  .param-item input[type="number"] {
    margin: 0;
    width: auto;
    max-width: 100px;
    padding: 4px;
    font-size: 12px;
  }

  /* Color Picker Minimalist */
  input[type="color"].mini-color {
    width: 24px;
    height: 24px;
    padding: 0;
    border: 1px solid #ccc;
    background: none;
    cursor: pointer;
    border-radius: 4px;
    overflow: hidden;
    vertical-align: bottom;
  }

  input[type="color"].mini-color::-webkit-color-swatch-wrapper {
    padding: 0;
  }

  input[type="color"].mini-color::-webkit-color-swatch {
    border: none;
    border-radius: 3px;
  }
</style>

<!-- SheetJS for Excel processing -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
  let modCount = 0;
  /* ========= GLOBAL EXCEL DATA ========= */

  let globalExcelData = {

    columns: [],
    rows: [],
    fileName: ""
  };
  let currentRenderRowIndex = null;

  /* ========= GLOBAL EXCEL UPLOAD ========= */
  function handleGlobalExcelUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    console.log('Archivo cargado:', file.name);
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (!jsonData || jsonData.length === 0) {
          alert('El archivo parece estar vac√≠o.');
          return;
        }
        // Extract column names
        globalExcelData.columns = Object.keys(jsonData[0]);
        globalExcelData.rows = jsonData;
        globalExcelData.fileName = file.name;
        // Show success message
        alert(`Excel cargado exitosamente!\\n\\nColumnas detectadas:\\n${globalExcelData.columns.join(', ')}\\n\\nFilas: ${globalExcelData.rows.length}`);
        // Populate row selector
        populateRowSelector();
        // Show row selector and generate button
        const selectorContainer = byId('excel-row-selector-container');
        const generateBtn = byId('generate-all-btn');
        if (selectorContainer) selectorContainer.style.display = 'flex';
        if (generateBtn) generateBtn.style.display = 'inline-block';
        // Trigger initial render
        renderAll();
      } catch (err) {
        console.error(err);
        alert('Error al leer el archivo: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }
  function populateRowSelector() {
    const selector = byId('excel-row-selector');
    if (!selector) return;
    selector.innerHTML = '';
    const firstCol = globalExcelData.columns[0];
    globalExcelData.rows.forEach((row, index) => {
      const opt = document.createElement('option');
      opt.value = index;
      opt.textContent = `${row[firstCol]} (Fila ${index + 1})`;
      selector.appendChild(opt);
    });
  }

  function getColumnOptions() {
    if (!globalExcelData.columns || globalExcelData.columns.length === 0) {
      return '<option value="manual">Valor manual</option>';
    }

    let options = '<option value="manual">Valor manual</option>';
    globalExcelData.columns.forEach(col => {
      options += `<option value="${col}">${col}</option>`;
    });
    return options;
  }

  function getExcelValue(columnName) {
    if (!columnName || columnName === 'manual' || !globalExcelData.rows.length) {
      return null;
    }

    let rowIndex;

    // Si estamos en generaci√≥n masiva, usamos el √≠ndice forzado
    if (currentRenderRowIndex !== null) {
      rowIndex = currentRenderRowIndex;
    } else {
      // Modo normal: vista previa con el selector de filas
      const rowSelector = byId('excel-row-selector');
      rowIndex = rowSelector ? parseInt(rowSelector.value || '0', 10) : 0;
    }

    const row = globalExcelData.rows[rowIndex] || {};
    const value = row[columnName];

    return (value !== undefined && value !== null) ? value : '';
  }

  function generateAllHTML() {
    if (!globalExcelData.rows.length) {
      alert('Primero carga un archivo Excel');
      return;
    }

    const results = [];
    const firstCol = globalExcelData.columns[0];

    // Guardamos la fila actualmente seleccionada en el selector (para restaurar la vista)
    const rowSelector = byId('excel-row-selector');
    const originalRowIndex = rowSelector ? parseInt(rowSelector.value || '0', 10) : 0;

    globalExcelData.rows.forEach((row, index) => {
      // Forzamos que todas las lecturas desde Excel apunten a ESTA fila
      currentRenderRowIndex = index;

      // Render con los datos de esta fila
      renderAll();

      const html = byId('htmlFullOut').value;

      results.push({
        [firstCol]: row[firstCol],
        HTML: html
      });
    });

    // Volvemos a modo normal (vista atada al selector visual)
    currentRenderRowIndex = null;
    if (rowSelector) {
      rowSelector.value = originalRowIndex;
      renderAll(); // restaurar la preview a la fila que estaba elegida
    }

    // Descargar Excel con resultados
    const ws = XLSX.utils.json_to_sheet(results);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'HTMLs Generados');
    XLSX.writeFile(wb, 'inpages_generados.xlsx');
    alert(`¬°Listo! Se generaron ${results.length} HTMLs y se descarg√≥ el archivo Excel.`);
  }

  /* ========= creaci√≥n / inserci√≥n / orden ========= */

  function addMod() {
    addModAt("end", null);
  }

  function addModAt(where, refId) {
    modCount++;
    const id = "mod_" + modCount;
    const box = createModuleBox(id, modCount);
    const container = document.getElementById("mods");

    if (!where || where === "end" || !refId) {
      container.appendChild(box);
      return;
    }

    const ref = document.getElementById(refId);
    if (!ref) {
      container.appendChild(box);
      return;
    }

    if (where === "before") {
      container.insertBefore(box, ref);
    } else if (where === "after") {
      container.insertBefore(box, ref.nextSibling);
    } else {
      container.appendChild(box);
    }
    updatePositions();
  }

  function updatePositions() {
    const container = document.getElementById("mods");
    if (!container) return;
    // Only select direct children to avoid nested .mod-box elements
    const boxes = Array.from(container.children).filter(el => el.classList.contains("mod-box"));
    boxes.forEach((box, i) => {
      const posLabel = box.querySelector(".mod-pos");
      if (posLabel) posLabel.textContent = "Posici√≥n " + (i + 1);
    });
  }

  function createModuleBox(id, index) {
    const box = document.createElement("div");
    box.className = "mod-box";
    box.id = id;
    // Keep ondragover and ondrop on the box for drop target functionality
    box.ondragover = (e) => dragOver(e);
    box.ondrop = (e) => drop(e, id);

    box.innerHTML = `
      <div class="mod-header" draggable="true" 
           ondragstart="dragStart(event, '${id}')" 
           ondragend="dragEnd(event)"
           style="cursor:grab;">
        <div class="mod-header-left">
          <span style="font-size:16px;color:#999;margin-right:4px;" title="Arrastrar para mover">‚ò∞</span>
          <button type="button" onclick="toggleBody('${id}');event.stopPropagation();" style="padding:3px 6px;background:#e5e7eb;border:0;border-radius:4px;cursor:pointer;font-size:11px;">Mostrar / ocultar</button>
          <h4>Bloque ${index} <span class="mod-pos" style="font-size:11px;font-weight:normal;color:#666;margin-left:6px;">Posici√≥n ${index}</span></h4>
        </div>
        <div style="display:flex;gap:4px;align-items:center;">
          <button type="button" onclick="moveMod('${id}','up');event.stopPropagation();" style="padding:3px 6px;background:#facc15;border:0;border-radius:4px;cursor:pointer;font-size:11px;">‚Üë</button>
          <button type="button" onclick="moveMod('${id}','down');event.stopPropagation();" style="padding:3px 6px;background:#a5b4fc;border:0;border-radius:4px;cursor:pointer;font-size:11px;">‚Üì</button>
          <button type="button" onclick="removeMod('${id}')" style="padding:4px 8px;background:#ef4444;color:#fff;border:0;border-radius:6px;cursor:pointer;font-size:12px;">Eliminar</button>
        </div>
      </div>

      <div class="mod-body" id="${id}-body">
        <label>Seleccionar M√≥dulo</label>
        <select id="${id}-tipo" onchange="renderInputs('${id}')">
          <option value="texto" selected>Texto</option>
          <option value="imagen">Im√°genes en fila</option>
          <option value="texto-imagen-h">Texto+Imagen (horizontal)</option>
          <option value="html">HTML personalizado</option>
          <option value="excel-merge">Carga Excel (Merge)</option>
        </select>

        <div id="${id}-inputs" class="muted"></div>
      </div>
    `;
    // Render inputs immediately for the default "texto"
    setTimeout(() => renderInputs(id), 0);
    return box;
  }

  function moveMod(id, dir) {
    const el = document.getElementById(id);
    if (!el) return;
    const parent = el.parentElement;
    if (!parent) return;

    if (dir === "up") {
      const prev = el.previousElementSibling;
      if (prev) parent.insertBefore(el, prev);
    } else if (dir === "down") {
      const next = el.nextElementSibling;
      if (next) parent.insertBefore(next, el);
    }
    updatePositions();
  }

  function toggleBody(id) {
    const body = byId(id + "-body");
    if (!body) return;
    body.style.display = body.style.display === "none" ? "" : "none";
  }

  function removeMod(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
    updatePositions();
    renderAll();
  }

  /* ========= inputs por tipo ========= */

  function renderInputs(id) {
    const tipo = val(id + "-tipo");
    const cont = byId(id + "-inputs");

    if (tipo === "texto") {
      cont.innerHTML = `
        <div class="params-grid">
          <div class="param-item">
            <label>Cantidad</label>
            <input id="${id}-tcount" type="number" min="1" max="10" value="1" style="width:50px" oninput="updateTextCount('${id}')">
          </div>
          
          <div class="param-item">
            <label>Tama√±o</label>
            <select id="${id}-size">
              <option value="14px">Peque√±o</option>
              <option value="16px" selected>Normal</option>
              <option value="20px">Grande</option>
              <option value="28px">Muy grande</option>
            </select>
          </div>

          <div class="param-item">
            <label>Alineaci√≥n</label>
            <select id="${id}-align">
              <option value="left">Izquierda</option>
              <option value="center" selected>Centro</option>
              <option value="right">Derecha</option>
              <option value="justify">Justificado</option>
            </select>
          </div>

          <div class="param-item">
            <label>Color texto</label>
            <input id="${id}-color" type="color" class="mini-color" value="#333333" title="Color de texto">
          </div>

          <div class="param-item">
            <label>Color fondo</label>
            <input id="${id}-bg" type="color" class="mini-color" value="#ffffff" title="Color de fondo">
          </div>

          <div class="param-item">
            <label>Ancho (%)</label>
            <input id="${id}-w" type="number" min="10" max="100" value="100" style="width:60px">
          </div>

          <div class="param-item">
            <label>Margen inferior</label>
            <select id="${id}-mb">
              <option value="0" selected>Ninguno</option>
              <option value="2">Bajo</option>
              <option value="4">Medio</option>
              <option value="8">Alto</option>
            </select>
          </div>
        </div>

        <div id="${id}-titems" style="margin-top:4px; margin-bottom:12px;"></div>

        <div class="checks">
          <label><input type="checkbox" id="${id}-b"> <b>Negrita</b></label>
          <label><input type="checkbox" id="${id}-i"> <i>Cursiva</i></label>
          <label><input type="checkbox" id="${id}-u"> <u>Subrayado</u></label>
          <label><input type="checkbox" id="${id}-upper"> MAY√öSCULAS</label>
        </div>
      `;
      updateTextCount(id);
    } else if (tipo === "imagen") {
      cont.innerHTML = `
        <div class="params-grid">
          <div class="param-item">
            <label>Cantidad</label>
            <input id="${id}-count" type="number" min="1" max="10" value="1" style="width:50px" oninput="updateImgCount('${id}')">
          </div>

          <div class="param-item">
            <label>Posici√≥n</label>
            <select id="${id}-ialign">
              <option value="left">Izquierda</option>
              <option value="center" selected>Centro</option>
              <option value="right">Derecha</option>
              <option value="justify">Justificado</option>
            </select>
          </div>

          <div class="param-item">
            <label>Curva</label>
            <select id="${id}-radius">
              <option value="0" selected>Ninguna</option>
              <option value="8">Baja</option>
              <option value="16">Media</option>
              <option value="24">Alta</option>
            </select>
          </div>

          <div class="param-item">
            <label>Margen inferior</label>
            <select id="${id}-mb">
              <option value="0" selected>Ninguno</option>
              <option value="2">Bajo</option>
              <option value="4">Medio</option>
              <option value="8">Alto</option>
            </select>
          </div>
        </div>

        <div id="${id}-items" style="margin-top:4px; margin-bottom:12px;"></div>

        <div class="checks">
          <label><input type="checkbox" id="${id}-newtab" checked> Abrir enlaces en pesta√±a nueva</label>
        </div>
      `;
      updateImgCount(id);
    } else if (tipo === "texto-imagen-h") {
      const defaultLeft = "texto";
      const defaultRight = "imagen";

      cont.innerHTML = `
        <div class="params-grid">
          <div class="param-item">
            <label>Izquierda</label>
            <select id="${id}-hleft">
              <option value="texto" ${defaultLeft === "texto" ? "selected" : ""}>Texto</option>
              <option value="imagen" ${defaultLeft === "imagen" ? "selected" : ""}>Imagen</option>
            </select>
          </div>
          
          <div class="param-item">
            <label>Derecha</label>
            <select id="${id}-hright">
              <option value="texto" ${defaultRight === "texto" ? "selected" : ""}>Texto</option>
              <option value="imagen" ${defaultRight === "imagen" ? "selected" : ""}>Imagen</option>
            </select>
          </div>
          
          <div class="param-item">
            <label>% Izq</label>
            <input id="${id}-wleft" type="number" min="10" max="90" value="50" style="width:60px">
          </div>
          
          <div class="param-item">
            <label>% Der</label>
            <input id="${id}-wright" type="number" min="10" max="90" value="50" style="width:60px">
          </div>
        </div>
        
        <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;">
        
        <h5 style="margin:8px 0 6px; font-size:13px; color:#4b5563;">Configuraci√≥n Texto</h5>
        <div class="params-grid">
          <div class="param-item">
            <label>Cantidad</label>
            <input id="${id}-htcount" type="number" min="1" max="10" value="1" style="width:50px" oninput="updateHTextCount('${id}')">
          </div>
          
          <div class="param-item">
            <label>Tama√±o</label>
            <select id="${id}-hsize">
              <option value="14px">Peque√±o</option>
              <option value="16px" selected>Normal</option>
              <option value="20px">Grande</option>
              <option value="28px">Muy grande</option>
            </select>
          </div>
          
          <div class="param-item">
            <label>Alineaci√≥n</label>
            <select id="${id}-halign">
              <option value="left">Izquierda</option>
              <option value="center" selected>Centro</option>
              <option value="right">Derecha</option>
              <option value="justify">Justificado</option>
            </select>
          </div>
          
          <div class="param-item">
            <label>Color texto</label>
            <input id="${id}-hcolor" type="color" class="mini-color" value="#333333" title="Color de texto">
          </div>
        </div>
        
        <div id="${id}-htitems" style="margin-top:4px; margin-bottom:12px;"></div>
        
        <div class="checks">
          <label><input type="checkbox" id="${id}-hb"> <b>Negrita</b></label>
          <label><input type="checkbox" id="${id}-hi"> <i>Cursiva</i></label>
          <label><input type="checkbox" id="${id}-hu"> <u>Subrayado</u></label>
          <label><input type="checkbox" id="${id}-hupper"> MAY√öSCULAS</label>
        </div>
        
        <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;">
        
        <h5 style="margin:8px 0 6px; font-size:13px; color:#4b5563;">Configuraci√≥n Imagen</h5>
        <div class="params-grid">
          <div class="param-item">
            <label>Cantidad</label>
            <input id="${id}-hicount" type="number" min="1" max="10" value="1" style="width:50px" oninput="updateHImgCount('${id}')">
          </div>
          
          <div class="param-item">
            <label>Posici√≥n</label>
            <select id="${id}-hialign">
              <option value="left">Izquierda</option>
              <option value="center" selected>Centro</option>
              <option value="right">Derecha</option>
            </select>
          </div>
          
          <div class="param-item">
            <label>Curva</label>
            <select id="${id}-hiradius">
              <option value="0" selected>Ninguna</option>
              <option value="8">Baja</option>
              <option value="16">Media</option>
              <option value="24">Alta</option>
            </select>
          </div>
          
          <div class="param-item">
            <label>Margen inferior</label>
            <select id="${id}-himb">
              <option value="0" selected>Ninguno</option>
              <option value="2">Bajo</option>
              <option value="4">Medio</option>
              <option value="8">Alto</option>
            </select>
          </div>
        </div>
        
        <div id="${id}-hitems" style="margin-top:4px; margin-bottom:12px;"></div>
        
        <div class="checks">
          <label><input type="checkbox" id="${id}-hinewtab" checked> Abrir enlaces en pesta√±a nueva</label>
        </div>
        
        <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;">
        
        <div class="params-grid">
          <div class="param-item">
            <label>Color fondo</label>
            <input id="${id}-hbg" type="color" class="mini-color" value="#ffffff" title="Color de fondo">
          </div>
        </div>
      `;
      updateHTextCount(id);
      updateHImgCount(id);
    } else if (tipo === "html") {
      cont.innerHTML = `
        <div style="margin-bottom:12px;">
          <label>C√≥digo HTML personalizado</label>
          <p style="font-size:11px; color:#666; margin:4px 0;">Pega aqu√≠ tu c√≥digo HTML. Se agregar√° tal cual al resultado final.</p>
          <textarea id="${id}-htmlcode" rows="8" placeholder="<div>Tu HTML aqu√≠...</div>" style="font-family:monospace; font-size:12px;"></textarea>
        </div>
      `;
    } else if (tipo === "excel-merge") {
      cont.innerHTML = `
        <div style="margin-bottom:12px;">
          <label>Archivo Excel (.xlsx, .xls)</label>
          <p style="font-size:11px; color:#666; margin:4px 0;">Sube un Excel con columnas: <strong>ID</strong> (col A) y <strong>HTML</strong> (col B).</p>
          <input type="file" id="${id}-excelfile" accept=".xlsx, .xls" onchange="loadExcelData('${id}')" />
          
          <div id="${id}-preview-controls" style="margin-top:12px; display:none;">
            <label>Previsualizar ID:</label>
            <select id="${id}-excelid" onchange="renderAll()"></select>
          </div>

          <div style="margin-top:12px;">
            <button type="button" onclick="processExcel('${id}')" style="padding:6px 12px; background:#2563eb; color:#fff; border:0; border-radius:4px; cursor:pointer;">
              Descargar Excel Generado
            </button>
          </div>
          <div id="${id}-excelstatus" style="margin-top:8px; font-size:12px; color:#444;"></div>
        </div>
      `;
    } else {
      cont.innerHTML = `<span class="muted">Selecciona un tipo de m√≥dulo para ver sus opciones.</span>`;
    }
  }

  /* ========= textos con m√∫ltiples items ========= */

  function updateTextCount(id) {
    const count = parseInt(val(id + "-tcount"), 10) || 1;
    const container = byId(id + "-titems");
    if (!container) return;
    container.innerHTML = "";
    for (let i = 1; i <= count; i++) {
      const div = document.createElement("div");
      div.style.marginBottom = "8px";
      div.innerHTML = `
        <label>Texto ${i} - Fuente de datos</label>
        <select id="${id}-txt${i}-source" onchange="handleSourceChange('${id}-txt${i}')">
          ${getColumnOptions()}
        </select>
        <textarea id="${id}-txt${i}" rows="2" placeholder="Ingresa el texto..."></textarea>
      `;
      container.appendChild(div);
    }
  }

  function handleSourceChange(fieldId) {
    const sourceSelect = byId(fieldId + '-source');
    const field = byId(fieldId);

    if (!sourceSelect || !field) return;

    const source = sourceSelect.value;

    if (source === 'manual') {
      field.disabled = false;
      field.placeholder = 'Ingresa el texto...';
    } else {
      const excelValue = getExcelValue(source);
      if (excelValue !== null) {
        field.value = excelValue;
        field.disabled = true;
        field.placeholder = 'Valor desde Excel';
      }
    }
  }
  /* ========= im√°genes con input+lista ========= */

  function updateImgCount(id) {
    const count = parseInt(val(id + "-count"), 10) || 1;
    const container = byId(id + "-items");
    if (!container) return;
    container.innerHTML = "";
    for (let i = 1; i <= count; i++) {
      const div = document.createElement("div");
      div.style.marginBottom = "10px";
      div.style.padding = "8px";
      div.style.background = "#f9fafb";
      div.style.borderRadius = "6px";
      div.innerHTML = `
        <label style="font-weight:600;">Imagen ${i}</label>
        <label style="margin-top:4px;">Fuente de datos</label>
        <select id="${id}-img${i}-source" onchange="handleSourceChange('${id}-img${i}')">
          ${getColumnOptions()}
        </select>
        <label style="margin-top:4px;">URL</label>
        <input type="text" id="${id}-img${i}" placeholder="https://example.com/imagen.jpg">
        <label style="margin-top:4px;">Alt text</label>
        <input type="text" id="${id}-alt${i}" placeholder="Descripci√≥n de la imagen">
        <label style="margin-top:4px;">Enlace (opcional)</label>
        <input type="text" id="${id}-link${i}" placeholder="https://...">
      `;
      container.appendChild(div);
    }
  }
  /* ========= horizontal layout helpers ========= */

  function updateHTextCount(id) {
    const raw = (val(id + "-htcount") || "").trim();
    if (raw === "") {
      return;
    }
    let n = parseInt(raw, 10);
    if (isNaN(n) || n < 1) n = 1;
    if (n > 10) n = 10;
    byId(id + "-htcount").value = String(n);

    const cont = byId(id + "-htitems");
    if (!cont) return;
    cont.innerHTML = "";

    for (let i = 1; i <= n; i++) {
      const ph = i === 1 ? "L√≠nea 1&#10;L√≠nea 2" : "";
      const box = document.createElement("div");
      box.className = "mod-box";
      box.style.margin = "6px 0";
      box.style.padding = "8px";
      box.innerHTML = `
        <strong>Texto ${i}</strong>
        <textarea id="${id}-htxt${i}" rows="2" placeholder="${ph}"></textarea>
      `;
      cont.appendChild(box);
    }
  }

  function updateHImgCount(id) {
    const raw = (val(id + "-hicount") || "").trim();
    if (raw === "") {
      return;
    }
    let n = parseInt(raw, 10);
    if (isNaN(n) || n < 1) n = 1;
    if (n > 10) n = 10;
    byId(id + "-hicount").value = String(n);

    const cont = byId(id + "-hitems");
    if (!cont) return;
    cont.innerHTML = "";
    for (let i = 1; i <= n; i++) {
      const box = document.createElement("div");
      box.className = "mod-box";
      box.style.margin = "6px 0";
      box.style.padding = "8px";
      box.innerHTML = `
        <strong>Imagen ${i}</strong>
        <label>URL de la imagen</label>
        <input id="${id}-himg${i}" type="text" placeholder="https://mi-sitio.com/imagen${i}.jpg">

        <label>Texto alternativo (descripci√≥n corta)</label>
        <input id="${id}-halt${i}" type="text" placeholder="Ejemplo: Foto ${i}">

        <label>Enlace al hacer clic (opcional)</label>
        <input id="${id}-hlink${i}" type="text" placeholder="https://mi-sitio.com/destino${i}">
      `;
      cont.appendChild(box);
    }
  }

  /* ========= RENDER: genera HTML, CSS, JS para inpgs-wrapper ========= */

  function renderAll() {
    let htmlBody = "";
    let css = "";
    let js = ""; // reservado
    let modIndex = 0;

    document.querySelectorAll("#mods > .mod-box").forEach(box => {
      const id = box.id;
      if (!byId(id + "-tipo")) return;

      const tipo = val(id + "-tipo");
      if (!tipo) return;
      modIndex++;

      /* === TEXTO: varios h2 en una sola fila === */
      if (tipo === "texto") {
        const rawCount = (val(id + "-tcount") || "").trim();
        let count = parseInt(rawCount || "1", 10);
        if (isNaN(count) || count < 1) count = 1;
        if (count > 10) count = 10;

        const textos = [];
        for (let i = 1; i <= count; i++) {
          const sourceSelect = byId(`${id}-txt${i}-source`);
          const source = sourceSelect ? sourceSelect.value : 'manual';

          let t = '';

          if (source && source !== 'manual') {
            // Tomar el valor directamente desde la fila de Excel correspondiente
            const excelVal = getExcelValue(source);
            t = (excelVal !== null && excelVal !== undefined) ? String(excelVal) : '';
          } else {
            // Modo manual: lo que haya escrito el usuario
            t = val(`${id}-txt${i}`);
          }

          if (t && t.trim()) {
            textos.push(t);
          }
        }

        if (textos.length === 0) return;

        const sizeToken = val(id + "-size") || "16px";
        let sizeEm;
        if (sizeToken === "14px") sizeEm = "0.9em";
        else if (sizeToken === "20px") sizeEm = "1.25em";
        else if (sizeToken === "28px") sizeEm = "1.6em";
        else sizeEm = "1em";

        const color = val(id + "-color") || "#333333";
        const bg = val(id + "-bg") || "#ffffff";
        const align = val(id + "-align") || "center";
        const w = clampPct(val(id + "-w"));

        // Espacio: 1 unidad = 5px
        let mbUnit = parseInt(val(id + "-mb") || "0", 10);
        if (isNaN(mbUnit) || mbUnit < 0) mbUnit = 0;
        const mb = mbUnit * 5;

        const bold = byId(id + "-b")?.checked;
        const italic = byId(id + "-i")?.checked;
        const under = byId(id + "-u")?.checked;
        const upper = byId(id + "-upper")?.checked;

        const grpCls = "inpgs-txtgrp-" + modIndex;
        const txtCls = "inpgs-txt-" + modIndex;

        htmlBody += `<div class="${grpCls}">\n`;
        textos.forEach(raw => {
          const tRaw = upper ? raw.toUpperCase() : raw;
          const htmlT = escHTML(tRaw).replace(/\r?\n/g, "<br>");
          htmlBody += `  <h2 class="${txtCls}">${htmlT}</h2>\n`;
        });
        htmlBody += `</div>\n`;

        const fw = bold ? "700" : "400";
        const fs = italic ? "italic" : "normal";
        const td = under ? "underline" : "none";

        const justify =
          align === "left" ? "flex-start" :
            align === "right" ? "flex-end" :
              align === "center" ? "center" : "space-between";

        css += `
.inpgs-wrapper .${grpCls}{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:8px !important;
  width:${w}% !important;
  background:${bg} !important;
  margin:0 0 ${mb}px 0 !important;
  padding:0 !important;
  justify-content:${justify} !important;
  align-items:flex-start !important;
  text-align:${align} !important;
}
.inpgs-wrapper .${txtCls}{
  flex:1 1 0 !important;
  min-width:0 !important;
  margin:0 !important;
  padding:0 !important;
  font-family:inherit !important;
  font-size:${sizeEm} !important;
  font-weight:${fw} !important;
  font-style:${fs} !important;
  text-decoration:${td} !important;
  color:${color} !important;
}
`.trim() + "\n\n";
      }

      /* === IM√ÅGENES EN FILA === */
      if (tipo === "imagen") {
        const rawCount = (val(id + "-count") || "").trim();
        let count = parseInt(rawCount || "1", 10);
        if (isNaN(count) || count < 1) count = 1;
        if (count > 10) count = 10;

        const items = [];
        for (let i = 1; i <= count; i++) {
          const sourceSelect = byId(`${id}-img${i}-source`);
          const source = sourceSelect ? sourceSelect.value : 'manual';

          let src = '';

          if (source && source !== 'manual') {
            const excelVal = getExcelValue(source);
            src = (excelVal !== null && excelVal !== undefined) ? String(excelVal) : '';
          } else {
            src = val(`${id}-img${i}`);
          }

          if (!src) continue;

          items.push({
            src,
            alt: val(id + "-alt" + i) || "",
            link: val(id + "-link" + i) || ""
          });
        }

        if (items.length === 0) return;

        const radius = parseInt(val(id + "-radius") || "0", 10) || 0;
        const align = val(id + "-ialign") || "center";

        // Espacio: 1 unidad = 5px
        let mbUnit = parseInt(val(id + "-mb") || "0", 10);
        if (isNaN(mbUnit) || mbUnit < 0) mbUnit = 0;
        const mb = mbUnit * 5;

        const newTab = byId(id + "-newtab")?.checked;

        const rowCls = "inpgs-row-" + modIndex;
        const cellCls = rowCls + "__cell";
        const imgCls = rowCls + "__img";

        htmlBody += `<div class="${rowCls}">\n`;
        items.forEach(it => {
          let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
          if (it.link) {
            const targetAttr = newTab ? ' target="_blank" rel="noopener noreferrer"' : "";
            innerImg = `<a href="${escAttr(it.link)}"${targetAttr}>${innerImg}</a>`;
          }
          htmlBody += `  <div class="${cellCls}">${innerImg}</div>\n`;
        });
        htmlBody += `</div>\n`;

        const justify =
          align === "left" ? "flex-start" :
            align === "right" ? "flex-end" :
              align === "center" ? "center" : "space-between";

        css += `
.inpgs-wrapper .${rowCls}{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:8px !important;
  margin:0 0 ${mb}px 0 !important;
  padding:0 !important;
  align-items:center !important;
  justify-content:${justify} !important;
}
.inpgs-wrapper .${cellCls}{
  flex:1 1 0 !important;
  min-width:0 !important;
  text-align:center !important;
}
.inpgs-wrapper .${imgCls}{
  width:100% !important;
  height:auto !important;
  border-radius:${radius}px !important;
  display:block !important;
}
`.trim() + "\n\n";
      }

      /* === HORIZONTAL: Texto+Imagen === */
      if (tipo === "texto-imagen-h") {
        const leftType = val(id + "-hleft") || "texto";
        const rightType = val(id + "-hright") || "imagen";
        const wLeft = parseInt(val(id + "-wleft") || "50", 10);
        const wRight = parseInt(val(id + "-wright") || "50", 10);
        const bg = val(id + "-hbg") || "#ffffff";

        // Text configuration
        const rawTextCount = (val(id + "-htcount") || "").trim();
        let textCount = parseInt(rawTextCount || "1", 10);
        if (isNaN(textCount) || textCount < 1) textCount = 1;
        if (textCount > 10) textCount = 10;

        const texts = [];
        for (let i = 1; i <= textCount; i++) {
          const t = val(id + "-htxt" + i);
          if (t?.trim()) texts.push(t);
        }

        const textSize = val(id + "-hsize") || "16px";
        let sizeEm;
        if (textSize === "14px") sizeEm = "0.9em";
        else if (textSize === "20px") sizeEm = "1.25em";
        else if (textSize === "28px") sizeEm = "1.6em";
        else sizeEm = "1em";

        const textColor = val(id + "-hcolor") || "#333333";
        const textAlign = val(id + "-halign") || "center";
        const textBold = byId(id + "-hb")?.checked;
        const textItalic = byId(id + "-hi")?.checked;
        const textUnder = byId(id + "-hu")?.checked;
        const textUpper = byId(id + "-hupper")?.checked;

        // Image configuration
        const rawImgCount = (val(id + "-hicount") || "").trim();
        let imgCount = parseInt(rawImgCount || "1", 10);
        if (isNaN(imgCount) || imgCount < 1) imgCount = 1;
        if (imgCount > 10) imgCount = 10;

        const images = [];
        for (let i = 1; i <= imgCount; i++) {
          const src = val(id + "-himg" + i);
          if (!src) continue;
          images.push({
            src,
            alt: val(id + "-halt" + i) || "",
            link: val(id + "-hlink" + i) || ""
          });
        }

        const imgAlign = val(id + "-hialign") || "center";
        const imgRadius = parseInt(val(id + "-hiradius") || "0", 10) || 0;
        const imgNewTab = byId(id + "-hinewtab")?.checked;

        let imgMbUnit = parseInt(val(id + "-himb") || "0", 10);
        if (isNaN(imgMbUnit) || imgMbUnit < 0) imgMbUnit = 0;
        const imgMb = imgMbUnit * 5;

        // Skip if both text and images are empty
        if (texts.length === 0 && images.length === 0) return;

        // Create container class
        const containerCls = "inpgs-hcontainer-" + modIndex;
        const leftCls = containerCls + "__left";
        const rightCls = containerCls + "__right";
        const textCls = containerCls + "__text";
        const imgRowCls = containerCls + "__imgrow";
        const imgCellCls = imgRowCls + "__cell";
        const imgCls = imgRowCls + "__img";

        // Build HTML
        htmlBody += `<div class="${containerCls}">\n`;

        // Left side
        htmlBody += `  <div class="${leftCls}">\n`;
        if (leftType === "texto" && texts.length > 0) {
          texts.forEach(raw => {
            const tRaw = textUpper ? raw.toUpperCase() : raw;
            const htmlT = escHTML(tRaw).replace(/\r?\n/g, "<br>");
            htmlBody += `    <h2 class="${textCls}">${htmlT}</h2>\n`;
          });
        } else if (leftType === "imagen" && images.length > 0) {
          htmlBody += `    <div class="${imgRowCls}">\n`;
          images.forEach(it => {
            let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
            if (it.link) {
              const targetAttr = imgNewTab ? ' target="_blank" rel="noopener noreferrer"' : "";
              innerImg = `<a href="${escAttr(it.link)}"${targetAttr}>${innerImg}</a>`;
            }
            htmlBody += `      <div class="${imgCellCls}">${innerImg}</div>\n`;
          });
          htmlBody += `    </div>\n`;
        }
        htmlBody += `  </div>\n`;

        // Right side
        htmlBody += `  <div class="${rightCls}">\n`;
        if (rightType === "texto" && texts.length > 0) {
          texts.forEach(raw => {
            const tRaw = textUpper ? raw.toUpperCase() : raw;
            const htmlT = escHTML(tRaw).replace(/\r?\n/g, "<br>");
            htmlBody += `    <h2 class="${textCls}">${htmlT}</h2>\n`;
          });
        } else if (rightType === "imagen" && images.length > 0) {
          htmlBody += `    <div class="${imgRowCls}">\n`;
          images.forEach(it => {
            let innerImg = `<img class="${imgCls}" src="${escAttr(it.src)}" alt="${escAttr(it.alt)}">`;
            if (it.link) {
              const targetAttr = imgNewTab ? ' target="_blank" rel="noopener noreferrer"' : "";
              innerImg = `<a href="${escAttr(it.link)}"${targetAttr}>${innerImg}</a>`;
            }
            htmlBody += `      <div class="${imgCellCls}">${innerImg}</div>\n`;
          });
          htmlBody += `    </div>\n`;
        }
        htmlBody += `  </div>\n`;
        htmlBody += `</div>\n`;

        // Build CSS
        const fw = textBold ? "700" : "400";
        const fs = textItalic ? "italic" : "normal";
        const td = textUnder ? "underline" : "none";

        const textJustify =
          textAlign === "left" ? "flex-start" :
            textAlign === "right" ? "flex-end" :
              textAlign === "center" ? "center" : "space-between";

        const imgJustify =
          imgAlign === "left" ? "flex-start" :
            imgAlign === "right" ? "flex-end" :
              imgAlign === "center" ? "center" : "space-between";

        css += `
.inpgs-wrapper .${containerCls}{
  display:flex !important;
  flex-direction:row !important;
  gap:0 !important;
  background:${bg} !important;
  margin:0 !important;
  padding:0 !important;
}
.inpgs-wrapper .${leftCls}{
  width:${wLeft}% !important;
  padding:0 !important;
  display:flex !important;
  flex-direction:column !important;
  justify-content:center !important;
}
.inpgs-wrapper .${rightCls}{
  width:${wRight}% !important;
  padding:0 !important;
  display:flex !important;
  flex-direction:column !important;
  justify-content:center !important;
}
.inpgs-wrapper .${textCls}{
  margin:0 !important;
  padding:0 !important;
  font-family:inherit !important;
  font-size:${sizeEm} !important;
  font-weight:${fw} !important;
  font-style:${fs} !important;
  text-decoration:${td} !important;
  color:${textColor} !important;
  text-align:${textAlign} !important;
}
.inpgs-wrapper .${imgRowCls}{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:8px !important;
  margin:0 0 ${imgMb}px 0 !important;
  padding:0 !important;
  align-items:center !important;
  justify-content:${imgJustify} !important;
}
.inpgs-wrapper .${imgCellCls}{
  flex:1 1 0 !important;
  min-width:0 !important;
  text-align:center !important;
}
.inpgs-wrapper .${imgCls}{
  width:100% !important;
  height:auto !important;
  border-radius:${imgRadius}px !important;
  display:block !important;
}
`.trim() + "\n\n";
      }

      /* === CUSTOM HTML === */
      if (tipo === "html") {
        const customHtml = val(id + "-htmlcode") || "";
        if (customHtml.trim()) {
          htmlBody += customHtml.trim() + "\n";
        }
      }

      /* === EXCEL MERGE PLACEHOLDER === */
      if (tipo === "excel-merge") {
        // Check if we have loaded data for this module
        const data = loadedExcelData[id];
        if (data && data.length > 0) {
          // Find selected ID
          const selectId = byId(id + "-excelid");
          const selectedVal = selectId ? selectId.value : null;

          // Find corresponding HTML
          const item = data.find(x => x.id == selectedVal);
          if (item) {
            htmlBody += item.html || ""; // Inject the old HTML
          } else {
            // Fallback if nothing selected (e.g. first load)
            htmlBody += data[0].html || "";
          }
        } else {
          // No data loaded yet, or we are generating the template for export
          htmlBody += "<!-- [[EXCEL_MERGE_POINT]] -->\n";
        }
      }
    });

    /* ====== WRAPPER GLOBAL Y SCOPE (Lato + FONT_ENFORCER_CSS + GLOBAL_CSS) ====== */
    if (htmlBody.trim() === "") {
      byId("preview").innerHTML = "<div class='muted'>No hay m√≥dulos v√°lidos.</div>";
      byId("htmlOut").value = "";
      byId("cssOut").value = "";
      byId("jsOut").value = "";
      byId("htmlFullOut").value = "";
      return;
    }

    const wrapperStart = `<div class="inpgs-wrapper">`;
    const wrapperEnd = `</div>`;
    const htmlWrapper = wrapperStart + "\n" + htmlBody.trim() + "\n" + wrapperEnd;

    const cssWrapper = `
.inpgs-wrapper{
  font-family:'Lato',sans-serif !important;
  --inpgs-fs: clamp(0.875rem, 3vw, 1.5rem);
  font-size: var(--inpgs-fs) !important;
  line-height: 1.35 !important;
  padding:0px !important;
  color:#000 !important;
}
.inpgs-wrapper *, 
.inpgs-wrapper *::before, 
.inpgs-wrapper *::after{
  box-sizing:border-box !important;
  font-size: inherit !important;
  line-height: inherit !important;
}
.inpgs-wrapper h1,
.inpgs-wrapper h2,
.inpgs-wrapper h3,
.inpgs-wrapper h4,
.inpgs-wrapper h5,
.inpgs-wrapper h6,
.inpgs-wrapper p,
.inpgs-wrapper span,
.inpgs-wrapper a,
.inpgs-wrapper li,
.inpgs-wrapper strong,
.inpgs-wrapper b,
.inpgs-wrapper i,
.inpgs-wrapper u,
.inpgs-wrapper label,
.inpgs-wrapper input,
.inpgs-wrapper textarea,
.inpgs-wrapper select,
.inpgs-wrapper button {
  font-size: inherit !important;
  line-height: inherit !important;
}
.inpgs-wrapper [style*="font-size"]{
  font-size: inherit !important;
}
.amp::before{
  content:"\\0026";
}
`.trim() + "\n\n";

    const finalCSS = cssWrapper + css.trim();

    /* ====== PREVIEW: inyectamos HTML+CSS y fuente Lato ====== */
    const preview = byId("preview");
    preview.innerHTML = htmlWrapper;

    // link de fuente Lato para el preview
    const fontLinkId = "inpgs-font-link-preview";
    let fontLink = document.getElementById(fontLinkId);
    if (!fontLink) {
      fontLink = document.createElement("link");
      fontLink.id = fontLinkId;
      fontLink.rel = "stylesheet";
      fontLink.href = "https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap";
      document.head.appendChild(fontLink);
    }

    const styleId = "inpgs-style-preview";
    let styleEl = document.getElementById(styleId);
    if (styleEl) styleEl.remove();
    styleEl = document.createElement("style");
    styleEl.id = styleId;
    styleEl.textContent = finalCSS;
    document.head.appendChild(styleEl);

    /* ====== EXPORTS separados ====== */
    byId("htmlOut").value = htmlWrapper;
    byId("cssOut").value = finalCSS;
    byId("jsOut").value = js;

    /* ====== SNIPPET FINAL: LINK Lato + style + wrapper + tag hidden ====== */
    let fullHtml =
      '<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&amp;display=swap" rel="stylesheet">\n' +
      "<style>\n" + finalCSS + "\n</style>\n" +
      htmlWrapper;

    if (js.trim()) {
      fullHtml += "\n<script>\n" + js + "\n</scr" + "ipt>\n";
    }

    // Tag de control al final del HTML final
    fullHtml += '\n<span hidden>INPAGE ESPECIALISTA/IA</span>';

    byId("htmlFullOut").value = fullHtml;
  }

  /* ========= helpers ========= */

  function toggleExportPanel() {
    const p = byId("export-panel");
    if (!p) return;
    p.style.display = p.style.display === "none" ? "" : "none";
  }

  function copyHtmlFinal() {
    const ta = byId("htmlFullOut");
    if (!ta) return;
    const text = ta.value || "";
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(() => { });
    } else {
      ta.select();
      ta.setSelectionRange(0, text.length);
      try { document.execCommand("copy"); } catch (e) { }
    }
  }

  function byId(id) { return document.getElementById(id); }
  function val(id) { const el = byId(id); return el ? el.value : ""; }
  function clampPct(v) {
    const n = parseInt(v || "100", 10);
    if (isNaN(n)) return 100;
    return Math.min(100, Math.max(10, n));
  }
  function escHTML(s) {
    return (s || "").replace(/[&<>]/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m]));
  }
  function escAttr(s) {
    return (s || "").replace(/"/g, "&quot;");
  }

  /* ========= color sync ========= */
  function syncHex(colorInput, textId) {
    const txt = document.getElementById(textId);
    if (txt) txt.value = colorInput.value;
  }
  function syncColor(textInput, colorId) {
    const col = document.getElementById(colorId);
    let val = textInput.value;
    if (!val.startsWith("#")) val = "#" + val;
    if (/^#[0-9A-F]{6}$/i.test(val)) {
      if (col) col.value = val;
    }
  }
  /* ========= Drag and Drop ========= */
  let draggedItem = null;
  let placeholder = null;

  function collapseAll() {
    document.querySelectorAll(".mod-body").forEach(b => b.style.display = "none");
  }

  function dragStart(e, id) {
    draggedItem = document.getElementById(id);
    if (!draggedItem) return;

    // Collapse all bodies for cleaner dragging
    collapseAll();

    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/plain", id);
    // Set drag image (optional, browser default is usually fine)

    // Create placeholder
    placeholder = document.createElement("div");
    placeholder.className = "mod-placeholder";
    placeholder.style.height = draggedItem.offsetHeight + "px";

    // Defer hiding the dragged element so the drag ghost is created from the visible element
    setTimeout(() => {
      draggedItem.style.display = "none";
      // Insert placeholder where the dragged item was
      draggedItem.parentNode.insertBefore(placeholder, draggedItem.nextSibling);
    }, 0);
  }

  function dragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";

    const target = e.target.closest(".mod-box");
    const container = document.getElementById("mods");
    if (!container || !placeholder) return;

    if (target && target !== draggedItem) {
      const rect = target.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;

      if (e.clientY < midY) {
        container.insertBefore(placeholder, target);
      } else {
        container.insertBefore(placeholder, target.nextSibling);
      }
    } else if (!target && e.target === container) {
      // If hovering over empty space in container, append to end
      container.appendChild(placeholder);
    }
  }

  function dragEnter(e) {
    e.preventDefault();
  }

  function dragLeave(e) {
    // Optional: handle leaving the container
  }

  function drop(e, targetId) {
    e.preventDefault();
    if (!draggedItem || !placeholder) return;

    // Move dragged item to placeholder position
    if (placeholder.parentNode) {
      placeholder.parentNode.insertBefore(draggedItem, placeholder);
    }

    updatePositions();
  }

  function dragEnd(e) {
    if (draggedItem) {
      draggedItem.style.display = ""; // Show it again
      draggedItem = null;
    }
    if (placeholder && placeholder.parentNode) {
      placeholder.remove();
    }
    placeholder = null;
  }

  /* ========= EXCEL PROCESSING ========= */

  let loadedExcelData = {}; // Store data by module ID: { modId: [ {id, html}, ... ] }

  function loadExcelData(id) {
    const fileInput = byId(id + "-excelfile");
    const statusDiv = byId(id + "-excelstatus");
    const controlsDiv = byId(id + "-preview-controls");
    const selectId = byId(id + "-excelid");

    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
      return;
    }

    const file = fileInput.files[0];
    if (statusDiv) statusDiv.innerHTML = "Leyendo archivo...";

    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (!jsonData || jsonData.length === 0) {
          if (statusDiv) statusDiv.innerHTML = "<span style='color:red'>El archivo parece estar vac√≠o.</span>";
          return;
        }

        // Normalize data
        const normalizedData = jsonData.map(row => {
          const keys = Object.keys(row);
          let idVal = "";
          let htmlVal = "";
          keys.forEach(k => {
            if (k.toLowerCase() === "id") idVal = row[k];
            if (k.toLowerCase() === "html") htmlVal = row[k];
          });
          return { id: idVal, html: htmlVal };
        });

        loadedExcelData[id] = normalizedData;

        // Populate dropdown
        selectId.innerHTML = "";
        normalizedData.forEach(item => {
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = item.id;
          selectId.appendChild(opt);
        });

        if (controlsDiv) controlsDiv.style.display = "block";
        if (statusDiv) statusDiv.innerHTML = "<span style='color:green'>Archivo cargado. Selecciona un ID para previsualizar.</span>";

        // Trigger render to show first item
        renderAll();

      } catch (err) {
        console.error(err);
        if (statusDiv) statusDiv.innerHTML = "<span style='color:red'>Error al leer: " + err.message + "</span>";
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function processExcel(id) {
    const statusDiv = byId(id + "-excelstatus");
    const data = loadedExcelData[id];

    if (!data || data.length === 0) {
      if (statusDiv) statusDiv.innerHTML = "<span style='color:red'>Primero debes cargar un archivo Excel v√°lido.</span>";
      return;
    }

    // Generate template by temporarily hiding the specific ID selection
    // This forces renderAll to output the placeholder
    const savedData = loadedExcelData[id];
    loadedExcelData[id] = null;

    // We also need to ensure renderAll doesn't crash or produce empty output if it relies on loadedExcelData
    // The modified renderAll below handles 'excel-merge' by checking if data exists.
    // If loadedExcelData[id] is null, it should output the placeholder.

    renderAll();
    const template = byId("htmlFullOut").value;

    // Restore data and view
    loadedExcelData[id] = savedData;
    renderAll();

    if (!template.includes("<!-- [[EXCEL_MERGE_POINT]] -->")) {
      if (statusDiv) statusDiv.innerHTML = "<span style='color:red'>Error: No se encontr√≥ el punto de inserci√≥n. Aseg√∫rate de tener un m√≥dulo 'Carga Excel' activo.</span>";
      return;
    }

    if (statusDiv) statusDiv.innerHTML = "Procesando " + data.length + " filas...";

    try {
      const outputData = [];

      data.forEach(row => {
        const newHtml = template.replace("<!-- [[EXCEL_MERGE_POINT]] -->", row.html || "");
        outputData.push({
          id: row.id,
          html_original: row.html,
          html_nuevo: newHtml
        });
      });

      const newWs = XLSX.utils.json_to_sheet(outputData);
      const newWb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(newWb, newWs, "Resultados");

      XLSX.writeFile(newWb, "inpages_generados.xlsx");

      if (statusDiv) statusDiv.innerHTML = "<span style='color:green'>¬°Listo! Archivo descargado.</span>";
    } catch (err) {
      console.error(err);
      if (statusDiv) statusDiv.innerHTML = "<span style='color:red'>Error al procesar: " + err.message + "</span>";
    }
  }
</script>